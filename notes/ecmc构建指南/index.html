<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>ecmc构建指南 | ✨kiraの博客</title>
<meta name=keywords content="EPICS,EtherCAT"><meta name=description content="软件包

epics-base/epics-base: The C/C++ core of the EPICS Base control system toolkit
epics-modules/ecmc: EPICS Support for EtherCAT Motion Controller (ECMC) and Generic IO Controller
paulscherrerinstitute/exprtk-ecmc: ESS Customized exprtk : C++ Mathematical Expression Parsing And Evaluation Library
paulscherrerinstitute/ecmccfg: Module to handle configuration scripts for EtherCATMotion Controller (ECMC)
epics-modules/asyn: EPICS module for driver and device support
EuropeanSpallationSource/motor: APS BCDA synApps module: motor
pantor/ruckig: Motion Generation for Robots and Machines. 
EtherLab / EtherCAT Master · GitLab

构建顺序

epics-base
asyn
motor
etherlab
ruckig
ecmc

epics-base
正常交叉编译。"><meta name=author content><link rel=canonical href=https://kira-96.github.io/notes/ecmc%E6%9E%84%E5%BB%BA%E6%8C%87%E5%8D%97/><link crossorigin=anonymous href=/assets/css/stylesheet.b22781f954266b0a3dbf09bc9f573c9d336248308fdc4c9f278d68ec829a68f3.css integrity="sha256-sieB+VQmawo9vwm8n1c8nTNiSDCP3EyfJ41o7IKaaPM=" rel="preload stylesheet" as=style><link rel=icon href=https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/favicon-32x32.png><link rel=apple-touch-icon href=https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/icons/apple-icon-180x180.png><link rel=mask-icon href=https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/icons/apple-icon-76x76.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://kira-96.github.io/notes/ecmc%E6%9E%84%E5%BB%BA%E6%8C%87%E5%8D%97/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=manifest href=https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/manifest.json><link rel=stylesheet href=https://cdn.bootcdn.net/ajax/libs/lxgw-wenkai-screen-webfont/1.7.0/style.min.css><script src=https://fastly.jsdelivr.net/npm/live2d-widgets@0/autoload.js></script><script type=text/javascript src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><meta property="og:url" content="https://kira-96.github.io/notes/ecmc%E6%9E%84%E5%BB%BA%E6%8C%87%E5%8D%97/"><meta property="og:site_name" content="✨kiraの博客"><meta property="og:title" content="ecmc构建指南"><meta property="og:description" content="软件包 epics-base/epics-base: The C/C++ core of the EPICS Base control system toolkit epics-modules/ecmc: EPICS Support for EtherCAT Motion Controller (ECMC) and Generic IO Controller paulscherrerinstitute/exprtk-ecmc: ESS Customized exprtk : C++ Mathematical Expression Parsing And Evaluation Library paulscherrerinstitute/ecmccfg: Module to handle configuration scripts for EtherCATMotion Controller (ECMC) epics-modules/asyn: EPICS module for driver and device support EuropeanSpallationSource/motor: APS BCDA synApps module: motor pantor/ruckig: Motion Generation for Robots and Machines. EtherLab / EtherCAT Master · GitLab 构建顺序 epics-base asyn motor etherlab ruckig ecmc epics-base 正常交叉编译。"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="notes"><meta property="article:published_time" content="2024-11-26T08:56:34+08:00"><meta property="article:modified_time" content="2024-11-26T08:56:34+08:00"><meta property="article:tag" content="EPICS"><meta property="article:tag" content="EtherCAT"><meta name=twitter:card content="summary"><meta name=twitter:title content="ecmc构建指南"><meta name=twitter:description content="软件包

epics-base/epics-base: The C/C++ core of the EPICS Base control system toolkit
epics-modules/ecmc: EPICS Support for EtherCAT Motion Controller (ECMC) and Generic IO Controller
paulscherrerinstitute/exprtk-ecmc: ESS Customized exprtk : C++ Mathematical Expression Parsing And Evaluation Library
paulscherrerinstitute/ecmccfg: Module to handle configuration scripts for EtherCATMotion Controller (ECMC)
epics-modules/asyn: EPICS module for driver and device support
EuropeanSpallationSource/motor: APS BCDA synApps module: motor
pantor/ruckig: Motion Generation for Robots and Machines. 
EtherLab / EtherCAT Master · GitLab

构建顺序

epics-base
asyn
motor
etherlab
ruckig
ecmc

epics-base
正常交叉编译。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Notes","item":"https://kira-96.github.io/notes/"},{"@type":"ListItem","position":2,"name":"ecmc构建指南","item":"https://kira-96.github.io/notes/ecmc%E6%9E%84%E5%BB%BA%E6%8C%87%E5%8D%97/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"ecmc构建指南","name":"ecmc构建指南","description":"软件包 epics-base/epics-base: The C/C++ core of the EPICS Base control system toolkit epics-modules/ecmc: EPICS Support for EtherCAT Motion Controller (ECMC) and Generic IO Controller paulscherrerinstitute/exprtk-ecmc: ESS Customized exprtk : C++ Mathematical Expression Parsing And Evaluation Library paulscherrerinstitute/ecmccfg: Module to handle configuration scripts for EtherCATMotion Controller (ECMC) epics-modules/asyn: EPICS module for driver and device support EuropeanSpallationSource/motor: APS BCDA synApps module: motor pantor/ruckig: Motion Generation for Robots and Machines. EtherLab / EtherCAT Master · GitLab 构建顺序 epics-base asyn motor etherlab ruckig ecmc epics-base 正常交叉编译。\n","keywords":["EPICS","EtherCAT"],"articleBody":"软件包 epics-base/epics-base: The C/C++ core of the EPICS Base control system toolkit epics-modules/ecmc: EPICS Support for EtherCAT Motion Controller (ECMC) and Generic IO Controller paulscherrerinstitute/exprtk-ecmc: ESS Customized exprtk : C++ Mathematical Expression Parsing And Evaluation Library paulscherrerinstitute/ecmccfg: Module to handle configuration scripts for EtherCATMotion Controller (ECMC) epics-modules/asyn: EPICS module for driver and device support EuropeanSpallationSource/motor: APS BCDA synApps module: motor pantor/ruckig: Motion Generation for Robots and Machines. EtherLab / EtherCAT Master · GitLab 构建顺序 epics-base asyn motor etherlab ruckig ecmc epics-base 正常交叉编译。\nasyn 正常交叉编译。\nmotor 配置如下：\nconfigure/CONFIG_SITE.local ▼ 1 2 # Uncomment the following line to build iocs in motor/modules/motorVendor/iocs BUILD_IOCS = YES configure/RELEASE.local ▼ 1 2 3 EPICS_BASE=/path/to/epics/base-7.0.8.1 SUPPORT=$(EPICS_BASE)/../epics-modules ASYN=$(SUPPORT)/asyn etherlab 需要内核源码头文件才能编译，和EPICS不相关。\nruckig 编译 机器人运动控制库。\n配置交叉编译工具链\ntoolchain.cmake ▼ 1 2 set(CMAKE_C_COMPILER \"loongarch64-linux-gnu-gcc\") set(CMAKE_CXX_COMPILER \"loongarch64-linux-gnu-g++\") 编译步骤\nshell ▼ 1 2 3 4 5 6 # 新建编译目录 mkdir build cd build # 交叉编译 cmake -DCMAKE_TOOLCHAIN_FILE=toolchain.cmake -DCMAKE_BUILD_TYPE=Release .. make ecmc 把下载的exprtk解压到exprtkSupport目录下（也可以用git pull下来）。\n配置如下：\nconfigure/RELEASE.local ▼ 1 2 3 4 5 6 EPICS_BASE=/path/to/epics/base-7.0.8.1 SUPPORT=$(EPICS_BASE)/../epics-modules ASYN=$(SUPPORT)/asyn MOTOR=$(SUPPORT)/motor # 指定交叉编译架构 EPICS_HOST_ARCH=linux-loong64 修改devEcmcSup/Makefile\ndevEcmcSup/Makefile ▼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 #************************************************************************ # Copyright (c) 2019 European Spallation Source ERIC # ecmc is distributed subject to a Software License Agreement found # in file LICENSE that is included with this distribution. # # Author: Jeong Han Lee # #************************************************************************* TOP=.. include $(TOP)/configure/CONFIG #---------------------------------------- # ADD MACRO DEFINITIONS AFTER THIS LINE #============================= ECMC = $(TOP)/devEcmcSup LIBRARY_IOC += ecmc # Ubuntu needs the following ldflags USR_LDFLAGS += -Wl,--no-as-needed USR_LDFLAGS += -lstdc++ ifeq ($(T_A),linux-x86_64) # Assume that the etherlab user library is done via # https://github.com/icshwi/etherlabmaster USR_INCLUDES += -I/opt/etherlab/include USR_CFLAGS += -fPIC USR_LDFLAGS += -L /opt/etherlab/lib USR_LDFLAGS += -lethercat USR_LDFLAGS += -Wl,-rpath=/opt/etherlab/lib else # Assume that the etherlab user library is done via # Yocto ESS Linux bb recipe + # 这里注意etherlab的路径 USR_INCLUDES += -I$(SDKTARGETSYSROOT)/usr/include/etherlab USR_CFLAGS += -fPIC USR_LDFLAGS += -L $(SDKTARGETSYSROOT)/usr/lib/etherlab USR_LDFLAGS += -lethercat USR_LDFLAGS += -Wl,-rpath=$(SDKTARGETSYSROOT)/usr/lib/etherlab endif + # ruckig路径 + USR_INCLUDES += -I/path/to/ruckig/include + USR_LDFLAGS += -L /path/to/ruckig/build + USR_LDFLAGS += -lruckig SRC_DIRS += $(ECMC)/plc ecmc_SRCS += ecmcPLC.cpp ecmc_SRCS += ecmcPLCTask.cpp ecmc_SRCS += ecmcPLCDataIF.cpp ecmc_SRCS += ecmcPLCMain.cpp + ecmc_SRCS += ecmcPLCLib.cpp + ecmc_SRCS += ecmcPLCLibFunc.cpp SRC_DIRS += $(ECMC)/misc ecmc_SRCS += ecmcMisc.cpp ecmc_SRCS += ecmcEvent.cpp ecmc_SRCS += ecmcEventConsumer.cpp ecmc_SRCS += ecmcDataRecorder.cpp ecmc_SRCS += ecmcDataStorage.cpp ecmc_SRCS += ecmcCommandList.cpp SRC_DIRS += $(ECMC)/main ecmc_SRCS += ecmcGeneral.cpp ecmc_SRCS += ecmcError.cpp ecmc_SRCS += ecmcMainThread.cpp ecmc_SRCS += gitversion.c SRC_DIRS += $(ECMC)/ethercat ecmc_SRCS += ecmcEthercat.cpp ecmc_SRCS += ecmcEc.cpp + ecmc_SRCS += ecmcEcData.cpp + ecmc_SRCS += ecmcEcDomain.cpp ecmc_SRCS += ecmcEcEntry.cpp ecmc_SRCS += ecmcEcPdo.cpp ecmc_SRCS += ecmcEcSDO.cpp ecmc_SRCS += ecmcEcSlave.cpp ecmc_SRCS += ecmcEcSyncManager.cpp ecmc_SRCS += ecmcEcEntryLink.cpp + ecmc_SRCS += ecmcEcAsyncSDO.cpp ecmc_SRCS += ecmcAsynLink.cpp ecmc_SRCS += ecmcEcMemMap.cpp SRC_DIRS += $(ECMC)/com DBD += ecmcController.dbd + ecmc_SRCS += ecmcDataItem.cpp ecmc_SRCS += ecmcCom.cpp ecmc_SRCS += ecmcOctetIF.c ecmc_SRCS += ecmcCmdParser.c ecmc_SRCS += ecmcAsynPortDriver.cpp ecmc_SRCS += ecmcAsynPortDriverUtils.cpp ecmc_SRCS += ecmcAsynDataItem.cpp SRC_DIRS += $(ECMC)/motion ecmc_SRCS += ecmcMotion.cpp ecmc_SRCS += ecmcAxisBase.cpp + ecmc_SRCS += ecmcAxisGroup.cpp ecmc_SRCS += ecmcAxisReal.cpp ecmc_SRCS += ecmcAxisVirt.cpp ecmc_SRCS += ecmcDriveBase.cpp ecmc_SRCS += ecmcDriveStepper.cpp ecmc_SRCS += ecmcDriveDS402.cpp ecmc_SRCS += ecmcEncoder.cpp ecmc_SRCS += ecmcFilter.cpp ecmc_SRCS += ecmcMonitor.cpp + ecmc_SRCS += ecmcMotionUtils.cpp ecmc_SRCS += ecmcPIDController.cpp + ecmc_SRCS += ecmcPVTController.cpp ecmc_SRCS += ecmcAxisSequencer.cpp + ecmc_SRCS += ecmcAxisPVTSequence.cpp + ecmc_SRCS += ecmcTrajectoryBase.cpp + ecmc_SRCS += ecmcTrajectoryS.cpp ecmc_SRCS += ecmcTrajectoryTrapetz.cpp ecmc_SRCS += ecmcAxisData.cpp SRC_DIRS += $(ECMC)/motor DBD += ecmcMotorRecordSupport.dbd ecmc_SRCS += ecmcMotorRecordController.cpp ecmc_SRCS += ecmcMotorRecordAxis.cpp + SRC_DIRS += $(ECMC)/plugin + ecmc_SRCS += ecmcPluginLib.cpp + ecmc_SRCS += ecmcPlugin.cpp + ecmc_SRCS += ecmcPluginClient.cpp ecmc_LIBS += exprtkSupport ecmc_LIBS += $(EPICS_BASE_IOC_LIBS) include $(TOP)/configure/RULES #---------------------------------------- # ADD RULES AFTER THIS LINE gitversion.c: @$(RM) $@ @sh $(TOP)/tools/gitversion.sh $@ 修改devEcmcSup/motion/ecmcTrajectoryS.h\ndevEcmcSup/motion/ecmcTrajectoryS.h ▼ 1 2 3 #include \"ecmcecmcTrajectoryBase.h\" - #include + #include 修改ecmcExampleTop/configure/RELEASE.local\necmcExampleTop/configure/RELEASE.local ▼ 1 2 3 4 5 6 7 8 EPICS_BASE=/home/ubuntu/epics/base-7.0.8.1 SUPPORT=$(EPICS_BASE)/../epics-modules ASYN=$(SUPPORT)/asyn MOTOR=$(SUPPORT)/motor # 添加QSRV2支持 PVXS=$(SUPPORT)/pvxs # 指定交叉编译架构 EPICS_HOST_ARCH=linux-loong64 修改ecmcExampleTop/ecmcIocApp/src/Makefile\ndiff ▼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 TOP=../.. include $(TOP)/configure/CONFIG #---------------------------------------- # ADD MACRO DEFINITIONS AFTER THIS LINE #============================= #============================= # Build the IOC application PROD_IOC = ecmcIoc # Ubuntu needs the following ldflags USR_LDFLAGS_Linux += -Wl,--no-as-needed + ifeq ($(T_A),linux-x86_64) + # Assume that the etherlab user library is done via + # https://github.com/icshwi/etherlabmaster + USR_INCLUDES += -I/opt/etherlab/include + USR_CFLAGS += -fPIC + USR_LDFLAGS += -L /opt/etherlab/lib + USR_LDFLAGS += -lethercat + USR_LDFLAGS += -Wl,-rpath=/opt/etherlab/lib + else + # Assume that the etherlab user library is done via + # Yocto ESS Linux bb recipe + # 这里注意etherlab的路径 + USR_INCLUDES += -I$(SDKTARGETSYSROOT)/usr/include/etherlab + USR_CFLAGS += -fPIC + USR_LDFLAGS += -L $(SDKTARGETSYSROOT)/usr/lib/etherlab + USR_LDFLAGS += -lethercat + USR_LDFLAGS += -Wl,-rpath=$(SDKTARGETSYSROOT)/usr/lib/etherlab + endif + # ruckig路径 + USR_INCLUDES += -I/path/to/ruckig/include + USR_LDFLAGS += -L /path/to/ruckig/build + USR_LDFLAGS += -lruckig # ecmcioc.dbd will be created and installed DBD += ecmcIoc.dbd # opcuaIoc.dbd will be made up from these files: ecmcIoc_DBD += base.dbd ecmcIoc_DBD += ecmcController.dbd # Add all the support libraries needed by this IOC ecmcIoc_LIBS += asyn ecmcIoc_LIBS += ecmc + ecmcIoc_LIBS += motor ecmcIoc_LIBS += exprtkSupport + ecmcIoc_DBD += asyn.dbd + ecmcIoc_DBD += motorSupport.dbd ecmcIoc_SRCS += ecmcIoc_registerRecordDeviceDriver.cpp # Build the main IOC entry point on workstation OSs. ecmcIoc_SRCS_DEFAULT += ecmcIocMain.cpp ecmcIoc_SRCS_vxWorks += -nil- + # Link PVXS if available + ifdef PVXS_MAJOR_VERSION + ecmcIoc_LIBS += pvxsIoc pvxs + ecmcIoc_DBD += pvxsIoc.dbd + else + # Link QSRV (pvAccess Server) if available + ifdef EPICS_QSRV_MAJOR_VERSION + ecmcIoc_LIBS += qsrv + ecmcIoc_LIBS += $(EPICS_BASE_PVA_CORE_LIBS) + ecmcIoc_DBD += PVAServerRegister.dbd + ecmcIoc_DBD += qsrv.dbd + endif + endif # Finally link to the EPICS Base libraries ecmcIoc_LIBS += $(EPICS_BASE_IOC_LIBS) #=========================== include $(TOP)/configure/RULES #---------------------------------------- # ADD RULES AFTER THIS LINE 编译的时候需要指定使用c++17的标准，不然有一些语法不支持，应该是ruckig库比较新。\n添加CPPFLAGS=-std=c++17\nshell ▼ 1 2 3 4 5 # 执行交叉编译 make CPPFLAGS=-std=c++17 \\ LD=loongarch64-linux-gnu-ld \\ CC=loongarch64-linux-gnu-gcc \\ CCC=loongarch64-linux-gnu-g++ -j4 使用方法 主要使用ecmccfg软件包提供的预编写脚本进行EtherCAT主站、从站配置。\n修改IOC环境变量配置iocBoot/iocExample/envPaths：\nenvPaths ▼ 1 2 3 4 5 epicsEnvSet(\"IOC\", \"iocExample\") epicsEnvSet(\"TOP\", \"../..\") epicsEnvSet(\"SUPPORT\", \"/root/epics-modules\") epicsEnvSet(\"ASYN\", \"${SUPPORT}/asyn\") epicsEnvSet(\"ECMC\", \"${SUPPORT}/ecmc\") 修改启动脚本iocBoot/iocExample/st.cmd：\nst.cmd ▼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 #!../../bin/linux-loong64/ecmcIoc \u003c envPaths cd \"${TOP}\" ## Register all support components dbLoadDatabase \"dbd/ecmcIoc.dbd\" ecmcIoc_registerRecordDeviceDriver pdbbase ## Load record instances #dbLoadRecords(\"db/xxx.db\",\"user=${USER}\") # ecmccfg路径配置 epicsEnvSet \"ecmccfg_DIR\", \"${ECMC}/scripts/\" epicsEnvSet \"ecmccfg_DB\", \"${ECMC}/db/\" epicsEnvSet \"ECMC_CONFIG_ROOT\", \"${ecmccfg_DIR}\" epicsEnvSet \"ECMC_CONFIG_DB\", \"${ecmccfg_DB}\" epicsEnvSet \"SCRIPTEXEC\", \"iocshLoad\" #- 初始化 ${SCRIPTEXEC} \"${ECMC_CONFIG_ROOT}initAll.cmd\", \"SM_MOTOR_PORT=MCU1,SM_ASYN_PORT=MC_CPU1,SM_PREFIX=${IOC}:\" # EtherCAT主站号 epicsEnvSet \"MASTER_ID\", 0 # 扫描频率，默认 1000 epicsEnvSet \"EC_RATE\", 100 #- #------------------------------------------------------------------------------- # Set EtherCAT frequency (defaults to 1000) ecmcConfigOrDie \"Cfg.SetSampleRate(${EC_RATE=1000})\" #- #- Set current EtherCAT sample rate #- Note: Not the same as ECMC_SAMPLE_RATE_MS which is for record update epicsEnvSet \"ECMC_EC_SAMPLE_RATE\", ${EC_RATE=1000} ecmcEpicsEnvSetCalc(\"ECMC_EC_SAMPLE_RATE_MS\", 1000/${ECMC_EC_SAMPLE_RATE=1000}) # Update records in 10ms (100Hz) for FULL MODE and in EC_RATE for DAQ mode ecmcEpicsEnvSetCalcTernary(ECMC_SAMPLE_RATE_MS, \"'${ECMC_MODE=FULL}'=='DAQ'\",\"${ECMC_EC_SAMPLE_RATE_MS}\",\"10\") epicsEnvSet(ECMC_SAMPLE_RATE_MS_ORIGINAL, ${ECMC_SAMPLE_RATE_MS}) #- define naming convention script #epicsEnvSet \"ECMC_P_SCRIPT\", \"${NAMING=mXsXXX}\" #- Set master ${SCRIPTEXEC} \"${ECMC_CONFIG_ROOT}addMaster.cmd\", \"MASTER_ID=${MASTER_ID=0}\" epicsEnvSet \"ECMC_EC_MASTER_ID\", ${MASTER_ID=0} #- Add slaves ${SCRIPTEXEC} \"${ECMC_CONFIG_ROOT}addSlave.cmd\", \"SLAVE_ID=0, HW_DESC=EK1100\" ${SCRIPTEXEC} \"${ECMC_CONFIG_ROOT}addSlave.cmd\", \"SLAVE_ID=1, HW_DESC=EL4024\" ${SCRIPTEXEC} \"${ECMC_CONFIG_ROOT}addSlave.cmd\", \"SLAVE_ID=2, HW_DESC=EL2624\" ${SCRIPTEXEC} \"${ECMC_CONFIG_ROOT}addSlave.cmd\", \"SLAVE_ID=3, HW_DESC=EL3742\" ${SCRIPTEXEC} \"${ECMC_CONFIG_ROOT}addSlave.cmd\", \"SLAVE_ID=4, HW_DESC=EK1110\" #- Apply hardware configuration ${SCRIPTEXEC} \"${ECMC_CONFIG_ROOT}applyConfig.cmd\" #- Activate ${SCRIPTEXEC} \"${ECMC_CONFIG_ROOT}setAppMode.cmd\" cd \"${TOP}/iocBoot/${IOC}\" iocInit ## Start any sequence programs #seq sncxxx,\"user=${USER}\" ecmcXXxxxx.cmd：从站配置脚本 ecmcXXxxxx.substitutions：记录(records) 参考链接\nESS EPICS Environment (e3) — ESS EPICS Environment (e3) documentation ecmccfg 手册 ","wordCount":"1399","inLanguage":"zh","datePublished":"2024-11-26T08:56:34+08:00","dateModified":"2024-11-26T08:56:34+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://kira-96.github.io/notes/ecmc%E6%9E%84%E5%BB%BA%E6%8C%87%E5%8D%97/"},"publisher":{"@type":"Organization","name":"✨kiraの博客","logo":{"@type":"ImageObject","url":"https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://kira-96.github.io/ accesskey=h title="✨kiraの博客 (Alt + H)">✨kiraの博客</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://kira-96.github.io/ title=🏠主页><span>🏠主页</span></a></li><li><a href=https://kira-96.github.io/notes/ title=📓笔记><span>📓笔记</span></a></li><li><a href=https://kira-96.github.io/search/ title=🔍️搜索><span>🔍️搜索</span></a></li><li><a href=https://kira-96.github.io/archives/ title=🗃️存档><span>🗃️存档</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://kira-96.github.io/>主页</a>&nbsp;»&nbsp;<a href=https://kira-96.github.io/notes/>Notes</a></div><h1 class="post-title entry-hint-parent">ecmc构建指南
<span class=entry-hint title=Draft><svg height="35" viewBox="0 -960 960 960" fill="currentcolor"><path d="M160-410v-60h3e2v60H160zm0-165v-60h470v60H160zm0-165v-60h470v60H160zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22-4.5 22.5T862.09-380L643-160H520zm3e2-263-37-37 37 37zM580-220h38l121-122-18-19-19-18-122 121v38zm141-141-19-18 37 37-18-19z"/></svg></span></h1><div class=post-meta><span title='2024-11-26 08:56:34 +0800 +0800'>十一月 26, 2024</span>&nbsp;·&nbsp;7 分钟&nbsp;·&nbsp;1399 字&nbsp;|&nbsp;<a href=https://github.com/kira-96/kira-96.github.io/tree/main/content/posts/ rel="noopener noreferrer" target=_blank>✏️编辑</a></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e8%bd%af%e4%bb%b6%e5%8c%85 aria-label=软件包>软件包</a></li><li><a href=#%e6%9e%84%e5%bb%ba%e9%a1%ba%e5%ba%8f aria-label=构建顺序>构建顺序</a><ul><li><a href=#epics-base aria-label=epics-base>epics-base</a></li><li><a href=#asyn aria-label=asyn>asyn</a></li><li><a href=#motor aria-label=motor>motor</a></li><li><a href=#etherlab aria-label=etherlab>etherlab</a></li><li><a href=#ruckig-%e7%bc%96%e8%af%91 aria-label="ruckig 编译">ruckig 编译</a></li><li><a href=#ecmc aria-label=ecmc>ecmc</a></li></ul></li><li><a href=#%e4%bd%bf%e7%94%a8%e6%96%b9%e6%b3%95 aria-label=使用方法>使用方法</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=软件包>软件包<a hidden class=anchor aria-hidden=true href=#软件包>#</a></h2><ul><li><a href=https://github.com/epics-base/epics-base>epics-base/epics-base: The C/C++ core of the EPICS Base control system toolkit</a></li><li><a href=https://github.com/epics-modules/ecmc>epics-modules/ecmc: EPICS Support for EtherCAT Motion Controller (ECMC) and Generic IO Controller</a></li><li><a href=https://github.com/paulscherrerinstitute/exprtk-ecmc>paulscherrerinstitute/exprtk-ecmc: ESS Customized exprtk : C++ Mathematical Expression Parsing And Evaluation Library</a></li><li><a href=https://github.com/paulscherrerinstitute/ecmccfg>paulscherrerinstitute/ecmccfg: Module to handle configuration scripts for EtherCATMotion Controller (ECMC)</a></li><li><a href=https://github.com/epics-modules/asyn>epics-modules/asyn: EPICS module for driver and device support</a></li><li><a href=https://github.com/EuropeanSpallationSource/motor>EuropeanSpallationSource/motor: APS BCDA synApps module: motor</a></li><li><a href=https://github.com/pantor/ruckig>pantor/ruckig: Motion Generation for Robots and Machines.</a></li><li><a href=https://gitlab.com/etherlab.org/ethercat>EtherLab / EtherCAT Master · GitLab</a></li></ul><h2 id=构建顺序>构建顺序<a hidden class=anchor aria-hidden=true href=#构建顺序>#</a></h2><ol><li>epics-base</li><li>asyn</li><li>motor</li><li>etherlab</li><li>ruckig</li><li>ecmc</li></ol><h3 id=epics-base>epics-base<a hidden class=anchor aria-hidden=true href=#epics-base>#</a></h3><p>正常交叉编译。</p><h3 id=asyn>asyn<a hidden class=anchor aria-hidden=true href=#asyn>#</a></h3><p>正常交叉编译。</p><h3 id=motor>motor<a hidden class=anchor aria-hidden=true href=#motor>#</a></h3><p>配置如下：</p><div class=mac-codeblock><div class=mac-titlebar><div class=mac-left-group><span class=mac-close></span>
<span class=mac-minimize></span>
<span class=mac-expand></span></div><div class=mac-title title=configure/CONFIG_SITE.local>configure/CONFIG_SITE.local</div><div class=mac-right-group><button class=fold-button>&#9660;</button></div></div><div class=mac-content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># Uncomment the following line to build iocs in motor/modules/motorVendor/iocs</span>
</span></span><span class=line><span class=cl><span class=nv>BUILD_IOCS</span> <span class=o>=</span> YES</span></span></code></pre></td></tr></table></div></div></div></div><div class=mac-codeblock><div class=mac-titlebar><div class=mac-left-group><span class=mac-close></span>
<span class=mac-minimize></span>
<span class=mac-expand></span></div><div class=mac-title title=configure/RELEASE.local>configure/RELEASE.local</div><div class=mac-right-group><button class=fold-button>&#9660;</button></div></div><div class=mac-content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nv>EPICS_BASE</span><span class=o>=</span>/path/to/epics/base-7.0.8.1
</span></span><span class=line><span class=cl><span class=nv>SUPPORT</span><span class=o>=</span><span class=k>$(</span>EPICS_BASE<span class=k>)</span>/../epics-modules
</span></span><span class=line><span class=cl><span class=nv>ASYN</span><span class=o>=</span><span class=k>$(</span>SUPPORT<span class=k>)</span>/asyn</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=etherlab>etherlab<a hidden class=anchor aria-hidden=true href=#etherlab>#</a></h3><p>需要内核源码头文件才能编译，和EPICS不相关。</p><h3 id=ruckig-编译>ruckig 编译<a hidden class=anchor aria-hidden=true href=#ruckig-编译>#</a></h3><p>机器人运动控制库。</p><p>配置交叉编译工具链</p><div class=mac-codeblock><div class=mac-titlebar><div class=mac-left-group><span class=mac-close></span>
<span class=mac-minimize></span>
<span class=mac-expand></span></div><div class=mac-title title=toolchain.cmake>toolchain.cmake</div><div class=mac-right-group><button class=fold-button>&#9660;</button></div></div><div class=mac-content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cmake data-lang=cmake><span class=line><span class=cl><span class=nb>set</span><span class=p>(</span><span class=s>CMAKE_C_COMPILER</span> <span class=s2>&#34;loongarch64-linux-gnu-gcc&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>set</span><span class=p>(</span><span class=s>CMAKE_CXX_COMPILER</span> <span class=s2>&#34;loongarch64-linux-gnu-g++&#34;</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></div><p>编译步骤</p><div class=mac-codeblock><div class=mac-titlebar><div class=mac-left-group><span class=mac-close></span>
<span class=mac-minimize></span>
<span class=mac-expand></span></div><div class=mac-title title=shell>shell</div><div class=mac-right-group><button class=fold-button>&#9660;</button></div></div><div class=mac-content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 新建编译目录</span>
</span></span><span class=line><span class=cl>mkdir build
</span></span><span class=line><span class=cl><span class=nb>cd</span> build
</span></span><span class=line><span class=cl><span class=c1># 交叉编译</span>
</span></span><span class=line><span class=cl>cmake -DCMAKE_TOOLCHAIN_FILE<span class=o>=</span>toolchain.cmake -DCMAKE_BUILD_TYPE<span class=o>=</span>Release ..
</span></span><span class=line><span class=cl>make</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=ecmc>ecmc<a hidden class=anchor aria-hidden=true href=#ecmc>#</a></h3><p>把下载的<code>exprtk</code>解压到<code>exprtkSupport</code>目录下（也可以用<code>git</code> pull下来）。</p><p>配置如下：</p><div class=mac-codeblock><div class=mac-titlebar><div class=mac-left-group><span class=mac-close></span>
<span class=mac-minimize></span>
<span class=mac-expand></span></div><div class=mac-title title=configure/RELEASE.local>configure/RELEASE.local</div><div class=mac-right-group><button class=fold-button>&#9660;</button></div></div><div class=mac-content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nv>EPICS_BASE</span><span class=o>=</span>/path/to/epics/base-7.0.8.1
</span></span><span class=line><span class=cl><span class=nv>SUPPORT</span><span class=o>=</span><span class=k>$(</span>EPICS_BASE<span class=k>)</span>/../epics-modules
</span></span><span class=line><span class=cl><span class=nv>ASYN</span><span class=o>=</span><span class=k>$(</span>SUPPORT<span class=k>)</span>/asyn
</span></span><span class=line><span class=cl><span class=nv>MOTOR</span><span class=o>=</span><span class=k>$(</span>SUPPORT<span class=k>)</span>/motor
</span></span><span class=line><span class=cl><span class=c1># 指定交叉编译架构</span>
</span></span><span class=line><span class=cl><span class=nv>EPICS_HOST_ARCH</span><span class=o>=</span>linux-loong64</span></span></code></pre></td></tr></table></div></div></div></div><p>修改<code>devEcmcSup/Makefile</code></p><div class=mac-codeblock><div class=mac-titlebar><div class=mac-left-group><span class=mac-close></span>
<span class=mac-minimize></span>
<span class=mac-expand></span></div><div class=mac-title title=devEcmcSup/Makefile>devEcmcSup/Makefile</div><div class=mac-right-group><button class=fold-button>&#9660;</button></div></div><div class=mac-content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl>#************************************************************************
</span></span><span class=line><span class=cl># Copyright (c) 2019 European Spallation Source ERIC
</span></span><span class=line><span class=cl># ecmc is distributed subject to a Software License Agreement found
</span></span><span class=line><span class=cl># in file LICENSE that is included with this distribution.
</span></span><span class=line><span class=cl>#
</span></span><span class=line><span class=cl># Author: Jeong Han Lee &lt;jeonghan.lee@gmail.com&gt;
</span></span><span class=line><span class=cl>#
</span></span><span class=line><span class=cl>#*************************************************************************
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TOP=..
</span></span><span class=line><span class=cl>include $(TOP)/configure/CONFIG
</span></span><span class=line><span class=cl>#----------------------------------------
</span></span><span class=line><span class=cl>#  ADD MACRO DEFINITIONS AFTER THIS LINE
</span></span><span class=line><span class=cl>#=============================
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ECMC = $(TOP)/devEcmcSup
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>LIBRARY_IOC += ecmc
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># Ubuntu needs the following ldflags
</span></span><span class=line><span class=cl>USR_LDFLAGS += -Wl,--no-as-needed
</span></span><span class=line><span class=cl>USR_LDFLAGS += -lstdc++
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ifeq ($(T_A),linux-x86_64)
</span></span><span class=line><span class=cl># Assume that the etherlab user library is done via
</span></span><span class=line><span class=cl># https://github.com/icshwi/etherlabmaster
</span></span><span class=line><span class=cl>USR_INCLUDES += -I/opt/etherlab/include
</span></span><span class=line><span class=cl>USR_CFLAGS += -fPIC
</span></span><span class=line><span class=cl>USR_LDFLAGS += -L /opt/etherlab/lib
</span></span><span class=line><span class=cl>USR_LDFLAGS += -lethercat
</span></span><span class=line><span class=cl>USR_LDFLAGS += -Wl,-rpath=/opt/etherlab/lib
</span></span><span class=line><span class=cl>else
</span></span><span class=line><span class=cl># Assume that the etherlab user library is done via
</span></span><span class=line><span class=cl># Yocto ESS Linux bb recipe
</span></span><span class=line><span class=cl><span class=gi>+ # 这里注意etherlab的路径
</span></span></span><span class=line><span class=cl><span class=gi></span>USR_INCLUDES += -I$(SDKTARGETSYSROOT)/usr/include/etherlab
</span></span><span class=line><span class=cl>USR_CFLAGS   += -fPIC
</span></span><span class=line><span class=cl>USR_LDFLAGS  += -L $(SDKTARGETSYSROOT)/usr/lib/etherlab
</span></span><span class=line><span class=cl>USR_LDFLAGS  += -lethercat
</span></span><span class=line><span class=cl>USR_LDFLAGS  += -Wl,-rpath=$(SDKTARGETSYSROOT)/usr/lib/etherlab
</span></span><span class=line><span class=cl>endif
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=gi>+ # ruckig路径
</span></span></span><span class=line><span class=cl><span class=gi>+ USR_INCLUDES += -I/path/to/ruckig/include
</span></span></span><span class=line><span class=cl><span class=gi>+ USR_LDFLAGS  += -L /path/to/ruckig/build
</span></span></span><span class=line><span class=cl><span class=gi>+ USR_LDFLAGS  += -lruckig
</span></span></span><span class=line><span class=cl><span class=gi></span>
</span></span><span class=line><span class=cl>SRC_DIRS  += $(ECMC)/plc
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcPLC.cpp
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcPLCTask.cpp
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcPLCDataIF.cpp
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcPLCMain.cpp
</span></span><span class=line><span class=cl><span class=gi>+ ecmc_SRCS += ecmcPLCLib.cpp
</span></span></span><span class=line><span class=cl><span class=gi>+ ecmc_SRCS += ecmcPLCLibFunc.cpp
</span></span></span><span class=line><span class=cl><span class=gi></span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>SRC_DIRS  += $(ECMC)/misc
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcMisc.cpp
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcEvent.cpp
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcEventConsumer.cpp
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcDataRecorder.cpp
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcDataStorage.cpp
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcCommandList.cpp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>SRC_DIRS  += $(ECMC)/main
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcGeneral.cpp
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcError.cpp
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcMainThread.cpp
</span></span><span class=line><span class=cl>ecmc_SRCS += gitversion.c
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>SRC_DIRS  += $(ECMC)/ethercat
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcEthercat.cpp
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcEc.cpp
</span></span><span class=line><span class=cl><span class=gi>+ ecmc_SRCS += ecmcEcData.cpp
</span></span></span><span class=line><span class=cl><span class=gi>+ ecmc_SRCS += ecmcEcDomain.cpp
</span></span></span><span class=line><span class=cl><span class=gi></span>ecmc_SRCS += ecmcEcEntry.cpp
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcEcPdo.cpp
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcEcSDO.cpp
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcEcSlave.cpp
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcEcSyncManager.cpp
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcEcEntryLink.cpp  
</span></span><span class=line><span class=cl><span class=gi>+ ecmc_SRCS += ecmcEcAsyncSDO.cpp
</span></span></span><span class=line><span class=cl><span class=gi></span>ecmc_SRCS += ecmcAsynLink.cpp
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcEcMemMap.cpp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>SRC_DIRS  += $(ECMC)/com
</span></span><span class=line><span class=cl>DBD       += ecmcController.dbd
</span></span><span class=line><span class=cl><span class=gi>+ ecmc_SRCS += ecmcDataItem.cpp
</span></span></span><span class=line><span class=cl><span class=gi></span>ecmc_SRCS += ecmcCom.cpp
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcOctetIF.c
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcCmdParser.c
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcAsynPortDriver.cpp
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcAsynPortDriverUtils.cpp
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcAsynDataItem.cpp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>SRC_DIRS  += $(ECMC)/motion
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcMotion.cpp
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcAxisBase.cpp
</span></span><span class=line><span class=cl><span class=gi>+ ecmc_SRCS += ecmcAxisGroup.cpp
</span></span></span><span class=line><span class=cl><span class=gi></span>ecmc_SRCS += ecmcAxisReal.cpp
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcAxisVirt.cpp
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcDriveBase.cpp
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcDriveStepper.cpp
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcDriveDS402.cpp
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcEncoder.cpp
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcFilter.cpp
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcMonitor.cpp
</span></span><span class=line><span class=cl><span class=gi>+ ecmc_SRCS += ecmcMotionUtils.cpp
</span></span></span><span class=line><span class=cl><span class=gi></span>ecmc_SRCS += ecmcPIDController.cpp
</span></span><span class=line><span class=cl><span class=gi>+ ecmc_SRCS += ecmcPVTController.cpp
</span></span></span><span class=line><span class=cl><span class=gi></span>ecmc_SRCS += ecmcAxisSequencer.cpp
</span></span><span class=line><span class=cl><span class=gi>+ ecmc_SRCS += ecmcAxisPVTSequence.cpp
</span></span></span><span class=line><span class=cl><span class=gi>+ ecmc_SRCS += ecmcTrajectoryBase.cpp
</span></span></span><span class=line><span class=cl><span class=gi>+ ecmc_SRCS += ecmcTrajectoryS.cpp
</span></span></span><span class=line><span class=cl><span class=gi></span>ecmc_SRCS += ecmcTrajectoryTrapetz.cpp
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcAxisData.cpp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>SRC_DIRS  += $(ECMC)/motor
</span></span><span class=line><span class=cl>DBD       += ecmcMotorRecordSupport.dbd
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcMotorRecordController.cpp
</span></span><span class=line><span class=cl>ecmc_SRCS += ecmcMotorRecordAxis.cpp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=gi>+ SRC_DIRS  += $(ECMC)/plugin
</span></span></span><span class=line><span class=cl><span class=gi>+ ecmc_SRCS += ecmcPluginLib.cpp
</span></span></span><span class=line><span class=cl><span class=gi>+ ecmc_SRCS += ecmcPlugin.cpp
</span></span></span><span class=line><span class=cl><span class=gi>+ ecmc_SRCS += ecmcPluginClient.cpp
</span></span></span><span class=line><span class=cl><span class=gi></span>
</span></span><span class=line><span class=cl>ecmc_LIBS += exprtkSupport
</span></span><span class=line><span class=cl>ecmc_LIBS += $(EPICS_BASE_IOC_LIBS)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>include $(TOP)/configure/RULES
</span></span><span class=line><span class=cl>#----------------------------------------
</span></span><span class=line><span class=cl>#  ADD RULES AFTER THIS LINE
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>gitversion.c:
</span></span><span class=line><span class=cl>    @$(RM) $@
</span></span><span class=line><span class=cl>    @sh $(TOP)/tools/gitversion.sh $@
</span></span></code></pre></td></tr></table></div></div></div></div><p>修改<code>devEcmcSup/motion/ecmcTrajectoryS.h</code></p><div class=mac-codeblock><div class=mac-titlebar><div class=mac-left-group><span class=mac-close></span>
<span class=mac-minimize></span>
<span class=mac-expand></span></div><div class=mac-title title=devEcmcSup/motion/ecmcTrajectoryS.h>devEcmcSup/motion/ecmcTrajectoryS.h</div><div class=mac-right-group><button class=fold-button>&#9660;</button></div></div><div class=mac-content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl>#include &#34;ecmcecmcTrajectoryBase.h&#34;
</span></span><span class=line><span class=cl><span class=gd>- #include &lt;ruckig.hpp&gt;
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+ #include &lt;ruckig/ruckig.hpp&gt;
</span></span></span></code></pre></td></tr></table></div></div></div></div><p>修改<code>ecmcExampleTop/configure/RELEASE.local</code></p><div class=mac-codeblock><div class=mac-titlebar><div class=mac-left-group><span class=mac-close></span>
<span class=mac-minimize></span>
<span class=mac-expand></span></div><div class=mac-title title=ecmcExampleTop/configure/RELEASE.local>ecmcExampleTop/configure/RELEASE.local</div><div class=mac-right-group><button class=fold-button>&#9660;</button></div></div><div class=mac-content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nv>EPICS_BASE</span><span class=o>=</span>/home/ubuntu/epics/base-7.0.8.1
</span></span><span class=line><span class=cl><span class=nv>SUPPORT</span><span class=o>=</span><span class=k>$(</span>EPICS_BASE<span class=k>)</span>/../epics-modules
</span></span><span class=line><span class=cl><span class=nv>ASYN</span><span class=o>=</span><span class=k>$(</span>SUPPORT<span class=k>)</span>/asyn
</span></span><span class=line><span class=cl><span class=nv>MOTOR</span><span class=o>=</span><span class=k>$(</span>SUPPORT<span class=k>)</span>/motor
</span></span><span class=line><span class=cl><span class=c1># 添加QSRV2支持</span>
</span></span><span class=line><span class=cl><span class=nv>PVXS</span><span class=o>=</span><span class=k>$(</span>SUPPORT<span class=k>)</span>/pvxs
</span></span><span class=line><span class=cl><span class=c1># 指定交叉编译架构</span>
</span></span><span class=line><span class=cl><span class=nv>EPICS_HOST_ARCH</span><span class=o>=</span>linux-loong64</span></span></code></pre></td></tr></table></div></div></div></div><p>修改<code>ecmcExampleTop/ecmcIocApp/src/Makefile</code></p><div class=mac-codeblock><div class=mac-titlebar><div class=mac-left-group><span class=mac-close></span>
<span class=mac-minimize></span>
<span class=mac-expand></span></div><div class=mac-title title=diff>diff</div><div class=mac-right-group><button class=fold-button>&#9660;</button></div></div><div class=mac-content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl>TOP=../..
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>include $(TOP)/configure/CONFIG
</span></span><span class=line><span class=cl>#----------------------------------------
</span></span><span class=line><span class=cl>#  ADD MACRO DEFINITIONS AFTER THIS LINE
</span></span><span class=line><span class=cl>#=============================
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>#=============================
</span></span><span class=line><span class=cl># Build the IOC application
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>PROD_IOC = ecmcIoc
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># Ubuntu needs the following ldflags
</span></span><span class=line><span class=cl>USR_LDFLAGS_Linux += -Wl,--no-as-needed
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=gi>+ ifeq ($(T_A),linux-x86_64)
</span></span></span><span class=line><span class=cl><span class=gi>+ # Assume that the etherlab user library is done via
</span></span></span><span class=line><span class=cl><span class=gi>+ # https://github.com/icshwi/etherlabmaster
</span></span></span><span class=line><span class=cl><span class=gi>+ USR_INCLUDES += -I/opt/etherlab/include
</span></span></span><span class=line><span class=cl><span class=gi>+ USR_CFLAGS += -fPIC
</span></span></span><span class=line><span class=cl><span class=gi>+ USR_LDFLAGS += -L /opt/etherlab/lib
</span></span></span><span class=line><span class=cl><span class=gi>+ USR_LDFLAGS += -lethercat
</span></span></span><span class=line><span class=cl><span class=gi>+ USR_LDFLAGS += -Wl,-rpath=/opt/etherlab/lib
</span></span></span><span class=line><span class=cl><span class=gi>+ else
</span></span></span><span class=line><span class=cl><span class=gi>+ # Assume that the etherlab user library is done via
</span></span></span><span class=line><span class=cl><span class=gi>+ # Yocto ESS Linux bb recipe
</span></span></span><span class=line><span class=cl><span class=gi>+ # 这里注意etherlab的路径
</span></span></span><span class=line><span class=cl><span class=gi>+ USR_INCLUDES += -I$(SDKTARGETSYSROOT)/usr/include/etherlab
</span></span></span><span class=line><span class=cl><span class=gi>+ USR_CFLAGS   += -fPIC
</span></span></span><span class=line><span class=cl><span class=gi>+ USR_LDFLAGS  += -L $(SDKTARGETSYSROOT)/usr/lib/etherlab
</span></span></span><span class=line><span class=cl><span class=gi>+ USR_LDFLAGS  += -lethercat
</span></span></span><span class=line><span class=cl><span class=gi>+ USR_LDFLAGS  += -Wl,-rpath=$(SDKTARGETSYSROOT)/usr/lib/etherlab
</span></span></span><span class=line><span class=cl><span class=gi>+ endif
</span></span></span><span class=line><span class=cl><span class=gi></span>
</span></span><span class=line><span class=cl><span class=gi>+ # ruckig路径
</span></span></span><span class=line><span class=cl><span class=gi>+ USR_INCLUDES += -I/path/to/ruckig/include
</span></span></span><span class=line><span class=cl><span class=gi>+ USR_LDFLAGS  += -L /path/to/ruckig/build
</span></span></span><span class=line><span class=cl><span class=gi>+ USR_LDFLAGS  += -lruckig
</span></span></span><span class=line><span class=cl><span class=gi></span>
</span></span><span class=line><span class=cl># ecmcioc.dbd will be created and installed
</span></span><span class=line><span class=cl>DBD += ecmcIoc.dbd
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># opcuaIoc.dbd will be made up from these files:
</span></span><span class=line><span class=cl>ecmcIoc_DBD += base.dbd
</span></span><span class=line><span class=cl>ecmcIoc_DBD += ecmcController.dbd
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># Add all the support libraries needed by this IOC
</span></span><span class=line><span class=cl>ecmcIoc_LIBS += asyn
</span></span><span class=line><span class=cl>ecmcIoc_LIBS += ecmc
</span></span><span class=line><span class=cl><span class=gi>+ ecmcIoc_LIBS += motor
</span></span></span><span class=line><span class=cl><span class=gi></span>ecmcIoc_LIBS += exprtkSupport
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=gi>+ ecmcIoc_DBD += asyn.dbd
</span></span></span><span class=line><span class=cl><span class=gi>+ ecmcIoc_DBD += motorSupport.dbd
</span></span></span><span class=line><span class=cl><span class=gi></span>
</span></span><span class=line><span class=cl>ecmcIoc_SRCS += ecmcIoc_registerRecordDeviceDriver.cpp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># Build the main IOC entry point on workstation OSs.
</span></span><span class=line><span class=cl>ecmcIoc_SRCS_DEFAULT += ecmcIocMain.cpp
</span></span><span class=line><span class=cl>ecmcIoc_SRCS_vxWorks += -nil-
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=gi>+ # Link PVXS if available
</span></span></span><span class=line><span class=cl><span class=gi>+ ifdef PVXS_MAJOR_VERSION
</span></span></span><span class=line><span class=cl><span class=gi>+     ecmcIoc_LIBS += pvxsIoc pvxs
</span></span></span><span class=line><span class=cl><span class=gi>+     ecmcIoc_DBD += pvxsIoc.dbd
</span></span></span><span class=line><span class=cl><span class=gi>+ else
</span></span></span><span class=line><span class=cl><span class=gi>+ # Link QSRV (pvAccess Server) if available
</span></span></span><span class=line><span class=cl><span class=gi>+ ifdef EPICS_QSRV_MAJOR_VERSION
</span></span></span><span class=line><span class=cl><span class=gi>+     ecmcIoc_LIBS += qsrv
</span></span></span><span class=line><span class=cl><span class=gi>+     ecmcIoc_LIBS += $(EPICS_BASE_PVA_CORE_LIBS)
</span></span></span><span class=line><span class=cl><span class=gi>+     ecmcIoc_DBD += PVAServerRegister.dbd
</span></span></span><span class=line><span class=cl><span class=gi>+     ecmcIoc_DBD += qsrv.dbd
</span></span></span><span class=line><span class=cl><span class=gi>+ endif
</span></span></span><span class=line><span class=cl><span class=gi>+ endif
</span></span></span><span class=line><span class=cl><span class=gi></span>
</span></span><span class=line><span class=cl># Finally link to the EPICS Base libraries
</span></span><span class=line><span class=cl>ecmcIoc_LIBS += $(EPICS_BASE_IOC_LIBS)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>#===========================
</span></span><span class=line><span class=cl>include $(TOP)/configure/RULES
</span></span><span class=line><span class=cl>#----------------------------------------
</span></span><span class=line><span class=cl>#  ADD RULES AFTER THIS LINE
</span></span></code></pre></td></tr></table></div></div></div></div><p>编译的时候需要指定使用<code>c++17</code>的标准，不然有一些语法不支持，应该是<code>ruckig</code>库比较新。</p><p>添加<code>CPPFLAGS=-std=c++17</code></p><div class=mac-codeblock><div class=mac-titlebar><div class=mac-left-group><span class=mac-close></span>
<span class=mac-minimize></span>
<span class=mac-expand></span></div><div class=mac-title title=shell>shell</div><div class=mac-right-group><button class=fold-button>&#9660;</button></div></div><div class=mac-content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 执行交叉编译</span>
</span></span><span class=line><span class=cl>make <span class=nv>CPPFLAGS</span><span class=o>=</span>-std<span class=o>=</span>c++17 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=nv>LD</span><span class=o>=</span>loongarch64-linux-gnu-ld <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=nv>CC</span><span class=o>=</span>loongarch64-linux-gnu-gcc <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=nv>CCC</span><span class=o>=</span>loongarch64-linux-gnu-g++ -j4</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=使用方法>使用方法<a hidden class=anchor aria-hidden=true href=#使用方法>#</a></h2><p>主要使用<code>ecmccfg</code>软件包提供的预编写脚本进行<code>EtherCAT</code>主站、从站配置。</p><p>修改IOC环境变量配置<code>iocBoot/iocExample/envPaths</code>：</p><div class=mac-codeblock><div class=mac-titlebar><div class=mac-left-group><span class=mac-close></span>
<span class=mac-minimize></span>
<span class=mac-expand></span></div><div class=mac-title title=envPaths>envPaths</div><div class=mac-right-group><button class=fold-button>&#9660;</button></div></div><div class=mac-content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>epicsEnvSet<span class=o>(</span><span class=s2>&#34;IOC&#34;</span>, <span class=s2>&#34;iocExample&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>epicsEnvSet<span class=o>(</span><span class=s2>&#34;TOP&#34;</span>, <span class=s2>&#34;../..&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>epicsEnvSet<span class=o>(</span><span class=s2>&#34;SUPPORT&#34;</span>, <span class=s2>&#34;/root/epics-modules&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>epicsEnvSet<span class=o>(</span><span class=s2>&#34;ASYN&#34;</span>, <span class=s2>&#34;</span><span class=si>${</span><span class=nv>SUPPORT</span><span class=si>}</span><span class=s2>/asyn&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>epicsEnvSet<span class=o>(</span><span class=s2>&#34;ECMC&#34;</span>, <span class=s2>&#34;</span><span class=si>${</span><span class=nv>SUPPORT</span><span class=si>}</span><span class=s2>/ecmc&#34;</span><span class=o>)</span></span></span></code></pre></td></tr></table></div></div></div></div><p>修改启动脚本<code>iocBoot/iocExample/st.cmd</code>：</p><div class=mac-codeblock><div class=mac-titlebar><div class=mac-left-group><span class=mac-close></span>
<span class=mac-minimize></span>
<span class=mac-expand></span></div><div class=mac-title title=st.cmd>st.cmd</div><div class=mac-right-group><button class=fold-button>&#9660;</button></div></div><div class=mac-content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=cp>#!../../bin/linux-loong64/ecmcIoc
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>&lt; envPaths
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>cd</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>TOP</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## Register all support components</span>
</span></span><span class=line><span class=cl>dbLoadDatabase <span class=s2>&#34;dbd/ecmcIoc.dbd&#34;</span>
</span></span><span class=line><span class=cl>ecmcIoc_registerRecordDeviceDriver pdbbase
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## Load record instances</span>
</span></span><span class=line><span class=cl><span class=c1>#dbLoadRecords(&#34;db/xxx.db&#34;,&#34;user=${USER}&#34;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ecmccfg路径配置</span>
</span></span><span class=line><span class=cl>epicsEnvSet <span class=s2>&#34;ecmccfg_DIR&#34;</span>, <span class=s2>&#34;</span><span class=si>${</span><span class=nv>ECMC</span><span class=si>}</span><span class=s2>/scripts/&#34;</span>
</span></span><span class=line><span class=cl>epicsEnvSet <span class=s2>&#34;ecmccfg_DB&#34;</span>, <span class=s2>&#34;</span><span class=si>${</span><span class=nv>ECMC</span><span class=si>}</span><span class=s2>/db/&#34;</span>
</span></span><span class=line><span class=cl>epicsEnvSet <span class=s2>&#34;ECMC_CONFIG_ROOT&#34;</span>, <span class=s2>&#34;</span><span class=si>${</span><span class=nv>ecmccfg_DIR</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>epicsEnvSet <span class=s2>&#34;ECMC_CONFIG_DB&#34;</span>, <span class=s2>&#34;</span><span class=si>${</span><span class=nv>ecmccfg_DB</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>epicsEnvSet <span class=s2>&#34;SCRIPTEXEC&#34;</span>, <span class=s2>&#34;iocshLoad&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#- 初始化</span>
</span></span><span class=line><span class=cl><span class=si>${</span><span class=nv>SCRIPTEXEC</span><span class=si>}</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>ECMC_CONFIG_ROOT</span><span class=si>}</span><span class=s2>initAll.cmd&#34;</span>, <span class=s2>&#34;SM_MOTOR_PORT=MCU1,SM_ASYN_PORT=MC_CPU1,SM_PREFIX=</span><span class=si>${</span><span class=nv>IOC</span><span class=si>}</span><span class=s2>:&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># EtherCAT主站号</span>
</span></span><span class=line><span class=cl>epicsEnvSet <span class=s2>&#34;MASTER_ID&#34;</span>, <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=c1># 扫描频率，默认 1000</span>
</span></span><span class=line><span class=cl>epicsEnvSet <span class=s2>&#34;EC_RATE&#34;</span>, <span class=m>100</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#-</span>
</span></span><span class=line><span class=cl><span class=c1>#-------------------------------------------------------------------------------</span>
</span></span><span class=line><span class=cl><span class=c1># Set EtherCAT frequency (defaults to 1000)</span>
</span></span><span class=line><span class=cl>ecmcConfigOrDie <span class=s2>&#34;Cfg.SetSampleRate(</span><span class=si>${</span><span class=nv>EC_RATE</span><span class=p>=1000</span><span class=si>}</span><span class=s2>)&#34;</span>
</span></span><span class=line><span class=cl><span class=c1>#-</span>
</span></span><span class=line><span class=cl><span class=c1>#- Set current EtherCAT sample rate</span>
</span></span><span class=line><span class=cl><span class=c1>#- Note: Not the same as ECMC_SAMPLE_RATE_MS which is for record update</span>
</span></span><span class=line><span class=cl>epicsEnvSet <span class=s2>&#34;ECMC_EC_SAMPLE_RATE&#34;</span>, <span class=si>${</span><span class=nv>EC_RATE</span><span class=p>=1000</span><span class=si>}</span>
</span></span><span class=line><span class=cl>ecmcEpicsEnvSetCalc<span class=o>(</span><span class=s2>&#34;ECMC_EC_SAMPLE_RATE_MS&#34;</span>, 1000/<span class=si>${</span><span class=nv>ECMC_EC_SAMPLE_RATE</span><span class=p>=1000</span><span class=si>}</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Update records in 10ms (100Hz) for FULL MODE and in EC_RATE for DAQ mode</span>
</span></span><span class=line><span class=cl>ecmcEpicsEnvSetCalcTernary<span class=o>(</span>ECMC_SAMPLE_RATE_MS, <span class=s2>&#34;&#39;</span><span class=si>${</span><span class=nv>ECMC_MODE</span><span class=p>=FULL</span><span class=si>}</span><span class=s2>&#39;==&#39;DAQ&#39;&#34;</span>,<span class=s2>&#34;</span><span class=si>${</span><span class=nv>ECMC_EC_SAMPLE_RATE_MS</span><span class=si>}</span><span class=s2>&#34;</span>,<span class=s2>&#34;10&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>epicsEnvSet<span class=o>(</span>ECMC_SAMPLE_RATE_MS_ORIGINAL, <span class=si>${</span><span class=nv>ECMC_SAMPLE_RATE_MS</span><span class=si>}</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#- define naming convention script</span>
</span></span><span class=line><span class=cl><span class=c1>#epicsEnvSet &#34;ECMC_P_SCRIPT&#34;, &#34;${NAMING=mXsXXX}&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#- Set master</span>
</span></span><span class=line><span class=cl><span class=si>${</span><span class=nv>SCRIPTEXEC</span><span class=si>}</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>ECMC_CONFIG_ROOT</span><span class=si>}</span><span class=s2>addMaster.cmd&#34;</span>, <span class=s2>&#34;MASTER_ID=</span><span class=si>${</span><span class=nv>MASTER_ID</span><span class=p>=0</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>epicsEnvSet <span class=s2>&#34;ECMC_EC_MASTER_ID&#34;</span>, <span class=si>${</span><span class=nv>MASTER_ID</span><span class=p>=0</span><span class=si>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#- Add slaves</span>
</span></span><span class=line><span class=cl><span class=si>${</span><span class=nv>SCRIPTEXEC</span><span class=si>}</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>ECMC_CONFIG_ROOT</span><span class=si>}</span><span class=s2>addSlave.cmd&#34;</span>, <span class=s2>&#34;SLAVE_ID=0, HW_DESC=EK1100&#34;</span>
</span></span><span class=line><span class=cl><span class=si>${</span><span class=nv>SCRIPTEXEC</span><span class=si>}</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>ECMC_CONFIG_ROOT</span><span class=si>}</span><span class=s2>addSlave.cmd&#34;</span>, <span class=s2>&#34;SLAVE_ID=1, HW_DESC=EL4024&#34;</span>
</span></span><span class=line><span class=cl><span class=si>${</span><span class=nv>SCRIPTEXEC</span><span class=si>}</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>ECMC_CONFIG_ROOT</span><span class=si>}</span><span class=s2>addSlave.cmd&#34;</span>, <span class=s2>&#34;SLAVE_ID=2, HW_DESC=EL2624&#34;</span>
</span></span><span class=line><span class=cl><span class=si>${</span><span class=nv>SCRIPTEXEC</span><span class=si>}</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>ECMC_CONFIG_ROOT</span><span class=si>}</span><span class=s2>addSlave.cmd&#34;</span>, <span class=s2>&#34;SLAVE_ID=3, HW_DESC=EL3742&#34;</span>
</span></span><span class=line><span class=cl><span class=si>${</span><span class=nv>SCRIPTEXEC</span><span class=si>}</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>ECMC_CONFIG_ROOT</span><span class=si>}</span><span class=s2>addSlave.cmd&#34;</span>, <span class=s2>&#34;SLAVE_ID=4, HW_DESC=EK1110&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#- Apply hardware configuration</span>
</span></span><span class=line><span class=cl><span class=si>${</span><span class=nv>SCRIPTEXEC</span><span class=si>}</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>ECMC_CONFIG_ROOT</span><span class=si>}</span><span class=s2>applyConfig.cmd&#34;</span>
</span></span><span class=line><span class=cl><span class=c1>#- Activate</span>
</span></span><span class=line><span class=cl><span class=si>${</span><span class=nv>SCRIPTEXEC</span><span class=si>}</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>ECMC_CONFIG_ROOT</span><span class=si>}</span><span class=s2>setAppMode.cmd&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>cd</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>TOP</span><span class=si>}</span><span class=s2>/iocBoot/</span><span class=si>${</span><span class=nv>IOC</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>iocInit
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## Start any sequence programs</span>
</span></span><span class=line><span class=cl><span class=c1>#seq sncxxx,&#34;user=${USER}&#34;</span></span></span></code></pre></td></tr></table></div></div></div></div><ul><li><code>ecmcXXxxxx.cmd</code>：从站配置脚本</li><li><code>ecmcXXxxxx.substitutions</code>：记录(records)</li></ul><p><em>参考链接</em></p><ul><li><a href=https://e3pages.readthedocs.io/en/latest/index.html>ESS EPICS Environment (e3) — ESS EPICS Environment (e3) documentation</a></li><li><a href=https://paulscherrerinstitute.github.io/ecmccfg/>ecmccfg 手册</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://kira-96.github.io/tags/epics/>EPICS</a></li><li><a href=https://kira-96.github.io/tags/ethercat/>EtherCAT</a></li></ul></footer><script src=https://utteranc.es/client.js repo=kira-96/kira-96.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></article></main><footer class=footer><span>© 2019-2025 <a href=/>kira&rsquo;s blog</a> · LICENSED under <a href=https://github.com/kira-96/kira-96.github.io/tree/main/LICENSE>CC-BY-4.0</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>document.querySelectorAll(".fold-button").forEach(e=>{e.addEventListener("click",t=>{const n=t.target.closest(".mac-codeblock"),s=n.querySelector(".mac-content");s.classList.toggle("folded"),e.classList.toggle("folded")})})</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>