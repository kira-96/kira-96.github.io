<!doctype html><html lang=zh-cn>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=generator content="Hugo 0.92.1">
<title> GDI+绘制旋转的椭圆 | kira's 博客 </title>
<meta name=description content="kira's blog">
<link rel=stylesheet href=https://kira-96.github.io/css/simpleness.css>
<link rel=canonical href=https://kira-96.github.io/notes/Draw-rotate-ellipse-with-gdi/>
<link rel=alternate type=application/rss+xml href title="kira's 博客">
<link href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css rel=stylesheet>
<meta name=theme-color content="#ffffff">
<meta name=msapplication-TileColor content="#da532c">
<meta name=apple-mobile-web-app-capable content="yes">
<meta name=apple-mobile-web-app-title content="GDI+绘制旋转的椭圆">
<link rel=apple-touch-icon sizes=152x152 href=https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/icons/apple-icon-152x152.png>
<link rel=apple-touch-icon sizes=180x180 href=https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/icons/apple-icon-180x180.png>
<link rel=icon href=https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/favicon.ico>
<link rel=icon sizes=16x16 href=https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/favicon-16x16.png>
<link rel=icon sizes=32x32 href=https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/favicon-32x32.png>
<link rel=icon sizes=96x96 href=https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/favicon-96x96.png>
<link rel=manifest href=https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/manifest.json>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css>
<script defer src=https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js></script>
</head>
<body class=container>
<nav class=navigation>
<div class=nav-left>
<div class="nav-item nav-title">
<a href=https://kira-96.github.io/> kira's 博客</a>
</div>
<div class="nav-item nav-menu">
<a href=/> Home</a>
<a href=/notes/> Notes</a>
</div>
</div>
<div class="nav-item nav-right fontawesome">
<a href=https://github.com/kira-96/ target=_blank>
<i title=GitHub class="fab fa-github"></i>
</a>
<a href=https://kira-96.github.io/index.xml target=_blank>
<i title=RSS class="fas fa-rss"></i>
</a>
</div>
</nav>
<article class=post>
<header class=post-header>
<h1 style=text-align:center>GDI+绘制旋转的椭圆</h1>
<div class=post-metadata>
<time datetime=2021-01-21T16:23:42+08:00>January 21, 2021</time> &nbsp;
<i class="far fa-eye"></i>
<span id=/notes/Draw-rotate-ellipse-with-gdi/ class=leancloud_visitors data-flag-title=GDI+绘制旋转的椭圆>
<span class=leancloud-visitors-count> </span>
</span> &nbsp;
<i class="far fa-clock"></i>
6 min
2 s
&nbsp;
</div>
</header>
<div class=post-text>
<p>GDI+绘制椭圆时只支持输入一个矩形范围，无法绘制倾斜的椭圆。</p>
<p>绘制椭圆的 API：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#75715e>// 摘要: 绘制边界 System.Drawing.RectangleF 定义的椭圆。
</span><span style=color:#75715e>// 参数:
</span><span style=color:#75715e>//   pen: System.Drawing.Pen，它确定曲线的颜色、宽度和样式。
</span><span style=color:#75715e>//   rect: System.Drawing.RectangleF 结构，它定义椭圆的边界。
</span><span style=color:#75715e>// 异常:
</span><span style=color:#75715e>//   T:System.ArgumentNullException: pen 为 null。
</span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> DrawEllipse(Pen pen, RectangleF rect);
<span style=color:#75715e>//
</span><span style=color:#75715e>// 摘要: 绘制一个由边框（该边框由一对坐标、高度和宽度指定）定义的椭圆。
</span><span style=color:#75715e>// 参数:
</span><span style=color:#75715e>//   pen: System.Drawing.Pen，它确定曲线的颜色、宽度和样式。
</span><span style=color:#75715e>//   x: 定义椭圆的边框的左上角的 X 坐标。
</span><span style=color:#75715e>//   y: 定义椭圆的边框的左上角的 Y 坐标。
</span><span style=color:#75715e>//   width: 定义椭圆的边框的宽度。
</span><span style=color:#75715e>//   height: 定义椭圆的边框的高度。
</span><span style=color:#75715e>// 异常:
</span><span style=color:#75715e>//   T:System.ArgumentNullException: pen 为 null。
</span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> DrawEllipse(Pen pen, <span style=color:#66d9ef>float</span> x, <span style=color:#66d9ef>float</span> y, <span style=color:#66d9ef>float</span> width, <span style=color:#66d9ef>float</span> height);
<span style=color:#75715e>//
</span><span style=color:#75715e>// 摘要: 绘制边界 System.Drawing.Rectangle 结构指定的椭圆。
</span><span style=color:#75715e>// 参数:
</span><span style=color:#75715e>//   pen: System.Drawing.Pen，它确定曲线的颜色、宽度和样式。
</span><span style=color:#75715e>//   rect: System.Drawing.Rectangle 结构，它定义椭圆的边界。
</span><span style=color:#75715e>// 异常:
</span><span style=color:#75715e>//   T:System.ArgumentNullException: pen 为 null。
</span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> DrawEllipse(Pen pen, Rectangle rect);
<span style=color:#75715e>//
</span><span style=color:#75715e>// 摘要: 绘制一个由边框定义的椭圆，该边框由矩形的左上角坐标、高度和宽度指定。
</span><span style=color:#75715e>// 参数:
</span><span style=color:#75715e>//   pen: System.Drawing.Pen，它确定曲线的颜色、宽度和样式。
</span><span style=color:#75715e>//   x: 定义椭圆的边框的左上角的 X 坐标。
</span><span style=color:#75715e>//   y: 定义椭圆的边框的左上角的 Y 坐标。
</span><span style=color:#75715e>//   width: 定义椭圆的边框的宽度。
</span><span style=color:#75715e>//   height: 定义椭圆的边框的高度。
</span><span style=color:#75715e>// 异常:
</span><span style=color:#75715e>//   T:System.ArgumentNullException: pen 为 null。
</span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> DrawEllipse(Pen pen, <span style=color:#66d9ef>int</span> x, <span style=color:#66d9ef>int</span> y, <span style=color:#66d9ef>int</span> width, <span style=color:#66d9ef>int</span> height);
</code></pre></div><p>可以看到，绘制椭圆的API，都只支持输入一个矩形区域，长和宽都只能是水平或者竖直的，因此，绘制出椭圆的长轴和短轴也是水平或竖直的，而无法绘制一个旋转过的椭圆，如下图：</p>
<p><img src=https://i.loli.net/2021/01/22/A7P8l6HpJ3rnbMv.png alt=rotated-ellipse.png></p>
<p>给定椭圆的4个顶点，绘制出椭圆。虽然不能直接调用API绘制椭圆，但是可以通过绘制4条连续的贝塞尔曲线来闭合成一个椭圆。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#75715e>//
</span><span style=color:#75715e>// 摘要: 用 System.Drawing.PointF 结构数组绘制一系列贝塞尔样条。
</span><span style=color:#75715e>// 参数:
</span><span style=color:#75715e>//   pen: System.Drawing.Pen，它确定曲线的颜色、宽度和样式。
</span><span style=color:#75715e>//   points: System.Drawing.PointF 结构的数组，这些结构表示确定曲线的点。
</span><span style=color:#75715e>//   此数组中的点数应为 3 的倍数加 1，如 4、7 或 10。
</span><span style=color:#75715e>//
</span><span style=color:#75715e>// 异常:
</span><span style=color:#75715e>//   T:System.ArgumentNullException: pen 为 null。- 或 -points 为 null。
</span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> DrawBeziers(Pen pen, PointF[] points);
</code></pre></div><p>使用这种方法实际上只需要知道椭圆的中心点，两个轴的长度以及旋转角度即可，而这些都可以通过4个顶点计算得到。</p>
<p>根据以上的信息，依次计算出连续贝塞尔曲线的13个控制点，然后调用<code>DrawBeziers</code>绘制椭圆。</p>
<p>各个点的位置如图：</p>
<p><img src=https://i.loli.net/2021/01/22/XTIPG5rk2tUZo9z.png alt=bezier-draw-ellipse.png></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#75715e>/**
</span><span style=color:#75715e> * C#
</span><span style=color:#75715e> */</span>
<span style=color:#75715e>// MAGICAL CONSTANT to map ellipse to beziers
</span><span style=color:#75715e>// 2/3*(sqrt(2)-1)
</span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>double</span> Ellipse2Beziers = <span style=color:#ae81ff>0.2761423749154</span>;

<span style=color:#75715e>// GDI Bitmap
</span><span style=color:#75715e></span><span style=color:#66d9ef>using</span> var bitmap = <span style=color:#66d9ef>new</span> System.Drawing.Bitmap(width, height);
<span style=color:#66d9ef>using</span> var graphics = System.Drawing.Graphics.FromImage(bitmap);

<span style=color:#75715e>// 椭圆的4个顶点
</span><span style=color:#75715e></span>PointF[] ellipse = <span style=color:#66d9ef>new</span> PointF[<span style=color:#ae81ff>4</span>] { point1, point2, point3, point4 };

<span style=color:#75715e>// 两个轴的长度
</span><span style=color:#75715e></span><span style=color:#66d9ef>double</span> r1 = ellipse[<span style=color:#ae81ff>2</span>].DistanceTo(ellipse[<span style=color:#ae81ff>3</span>]);
<span style=color:#66d9ef>double</span> r2 = ellipse[<span style=color:#ae81ff>0</span>].DistanceTo(ellipse[<span style=color:#ae81ff>1</span>]);
<span style=color:#75715e>// 旋转角度
</span><span style=color:#75715e></span><span style=color:#66d9ef>double</span> angle = -SysMath.Atan2(ellipse[<span style=color:#ae81ff>2</span>].Y - ellipse[<span style=color:#ae81ff>3</span>].Y, ellipse[<span style=color:#ae81ff>2</span>].X - ellipse[<span style=color:#ae81ff>3</span>].X);
<span style=color:#66d9ef>double</span> sin = SysMath.Sin(angle);
<span style=color:#66d9ef>double</span> cos = SysMath.Cos(angle);
<span style=color:#75715e>// 贝塞尔曲线控制点相对于中心点的偏移长度
</span><span style=color:#75715e></span>SizeF offset = <span style=color:#66d9ef>new</span> SizeF((<span style=color:#66d9ef>float</span>)(r1 * Ellipse2Beziers), (<span style=color:#66d9ef>float</span>)(r2 * Ellipse2Beziers));
<span style=color:#75715e>// 椭圆中心点
</span><span style=color:#75715e></span>PointF center = <span style=color:#66d9ef>new</span> PointF((ellipse[<span style=color:#ae81ff>0</span>].X + ellipse[<span style=color:#ae81ff>1</span>].X) / <span style=color:#ae81ff>2f</span>, (ellipse[<span style=color:#ae81ff>0</span>].Y + ellipse[<span style=color:#ae81ff>1</span>].Y) / <span style=color:#ae81ff>2f</span>);
<span style=color:#75715e>// 贝塞尔曲线的控制点
</span><span style=color:#75715e></span>PointF[] beziers = <span style=color:#66d9ef>new</span> PointF[<span style=color:#ae81ff>13</span>]
{
    <span style=color:#66d9ef>new</span> PointF((<span style=color:#66d9ef>float</span>)(center.X - r1 / <span style=color:#ae81ff>2.0</span>), center.Y),
    <span style=color:#66d9ef>new</span> PointF((<span style=color:#66d9ef>float</span>)(center.X - r1 / <span style=color:#ae81ff>2.0</span>), center.Y - offset.Height),
    <span style=color:#66d9ef>new</span> PointF(center.X - offset.Width, (<span style=color:#66d9ef>float</span>)(center.Y - r2 / <span style=color:#ae81ff>2.0</span>)),
    <span style=color:#66d9ef>new</span> PointF(center.X, (<span style=color:#66d9ef>float</span>)(center.Y - r2 / <span style=color:#ae81ff>2.0</span>)),
    <span style=color:#66d9ef>new</span> PointF(center.X + offset.Width, (<span style=color:#66d9ef>float</span>)(center.Y - r2 / <span style=color:#ae81ff>2.0</span>)),
    <span style=color:#66d9ef>new</span> PointF((<span style=color:#66d9ef>float</span>)(center.X + r1 / <span style=color:#ae81ff>2.0</span>), center.Y - offset.Height),
    <span style=color:#66d9ef>new</span> PointF((<span style=color:#66d9ef>float</span>)(center.X + r1 / <span style=color:#ae81ff>2.0</span>), center.Y),
    <span style=color:#66d9ef>new</span> PointF((<span style=color:#66d9ef>float</span>)(center.X + r1 / <span style=color:#ae81ff>2.0</span>), center.Y + offset.Height),
    <span style=color:#66d9ef>new</span> PointF(center.X + offset.Width, (<span style=color:#66d9ef>float</span>)(center.Y + r2 / <span style=color:#ae81ff>2.0</span>)),
    <span style=color:#66d9ef>new</span> PointF(center.X, (<span style=color:#66d9ef>float</span>)(center.Y + r2 / <span style=color:#ae81ff>2.0</span>)),
    <span style=color:#66d9ef>new</span> PointF(center.X - offset.Width, (<span style=color:#66d9ef>float</span>)(center.Y + r2 / <span style=color:#ae81ff>2.0</span>)),
    <span style=color:#66d9ef>new</span> PointF((<span style=color:#66d9ef>float</span>)(center.X - r1 / <span style=color:#ae81ff>2.0</span>), center.Y + offset.Height),
    <span style=color:#66d9ef>new</span> PointF((<span style=color:#66d9ef>float</span>)(center.X - r1 / <span style=color:#ae81ff>2.0</span>), center.Y)
};
<span style=color:#75715e>// 旋转变换
</span><span style=color:#75715e></span><span style=color:#66d9ef>double</span> offsetX = center.X - center.X * cos - center.Y * sin;
<span style=color:#66d9ef>double</span> offsetY = center.Y + center.X * sin - center.Y * cos;
<span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> j = <span style=color:#ae81ff>0</span>; j &lt; beziers.Length; j++)
{
    beziers[j] = <span style=color:#66d9ef>new</span> PointF(
        (<span style=color:#66d9ef>float</span>)(beziers[j].X * cos + beziers[j].Y * sin + offsetX),
        (<span style=color:#66d9ef>float</span>)(beziers[j].Y * cos - beziers[j].X * sin + offsetY));
}
<span style=color:#75715e>// 绘制曲线
</span><span style=color:#75715e></span>graphics.DrawBeziers(<span style=color:#66d9ef>new</span> Pen(Brushes.White, <span style=color:#ae81ff>1f</span>)<span style=color:#75715e>/* Pen */</span>, beziers);
</code></pre></div><p>通过上面代码就可以完美的绘制出一个旋转任意角度的椭圆了。</p>
<p><strong>参考</strong></p>
<p><a href=https://blog.csdn.net/liuyunhuanying/article/details/11645965>MFC上如何绘制一个可以旋转的椭圆</a></p>
<p><a href=https://www.codeguru.com/cpp/g-m/gdi/article.php/c131/Drawing-Rotated-and-Skewed-Ellipses.htm>Drawing Rotated and Skewed Ellipses</a></p>
</div>
<footer class=post-footer>
</footer>
<div class=comments>
<div class=comments>
<div class="comments-item comments-valine">
<div id=vcomments></div>
<script src=//cdn1.lncld.net/static/js/3.0.4/av-min.js></script>
<script src=//unpkg.com/valine/dist/Valine.min.js></script>
<script type=text/javascript>new Valine({el:'#vcomments',highlight:!1,lang:"zh-CN",appId:"X8gbfFnXlzbwF0YQQ91rSogz-gzGzoHsz",appKey:"ljO0GYMaeqs5KWK2vCtk1Ii8",placeholder:"在这里写下你的留言丨支持 Markdown 语法",requiredFields:["nick","mail"],avatar:"mp",visitor:!0,recordIP:!0})</script>
<script>if(window.location.hash)var checkExist=setInterval(function(){$(window.location.hash).length&&($('html, body, article').animate({scrollTop:$(window.location.hash).offset().top-90},1e3),clearInterval(checkExist))},100)</script>
</div>
</div>
</div>
</article>
<div class=foot>
&copy; 2019 - 2022 &#183;
<a href=/> kira's 博客 </a> &#183;
Theme <a href=https://github.com/RainerChiang/simpleness>Simpleness</a> Powered by <a href=https://gohugo.io/>Hugo</a> &#183;
<a href=#><i class="fas fa-chevron-up"></i></a>
</div>
</body>
<script src=/js/lazyload.min.js></script>
<script>var lazyImage=new LazyLoad({container:document.getElementById('article')})</script>
</html>