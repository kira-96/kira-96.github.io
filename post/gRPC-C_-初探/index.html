<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="Hugo 0.79.1" />

  <title> gRPC C# 初探 |  kira&#39;s 博客</title>
  <meta name="description" content="gRpc简单使用">
  <link rel="stylesheet" href="https://kira-96.github.io/css/simpleness.css">
  <link rel="canonical" href="https://kira-96.github.io/post/gRPC-C_-%E5%88%9D%E6%8E%A2/">
  <link rel="alternate" type="application/rss+xml" href="" title="kira&#39;s 博客">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css">
  
  <meta name="theme-color" content="#ffffff">
  <meta name="msapplication-TileColor" content="#da532c">
  <link rel="apple-touch-icon" sizes="180x180" href="https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/apple-touch-icon.png">
  <link rel="icon" href="https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/favicon.ico">
  <link rel="icon" sizes="32x32" href="https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/favicon-32x32.png">
  <link rel="icon" sizes="16x16" href="https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/favicon-16x16.png">
  <link rel="manifest"  href="https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/manifest.json">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">
  <script defer src="https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script>
</head>


<body>
  <header class="menus">
  
  <a href="https://kira-96.github.io/">kira&#39;s 博客</a>
  

  <nav >
    
  </nav>

  <nav class="fontawesome">
    
    <a href="https://github.com/kira-96/" target="_blank">
        <i title="GitHub" class="fab fa-github"></i>
    </a>
    
    
    <a href="https://kira-96.github.io/index.xml" target="_blank">
        <i title="RSS" class="fas fa-rss"></i>
    </a>
    
  </nav>
  
  
  <div class="hidden description">kira's blog</div>
  
</header>

<article class="article">
  <header>
    <h1 style="text-align: center;" >gRPC C# 初探</h1>

    <div class="post-meta">
    
      <time datetime="2019-08-18T17:52:36&#43;08:00">August 18, 2019</time> &nbsp; 
    

     &nbsp;

    
    
      <i class="far fa-eye"></i>
      <span id="/post/gRPC-C_-%E5%88%9D%E6%8E%A2/" class="leancloud_visitors" data-flag-title="gRPC C# 初探">
          <span class="leancloud-visitors-count">  </span>
      </span> &nbsp;
    
    

    
      <i class="far fa-clock"></i>
      
      
      

      
        5 min
      
      38 s
      &nbsp;
    

    
      <i class="fas fa-folder"></i>
      
      <a href="/categories/%E7%BC%96%E7%A8%8B">编程</a>
      &nbsp;
      
    
    </div>
  </header>

   

  <div class="text">
    <h2 id="简介">简介</h2>
<p><a href="https://www.grpc.io/">gRPC</a>是Google开源的一个现代化、高性能的<a href="https://baike.baidu.com/item/%E8%BF%9C%E7%A8%8B%E8%BF%87%E7%A8%8B%E8%B0%83%E7%94%A8%E5%8D%8F%E8%AE%AE">RPC</a>框架，基于<code>HTTP/2</code>标准设计，同时提供多个语言版本，并支持跨语言调用，可以在任何环境中运行。</p>
<h2 id="创建项目">创建项目</h2>
<p>新建解决方案，包含3个项目</p>
<ul>
<li>
<p>gRpcSample</p>
<p>类库，gRPC生成的接口，Server接口、Client接口等</p>
</li>
<li>
<p>server</p>
<p>控制台程序，服务端</p>
</li>
<li>
<p>client</p>
<p>控制台程序，客户端</p>
</li>
</ul>
<p>分别给3个项目安装Nuget程序包<code>Grpc</code>并安装所需依赖，然后为<code>gRpcSample</code>项目安装<code>Grpc.Tools</code>和<code>Google.ProtoBuf</code>程序包。</p>
<p>同时，使项目<code>server</code>和<code>client</code>引用项目<code>gRpcSample</code>。</p>
<h2 id="定义服务接口">定义服务接口</h2>
<p>在<strong>gRpcSample</strong>项目的文件夹下新建<strong>Sample.proto</strong>文件，以文本方式打开，修改其中接口定义</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf">syntax <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;proto3&#34;</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">option</span> csharp_namespace <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;kira.Interface&#34;</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#f92672">package</span> sampleservice;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">service</span> SampleService {<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>	<span style="color:#66d9ef">rpc</span> ServerVersion(VersionRequest) <span style="color:#66d9ef">returns</span> (VersionResponse) {}<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>	<span style="color:#66d9ef">rpc</span> SayHello(HelloRequest) <span style="color:#66d9ef">returns</span> (stream HelloResponse) {}<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">VersionRequest</span> {}<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">VersionResponse</span> {<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">string</span> name <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">string</span> version <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">HelloRequest</span> {<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">string</span> name <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">HelloResponse</span> {<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">string</span> <span style="color:#66d9ef">message</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>这里指定了生成的类的命名空间，同时定义了两个服务函数，似乎每个函数都必须有参数（请求）和返回（响应），这一点不太清楚。具体的语法有条件的可以参考<a href="https://developers.google.com/protocol-buffers/docs/proto3">proto3 language guide</a>。</p>
<h2 id="生成服务接口">生成服务接口</h2>
<p>在进行下面操作前，建议先将<code>Grpc.Tools</code>拷贝到解决方案目录下，不然的话下面的命令会很长很长&hellip;</p>
<p>具体操作是将解决方案下<code>packages\Grpc.Tools.2.23.0-pre1\tools\windows_x64\</code>里面的<code>protoc.exe</code>和<code>grpc_csharp_plugin.exe</code>拷贝到解决方案目录下，完成后就可以进行下一步。</p>
<p>在解决方案目录下打开命令窗口，并执行下面命令</p>
<blockquote>
<p>Tip: 直接进入到相应文件夹下，按住<code>Shift</code>键，在空白出单击鼠标右键，就可以看到菜单中多出了一项<strong>在此处打开命令窗口(W)</strong></p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ protoc -IgRpcSample --csharp_out gRpcSample gRpcSample<span style="color:#ae81ff">\S</span>ample.proto --grpc_out gRpcSample --plugin<span style="color:#f92672">=</span>protoc-gen-grpc<span style="color:#f92672">=</span>grpc_csharp_plugin.exe
</code></pre></div><p>执行完没有错误的话，就可以看到<code>gRpcSample</code>项目下多出了两个文件<code>Sample.cs</code>和<code>SampleGrpc.cs</code>，将这两个文件添加到项目<code>gRpcSample</code>。</p>
<p>编译<code>gRpcSample</code>通过。</p>
<p>进行到这里，基本的工作就都完成了，剩下的就是编写服务端和客户端程序了。</p>
<h2 id="服务端程序">服务端程序</h2>
<p><code>service</code>项目新建类<code>MySampleService</code>，并继承<code>SampleService.SampleServiceBase</code>，重写刚刚定义的两个服务接口函数</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">namespace</span> server
{
    <span style="color:#66d9ef">using</span> System.Threading.Tasks;
    <span style="color:#66d9ef">using</span> Grpc.Core;
    <span style="color:#66d9ef">using</span> kira.Interface;

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MySampleService</span> : SampleService.SampleServiceBase
    {
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">override</span> Task&lt;VersionResponse&gt; ServerVersion(VersionRequest request, ServerCallContext context)
        {
            <span style="color:#66d9ef">return</span> Task.FromResult&lt;VersionResponse&gt;(
                <span style="color:#66d9ef">new</span> VersionResponse()
                {
                    Name = <span style="color:#e6db74">&#34;My Sample Service&#34;</span>,
                    Version = <span style="color:#e6db74">&#34;0.0.1.19&#34;</span>
                });
        }

        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">async</span> Task SayHello(HelloRequest request, IServerStreamWriter&lt;HelloResponse&gt; responseStream, ServerCallContext context)
        {
            <span style="color:#66d9ef">string</span>[] hellos = { <span style="color:#e6db74">&#34;你好&#34;</span>, <span style="color:#e6db74">&#34;Hello&#34;</span>, <span style="color:#e6db74">&#34;Hola&#34;</span>, <span style="color:#e6db74">&#34;Bonjour&#34;</span>, <span style="color:#e6db74">&#34;こんにちは&#34;</span>, <span style="color:#e6db74">&#34;hallo&#34;</span> };

            <span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">string</span> item <span style="color:#66d9ef">in</span> hellos)
            {
                <span style="color:#66d9ef">await</span> responseStream.WriteAsync(<span style="color:#66d9ef">new</span> HelloResponse() { Message = <span style="color:#e6db74">$&#34;{item} {request.Name}&#34;</span> });
            }
        }
    }
}
</code></pre></div><p>编写服务启动程序</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">namespace</span> server
{
    <span style="color:#66d9ef">using</span> Grpc.Core;
    <span style="color:#66d9ef">using</span> kira.Interface;

    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Program</span>
    {
        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Main(<span style="color:#66d9ef">string</span>[] args)
        {
            Server myServer = <span style="color:#66d9ef">new</span> Server()
            {
                Services = { SampleService.BindService(<span style="color:#66d9ef">new</span> MySampleService()) },
                Ports = { <span style="color:#66d9ef">new</span> ServerPort(<span style="color:#e6db74">&#34;localhost&#34;</span>, <span style="color:#ae81ff">10240</span>, ServerCredentials.Insecure) }
            };
            myServer.Start();

            System.Console.WriteLine(<span style="color:#e6db74">&#34;Sample Server listening on localhost:10240 \nPress any key exit...&#34;</span>);
            System.Console.ReadKey();

            myServer.ShutdownAsync().Wait();
        }
    }
}
</code></pre></div><h2 id="客户端程序">客户端程序</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">namespace</span> client
{
    <span style="color:#66d9ef">using</span> System.Threading.Tasks;
    <span style="color:#66d9ef">using</span> Grpc.Core;
    <span style="color:#66d9ef">using</span> kira.Interface;

    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Program</span>
    {
        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Main(<span style="color:#66d9ef">string</span>[] args)
        {
            Program program = <span style="color:#66d9ef">new</span> Program();

            program.TestService();

            System.Console.ReadKey();
        }

        <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">void</span> TestService()
        {
            Channel channel = <span style="color:#66d9ef">new</span> Channel(<span style="color:#e6db74">&#34;localhost:10240&#34;</span>, ChannelCredentials.Insecure);

            SampleService.SampleServiceClient cli = <span style="color:#66d9ef">new</span> SampleService.SampleServiceClient(channel);

            VersionResponse ver = cli.ServerVersion(<span style="color:#66d9ef">new</span> VersionRequest());
            System.Console.WriteLine(<span style="color:#e6db74">&#34;Remote Service Version: {0} - v{1}&#34;</span>, ver.Name, ver.Version);

            AsyncServerStreamingCall&lt;HelloResponse&gt; greetings = cli.SayHello(<span style="color:#66d9ef">new</span> HelloRequest() { Name = <span style="color:#e6db74">&#34;gRPC&#34;</span> });
            IAsyncStreamReader&lt;HelloResponse&gt; stream = greetings.ResponseStream;

            <span style="color:#66d9ef">while</span> (<span style="color:#66d9ef">await</span> stream.MoveNext())
            {
                System.Console.WriteLine(stream.Current.Message);
            }
        }
    }
}
</code></pre></div><h2 id="运行测试">运行测试</h2>
<p>首先启动服务端程序，然后运行客户端程序，可以看到客户端输出</p>
<pre><code>Remote Service Version: My Sample Service - v0.0.1.19
你好 gRPC
Hello gRPC
Hola gRPC
Bonjour gRPC
こんにちは gRPC
hallo gRPC
</code></pre><p>OK，大功告成！</p>

  </div>

  <footer>
    <hr class="end-line">

    

    
    <div class="post-tags">
      <i class="fas fa-tags"></i>
      
        <a href="/tags/C">C#</a>
        &nbsp;
      
        <a href="/tags/%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1">进程通信</a>
        &nbsp;
      
    </div>
    

    
    
    <div class="releated-posts">
      <h3>Related Posts</h3>
      
      <i class="fas fa-paperclip"></i>
      <a href="/post/WPF%E5%92%8CMFC%E8%BF%9B%E7%A8%8B%E9%97%B4%E4%BC%A0%E9%80%92%E6%95%B0%E6%8D%AE/">WPF和MFC进程间传递数据</a>
      <br>
      
      <i class="fas fa-paperclip"></i>
      <a href="/post/WPF%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86Windows%E6%B6%88%E6%81%AF/">WPF如何处理Windows消息</a>
      <br>
      
    </div>
    
  </footer>

  <div class="comments">



  <div class="comments-item comments-valine" >
    
    
    
    <div id="vcomments"></div>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
    <script type="text/javascript">
      new Valine({
          el: '#vcomments',
          highlight: false,
          lang: "zh-CN",
          appId: "X8gbfFnXlzbwF0YQQ91rSogz-gzGzoHsz",
          appKey: "ljO0GYMaeqs5KWK2vCtk1Ii8",
          placeholder: "在这里写下你的留言丨支持 Markdown 语法",
          requiredFields: ["nick","mail"],
          avatar: "mp",
          visitor:  true ,
          recordIP: true
      });
    </script>
    <script>
      if(window.location.hash){
          var checkExist = setInterval(function() {
             if ($(window.location.hash).length) {
                $('html, body, article').animate({scrollTop: $(window.location.hash).offset().top-90}, 1000);
                clearInterval(checkExist);
             }
          }, 100);
      }
    </script>
  </div>

</div>

</article>


</body>
<div class="foot">
  
  
    &copy; 2019 - 2020 &#183; 
    <a href="/">kira-96</a> · Theme <a href="https://github.com/RainerChiang/simpleness">Simpleness</a>|Powered by <a href="https://gohugo.io/">Hugo</a> &#183;
    <a href="#"><i class="fas fa-chevron-up"></i></a>
  

  
</div>

<script src="/js/lazyload.min.js"></script>
<script>
  var lazyImage = new LazyLoad({
    container: document.getElementById('article')
  });
</script>


</html>
