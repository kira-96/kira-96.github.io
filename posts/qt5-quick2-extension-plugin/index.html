<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Qt5编写Qt Quick2插件 | ✨kiraの博客</title>
<meta name=keywords content="Qt,QML"><meta name=description content="使用Qt5编写Qt Quick2插件遇到的问题记录"><meta name=author content><link rel=canonical href=https://kira-96.github.io/posts/qt5-quick2-extension-plugin/><link crossorigin=anonymous href=/assets/css/stylesheet.026333dcafeaf3c82b8515026af0a6531c530abffdaf73d32779337b0ace14c0.css integrity="sha256-AmMz3K/q88grhRUCavCmUxxTCr/9r3PTJ3kzewrOFMA=" rel="preload stylesheet" as=style><link rel=icon href=https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/favicon-32x32.png><link rel=apple-touch-icon href=https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/icons/apple-icon-180x180.png><link rel=mask-icon href=https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/icons/apple-icon-76x76.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://kira-96.github.io/posts/qt5-quick2-extension-plugin/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=manifest href=https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/manifest.json><script src=https://fastly.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js></script><script type=text/javascript src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><meta property="og:url" content="https://kira-96.github.io/posts/qt5-quick2-extension-plugin/"><meta property="og:site_name" content="✨kiraの博客"><meta property="og:title" content="Qt5编写Qt Quick2插件"><meta property="og:description" content="使用Qt5编写Qt Quick2插件遇到的问题记录"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-03-13T10:23:47+08:00"><meta property="article:modified_time" content="2025-03-23T10:55:52+08:00"><meta property="article:tag" content="Qt"><meta property="article:tag" content="QML"><meta name=twitter:card content="summary"><meta name=twitter:title content="Qt5编写Qt Quick2插件"><meta name=twitter:description content="使用Qt5编写Qt Quick2插件遇到的问题记录"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://kira-96.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Qt5编写Qt Quick2插件","item":"https://kira-96.github.io/posts/qt5-quick2-extension-plugin/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Qt5编写Qt Quick2插件","name":"Qt5编写Qt Quick2插件","description":"使用Qt5编写Qt Quick2插件遇到的问题记录","keywords":["Qt","QML"],"articleBody":"前言 最近在试着把自定义的QML控件封装成插件供其他程序调用，由于我使用的还是Qt5，在构建的过程中遇到不少问题，这里做一下简单汇总。\n新建项目 新建库→Qt Quick2 Extension Plugin，Qt 5版本仅支持使用QMake作为构建套件。Qt 6才支持使用CMake作为QML扩展插件的构建套件。\n编写插件 例如，我新建了一个叫做Test的插件库，项目会自动创建一个TestPlugin的类，这个类继承自QQmlExtensionPlugin，我们需要重写它的两个虚函数。\n1 2 3 4 5 6 7 8 9 10 11 12 /* testplugin.h */ #include class TestPlugin : public QQmlExtensionPlugin { Q_OBJECT Q_PLUGIN_METADATA(IID QQmlExtensionInterface_iid) public: void registerTypes(const char *uri) Q_DECL_OVERRIDE; void initializeEngine(QQmlEngine *engine, const char *uri) Q_DECL_OVERRIDE; }; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 /* testplugin.cpp */ #include \"testplugin.h\" #include \"myitem.h\" #include void TestPlugin::registerTypes(const char *uri) { // @uri com.mycompany.qmlcomponents qmlRegisterType\u003cMyItem\u003e(uri, 1, 0, \"MyItem\"); } void TestPlugin::initializeEngine(QQmlEngine *engine, const char *uri) { QQmlExtensionPlugin::initializeEngine(engine, uri); } 其中，MyItem就是我们自定义的控件。简单看一下示例代码：\n1 2 3 4 5 6 7 8 9 10 11 12 13 /*myitem.h*/ #include class MyItem : public QQuickPaintedItem { Q_OBJECT QML_ELEMENT Q_DISABLE_COPY(MyItem) public: explicit MyItem(QQuickItem *parent = Q_NULLPTR); void paint(QPainter *painter) Q_DECL_OVERRIDE; ~MyItem() Q_DECL_OVERRIDE; }; MyItem继承自QQuickItem，并使用QML_ELEMENT声明了它是一个QML元素，最后再使用qmlRegisterType注册。这样MyItem就可以在QML中使用了。\n使用这种方式也可以注册继承自QObject的类。例如：\n1 2 3 4 5 6 7 8 /* myobject.h */ class MyObject : public QObject { Q_OBJECT Q_DISABLE_COPY(MyObject) public: explicit MyObject(QObject *parent = Q_NULLPTR); }; 然后在Plugin类中进行注册：\n1 2 3 4 5 6 7 /* testplugin.cpp */ void TestPlugin::registerTypes(const char *uri) { // @uri com.mycompany.qmlcomponents qmlRegisterType\u003cMyItem\u003e(uri, 1, 0, \"MyItem\"); qmlRegisterType\u003cMyObject\u003e(uri, 1, 0, \"MyObject\"); } 自定义QML控件 QML插件库当然也可以封装.qml的自定义插件。例如：\n1 2 3 4 5 6 7 8 9 10 11 12 13 /* MyLabel.qml */ import QtQuick 2.15 import QtQuick.Controls 2.15 Label { id: control property string backgroundColor background: Rectangle { color: backgroundColor } } 把自定义的qml控件添加到资源文件，然后可以在Plugin类中进行注册。\n1 2 3 4 5 6 7 8 9 10 11 /* testplugin.cpp */ void TestPlugin::registerTypes(const char *uri) { // @uri com.mycompany.qmlcomponents qmlRegisterType\u003cMyItem\u003e(uri, 1, 0, \"MyItem\"); qmlRegisterType\u003cMyObject\u003e(uri, 1, 0, \"MyObject\"); // register qml types qmlRegisterType(QUrl(\"qrc:/qml/MyLabel.qml\"), uri, MAJOR, MINOR, \"MyLabel\"); } qmldir文件 qmldir文件用于QML插件模块管理，描述了qml插件的基本信息。示例：\n1 2 3 4 5 6 module com.mycompany.qmlcomponents plugin testplugin classname TestPlugin typeinfo plugins.qmltypes designersupported depends QtQuick.Controls 2.12 module 和插件的uri配置相同 plugin 插件文件名字，通常是小写 classname 插件类的名字 typeinfo 插件的元数据文件，稍后会写怎么生成这个文件 项目文件配置 下面是我的一个项目配置，包含插件信息配置，和生成元数据的自定义命令。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 ## TestPlugin.pro TEMPLATE = lib TARGET = testplugin QT += core qml quick CONFIG += plugin c++11 # CONFIG += qmltypes # 插件的URI uri = com.mycompany.qmlcomponents QML_PLUGIN_NAME = $$TARGET # 可以通过 import 的方式在qml中使用插件中的控件 QML_IMPORT_NAME = $$uri # 插件的版本号 QML_IMPORT_MAJOR_VERSION = 1 QML_IMPORT_MINOR_VERSION = 0 # 生成插件的路径 DESTDIR = imports/$$replace(QML_IMPORT_NAME, \\., $$QMAKE_DIR_SEP) QMLTYPES_FILENAME = $$DESTDIR/plugins.qmltypes TARGET = $$qtLibraryTarget($$TARGET) HEADERS += ... SOURCES += ... # 拷贝qmldir文件到输出目录 DISTFILES = qmldir !equals(_PRO_FILE_PWD_, $$OUT_PWD) { copy_qmldir.target = $$DESTDIR/qmldir copy_qmldir.depends = $$_PRO_FILE_PWD_/qmldir copy_qmldir.commands = $(COPY_FILE) \"$$replace(copy_qmldir.depends, /, $$QMAKE_DIR_SEP)\" \"$$replace(copy_qmldir.target, /, $$QMAKE_DIR_SEP)\" QMAKE_EXTRA_TARGETS += copy_qmldir PRE_TARGETDEPS += $$copy_qmldir.target } # 添加构建后生成元数据的自定义命令 qmltypes.commands = $$[QT_INSTALL_PREFIX]/bin/qmlplugindump -nonrelocatable $$QML_IMPORT_NAME \"$${QML_IMPORT_MAJOR_VERSION}.$${QML_IMPORT_MINOR_VERSION}\" $$OUT_PWD/imports \u003e $$OUT_PWD/$$DESTDIR/plugins.qmltypes qmltypes.depends = $$QML_PLUGIN_NAME.target QMAKE_EXTRA_TARGETS += qmltypes # 确保构建后执行元数据生成 # POST_TARGETDEPS += $$QML_PLUGIN_NAME POST_TARGETDEPS += qmltypes 这里有几点需要注意的：\n有资料说加入 CONFIG += qmltypes 配置就可以自动生成插件元数据信息，这点我测试确实可以，但生成的元数据是不完整的。这个配置只能生成使用了QML_ELEMENT宏的类，无法生成QObject类和QML控件的元数据，基本上无用。 生成元数据必须使用qmlplugindump工具，这个工具和qmake在同一个目录下。 qmlplugindump工具的使用 这里使用的命令如下：\nqmlplugindump -nonrelocatable QML导入URI 插件版本 插件目录 \u003e 生成plugins.qmltypes路径\nQML导入URI：编译插件时指定的uri，如：com.mycompany.qmlcomponents 插件本本：编译插件时指定的版本，如：1.0 插件目录：这个需要特别注意，这个指的是插件的目录，不是插件库的目录。比如我生成的插件是在imports目录，构建套件会根据插件的uri自动生成插件库的目录，如：imports/com/mycompany/qmlcomponents/testplugin.so，那么这里应该传入参数/path/to/imports，不要传入插件库所在的目录。 生成plugins.qmltypes路径：这个没什么好解释的，但注意plugins.qmltypes需要和插件库放在统一目录，所以这里最后传入参数/path/to/imports/com/mycompany/qmlcomponents/plugins.qmltypes。 注意：\nqmldir文件和生成的插件需要放到同一目录下，否则qmlplugindump读不到插件信息。 如果生成的插件依赖其他动态库，一定要确保qmlplugindump能找到这些库，否则插件无法加载就不能生成元数据。 问题：\nplugin cannot be loaded for module “com.mycompany.qmlcomponents”: Cannot load library testplugin.dll: 找不到指定的模块。(检查动态库的路径，可尝试添加到环境变量) QQmlComponent: Component is not ready file:///path/to/imports/com/mycompany/qmlcomponents/qmldir: plugin cannot be loaded for module “”: Module namespace ‘com.mycompany.qmlcomponents’ does not match import URI ’’ (检查传入参数的插件目录是否正确？) 使用QML插件 确保插件目录中包含以下几个文件：testplugin.so、plugins.qmltypes、qmldir。 将插件目录添加到Qml Emgine的导入目录列表： 1 2 3 4 5 6 7 /* main.cpp */ QGuiApplication app(argc, argv); QQmlApplicationEngine engine(\u0026app); ... // 添加插件路径到导入目录列表 engine.addImportPath(\"imports\"); engine.load(url); 在qml中导入、使用自定义控件 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 /* main.qml */ import com.mycompany.qmlcomponents 1.0 Window { id: window width: 640 height: 480 visible: true title: qsTr(\"Hello World\") // @disable-check M16 MyItem { id: myitem } MyLabel { id: mylabel text: qsTr(\"Hello World\") backgroundColor: 'red' } } 如何使用插件中的静态函数？ 这里需要对静态函数做一下封装。例如，我定义了一个静态函数：\n1 2 3 4 5 6 7 8 9 /* myutils.h */ class MyUtils { public: static void myFunc() { printf(\"Hello from myFunc().\"); } }; 这里需要定义一个插件的Helper类，然后在插件里面注册这个类，在这个类里面实现静态函数调用。例如：\n1 2 3 4 5 6 7 8 9 10 11 12 13 /* testpluginhelper.h */ #include #include \"myutils.h\" class TestPluginHelper : public QObject { Q_OBJECT public: Q_INVOKABLE void callMyFunc() { MyUtils::myFunc(); } }; 1 2 3 4 5 6 7 /* testplugin.cpp */ void TestPlugin::initializeEngine(QQmlEngine *engine, const char *uri) { QQmlExtensionPlugin::initializeEngine(engine, uri); // 注册对象到上下文 engine-\u003erootContext()-\u003esetContextProperty(\"testPluginHelper\", new TestPluginHelper); } 在QML中调用：\n1 2 3 4 5 6 7 Item { id: item Component.onCompleted: { testPluginHelper.callMyFunc() } } ","wordCount":"711","inLanguage":"zh","datePublished":"2025-03-13T10:23:47+08:00","dateModified":"2025-03-23T10:55:52+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://kira-96.github.io/posts/qt5-quick2-extension-plugin/"},"publisher":{"@type":"Organization","name":"✨kiraの博客","logo":{"@type":"ImageObject","url":"https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://kira-96.github.io/ accesskey=h title="✨kiraの博客 (Alt + H)">✨kiraの博客</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://kira-96.github.io/ title=🏠主页><span>🏠主页</span></a></li><li><a href=https://kira-96.github.io/notes/ title=📓笔记><span>📓笔记</span></a></li><li><a href=https://kira-96.github.io/search/ title=🔍️搜索><span>🔍️搜索</span></a></li><li><a href=https://kira-96.github.io/archives/ title=🗃️存档><span>🗃️存档</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://kira-96.github.io/>主页</a>&nbsp;»&nbsp;<a href=https://kira-96.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Qt5编写Qt Quick2插件</h1><div class=post-description>使用Qt5编写Qt Quick2插件遇到的问题记录</div><div class=post-meta><span title='2025-03-13 10:23:47 +0800 +0800'>三月 13, 2025</span>&nbsp;·&nbsp;4 分钟&nbsp;·&nbsp;711 字&nbsp;|&nbsp;<a href=https://github.com/kira-96/kira-96.github.io/tree/main/content/posts/ rel="noopener noreferrer" target=_blank>✏️编辑</a></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e5%89%8d%e8%a8%80 aria-label=前言>前言</a></li><li><a href=#%e6%96%b0%e5%bb%ba%e9%a1%b9%e7%9b%ae aria-label=新建项目>新建项目</a></li><li><a href=#%e7%bc%96%e5%86%99%e6%8f%92%e4%bb%b6 aria-label=编写插件>编写插件</a></li><li><a href=#%e8%87%aa%e5%ae%9a%e4%b9%89qml%e6%8e%a7%e4%bb%b6 aria-label=自定义QML控件>自定义QML控件</a></li><li><a href=#qmldir%e6%96%87%e4%bb%b6 aria-label=qmldir文件>qmldir文件</a></li><li><a href=#%e9%a1%b9%e7%9b%ae%e6%96%87%e4%bb%b6%e9%85%8d%e7%bd%ae aria-label=项目文件配置>项目文件配置</a></li><li><a href=#qmlplugindump%e5%b7%a5%e5%85%b7%e7%9a%84%e4%bd%bf%e7%94%a8 aria-label=qmlplugindump工具的使用>qmlplugindump工具的使用</a></li><li><a href=#%e4%bd%bf%e7%94%a8qml%e6%8f%92%e4%bb%b6 aria-label=使用QML插件>使用QML插件</a></li><li><a href=#%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8%e6%8f%92%e4%bb%b6%e4%b8%ad%e7%9a%84%e9%9d%99%e6%80%81%e5%87%bd%e6%95%b0 aria-label=如何使用插件中的静态函数？>如何使用插件中的静态函数？</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=前言>前言<a hidden class=anchor aria-hidden=true href=#前言>#</a></h2><p>最近在试着把自定义的QML控件封装成插件供其他程序调用，由于我使用的还是Qt5，在构建的过程中遇到不少问题，这里做一下简单汇总。</p><h2 id=新建项目>新建项目<a hidden class=anchor aria-hidden=true href=#新建项目>#</a></h2><p>新建<em>库→Qt Quick2 Extension Plugin</em>，<code>Qt 5</code>版本仅支持使用<code>QMake</code>作为构建套件。<code>Qt 6</code>才支持使用<code>CMake</code>作为QML扩展插件的构建套件。</p><h2 id=编写插件>编写插件<a hidden class=anchor aria-hidden=true href=#编写插件>#</a></h2><p>例如，我新建了一个叫做<code>Test</code>的插件库，项目会自动创建一个<code>TestPlugin</code>的类，这个类继承自<code>QQmlExtensionPlugin</code>，我们需要重写它的两个虚函数。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cm>/* testplugin.h */</span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;QQmlExtensionPlugin&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TestPlugin</span> <span class=o>:</span> <span class=k>public</span> <span class=n>QQmlExtensionPlugin</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Q_OBJECT</span>
</span></span><span class=line><span class=cl>    <span class=nf>Q_PLUGIN_METADATA</span><span class=p>(</span><span class=n>IID</span> <span class=n>QQmlExtensionInterface_iid</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=n>registerTypes</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>uri</span><span class=p>)</span> <span class=n>Q_DECL_OVERRIDE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>initializeEngine</span><span class=p>(</span><span class=n>QQmlEngine</span> <span class=o>*</span><span class=n>engine</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>uri</span><span class=p>)</span> <span class=n>Q_DECL_OVERRIDE</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cm>/* testplugin.cpp */</span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;testplugin.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;myitem.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;qqml.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=n>TestPlugin</span><span class=o>::</span><span class=n>registerTypes</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// @uri com.mycompany.qmlcomponents
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>qmlRegisterType</span><span class=o>&lt;</span><span class=n>MyItem</span><span class=o>&gt;</span><span class=p>(</span><span class=n>uri</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;MyItem&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=n>TestPlugin</span><span class=o>::</span><span class=n>initializeEngine</span><span class=p>(</span><span class=n>QQmlEngine</span> <span class=o>*</span><span class=n>engine</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>QQmlExtensionPlugin</span><span class=o>::</span><span class=n>initializeEngine</span><span class=p>(</span><span class=n>engine</span><span class=p>,</span> <span class=n>uri</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>其中，<code>MyItem</code>就是我们自定义的控件。简单看一下示例代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cm>/*myitem.h*/</span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;QtQuick/QQuickPaintedItem&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MyItem</span> <span class=o>:</span> <span class=k>public</span> <span class=n>QQuickPaintedItem</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Q_OBJECT</span>
</span></span><span class=line><span class=cl>    <span class=n>QML_ELEMENT</span>
</span></span><span class=line><span class=cl>    <span class=nf>Q_DISABLE_COPY</span><span class=p>(</span><span class=n>MyItem</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=k>explicit</span> <span class=n>MyItem</span><span class=p>(</span><span class=n>QQuickItem</span> <span class=o>*</span><span class=n>parent</span> <span class=o>=</span> <span class=n>Q_NULLPTR</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>paint</span><span class=p>(</span><span class=n>QPainter</span> <span class=o>*</span><span class=n>painter</span><span class=p>)</span> <span class=n>Q_DECL_OVERRIDE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>~</span><span class=n>MyItem</span><span class=p>()</span> <span class=n>Q_DECL_OVERRIDE</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p><code>MyItem</code>继承自<code>QQuickItem</code>，并使用<code>QML_ELEMENT</code>声明了它是一个QML元素，最后再使用<code>qmlRegisterType</code>注册。这样<code>MyItem</code>就可以在QML中使用了。</p><p>使用这种方式也可以注册继承自<code>QObject</code>的类。例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cm>/* myobject.h */</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MyObject</span> <span class=o>:</span> <span class=k>public</span> <span class=n>QObject</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Q_OBJECT</span>
</span></span><span class=line><span class=cl>    <span class=nf>Q_DISABLE_COPY</span><span class=p>(</span><span class=n>MyObject</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=k>explicit</span> <span class=n>MyObject</span><span class=p>(</span><span class=n>QObject</span> <span class=o>*</span><span class=n>parent</span> <span class=o>=</span> <span class=n>Q_NULLPTR</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>然后在<code>Plugin</code>类中进行注册：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cm>/* testplugin.cpp */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=n>TestPlugin</span><span class=o>::</span><span class=n>registerTypes</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// @uri com.mycompany.qmlcomponents
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>qmlRegisterType</span><span class=o>&lt;</span><span class=n>MyItem</span><span class=o>&gt;</span><span class=p>(</span><span class=n>uri</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;MyItem&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>qmlRegisterType</span><span class=o>&lt;</span><span class=n>MyObject</span><span class=o>&gt;</span><span class=p>(</span><span class=n>uri</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;MyObject&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=自定义qml控件>自定义QML控件<a hidden class=anchor aria-hidden=true href=#自定义qml控件>#</a></h2><p>QML插件库当然也可以封装<code>.qml</code>的自定义插件。例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-qml data-lang=qml><span class=line><span class=cl><span class=cm>/* MyLabel.qml */</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>QtQuick</span> <span class=mf>2.15</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>QtQuick</span><span class=p>.</span><span class=nx>Controls</span> <span class=mf>2.15</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Label</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>id: control</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>property</span> <span class=nx>string</span> <span class=nx>backgroundColor</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>background:</span> <span class=nx>Rectangle</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>color:</span> <span class=nx>backgroundColor</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>把自定义的qml控件添加到资源文件，然后可以在<code>Plugin</code>类中进行注册。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cm>/* testplugin.cpp */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=n>TestPlugin</span><span class=o>::</span><span class=n>registerTypes</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// @uri com.mycompany.qmlcomponents
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>qmlRegisterType</span><span class=o>&lt;</span><span class=n>MyItem</span><span class=o>&gt;</span><span class=p>(</span><span class=n>uri</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;MyItem&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>qmlRegisterType</span><span class=o>&lt;</span><span class=n>MyObject</span><span class=o>&gt;</span><span class=p>(</span><span class=n>uri</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;MyObject&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// register qml types
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>qmlRegisterType</span><span class=p>(</span><span class=n>QUrl</span><span class=p>(</span><span class=s>&#34;qrc:/qml/MyLabel.qml&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=n>uri</span><span class=p>,</span> <span class=n>MAJOR</span><span class=p>,</span> <span class=n>MINOR</span><span class=p>,</span> <span class=s>&#34;MyLabel&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=qmldir文件>qmldir文件<a hidden class=anchor aria-hidden=true href=#qmldir文件>#</a></h2><p><code>qmldir</code>文件用于QML插件模块管理，描述了qml插件的基本信息。示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>module com.mycompany.qmlcomponents
</span></span><span class=line><span class=cl>plugin testplugin
</span></span><span class=line><span class=cl>classname TestPlugin
</span></span><span class=line><span class=cl>typeinfo plugins.qmltypes
</span></span><span class=line><span class=cl>designersupported
</span></span><span class=line><span class=cl>depends QtQuick.Controls 2.12
</span></span></code></pre></td></tr></table></div></div><ul><li><code>module</code> 和插件的uri配置相同</li><li><code>plugin</code> 插件文件名字，通常是小写</li><li><code>classname</code> 插件类的名字</li><li><code>typeinfo</code> 插件的元数据文件，稍后会写怎么生成这个文件</li></ul><h2 id=项目文件配置>项目文件配置<a hidden class=anchor aria-hidden=true href=#项目文件配置>#</a></h2><p>下面是我的一个项目配置，包含插件信息配置，和<strong>生成元数据的自定义命令</strong>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1>## TestPlugin.pro</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>TEMPLATE</span> <span class=o>=</span> lib
</span></span><span class=line><span class=cl><span class=nv>TARGET</span> <span class=o>=</span> testplugin
</span></span><span class=line><span class=cl><span class=nv>QT</span> <span class=o>+=</span> core qml quick
</span></span><span class=line><span class=cl><span class=nv>CONFIG</span> <span class=o>+=</span> plugin c++11
</span></span><span class=line><span class=cl><span class=c1># CONFIG += qmltypes</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 插件的URI</span>
</span></span><span class=line><span class=cl><span class=nv>uri</span> <span class=o>=</span> com.mycompany.qmlcomponents
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>QML_PLUGIN_NAME</span> <span class=o>=</span> <span class=nv>$$</span>TARGET
</span></span><span class=line><span class=cl><span class=c1># 可以通过 import 的方式在qml中使用插件中的控件</span>
</span></span><span class=line><span class=cl><span class=nv>QML_IMPORT_NAME</span> <span class=o>=</span> <span class=nv>$$</span>uri
</span></span><span class=line><span class=cl><span class=c1># 插件的版本号</span>
</span></span><span class=line><span class=cl><span class=nv>QML_IMPORT_MAJOR_VERSION</span> <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=nv>QML_IMPORT_MINOR_VERSION</span> <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=c1># 生成插件的路径</span>
</span></span><span class=line><span class=cl><span class=nv>DESTDIR</span> <span class=o>=</span> imports/<span class=nv>$$</span>replace<span class=o>(</span>QML_IMPORT_NAME, <span class=se>\.</span>, <span class=nv>$$</span>QMAKE_DIR_SEP<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nv>QMLTYPES_FILENAME</span> <span class=o>=</span> <span class=nv>$$</span>DESTDIR/plugins.qmltypes
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>TARGET</span> <span class=o>=</span> <span class=nv>$$</span>qtLibraryTarget<span class=o>(</span><span class=nv>$$</span>TARGET<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>HEADERS</span> <span class=o>+=</span> ...
</span></span><span class=line><span class=cl><span class=nv>SOURCES</span> <span class=o>+=</span> ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 拷贝qmldir文件到输出目录</span>
</span></span><span class=line><span class=cl><span class=nv>DISTFILES</span> <span class=o>=</span> qmldir
</span></span><span class=line><span class=cl>!equals<span class=o>(</span>_PRO_FILE_PWD_, <span class=nv>$$</span>OUT_PWD<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    copy_qmldir.target <span class=o>=</span> <span class=nv>$$</span>DESTDIR/qmldir
</span></span><span class=line><span class=cl>    copy_qmldir.depends <span class=o>=</span> <span class=nv>$$</span>_PRO_FILE_PWD_/qmldir
</span></span><span class=line><span class=cl>    copy_qmldir.commands <span class=o>=</span> <span class=k>$(</span>COPY_FILE<span class=k>)</span> <span class=s2>&#34;</span><span class=nv>$$</span><span class=s2>replace(copy_qmldir.depends, /, </span><span class=nv>$$</span><span class=s2>QMAKE_DIR_SEP)&#34;</span> <span class=s2>&#34;</span><span class=nv>$$</span><span class=s2>replace(copy_qmldir.target, /, </span><span class=nv>$$</span><span class=s2>QMAKE_DIR_SEP)&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nv>QMAKE_EXTRA_TARGETS</span> <span class=o>+=</span> copy_qmldir
</span></span><span class=line><span class=cl>    <span class=nv>PRE_TARGETDEPS</span> <span class=o>+=</span> <span class=nv>$$</span>copy_qmldir.target
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 添加构建后生成元数据的自定义命令</span>
</span></span><span class=line><span class=cl>qmltypes.commands <span class=o>=</span> <span class=nv>$$</span><span class=o>[</span>QT_INSTALL_PREFIX<span class=o>]</span>/bin/qmlplugindump -nonrelocatable <span class=nv>$$</span>QML_IMPORT_NAME <span class=s2>&#34;</span><span class=nv>$$</span><span class=s2>{QML_IMPORT_MAJOR_VERSION}.</span><span class=nv>$$</span><span class=s2>{QML_IMPORT_MINOR_VERSION}&#34;</span> <span class=nv>$$</span>OUT_PWD/imports &gt; <span class=nv>$$</span>OUT_PWD/<span class=nv>$$</span>DESTDIR/plugins.qmltypes
</span></span><span class=line><span class=cl>qmltypes.depends <span class=o>=</span> <span class=nv>$$</span>QML_PLUGIN_NAME.target
</span></span><span class=line><span class=cl><span class=nv>QMAKE_EXTRA_TARGETS</span> <span class=o>+=</span> qmltypes
</span></span><span class=line><span class=cl><span class=c1># 确保构建后执行元数据生成</span>
</span></span><span class=line><span class=cl><span class=c1># POST_TARGETDEPS += $$QML_PLUGIN_NAME</span>
</span></span><span class=line><span class=cl><span class=nv>POST_TARGETDEPS</span> <span class=o>+=</span> qmltypes
</span></span></code></pre></td></tr></table></div></div><p>这里有几点需要注意的：</p><ul><li>有资料说加入 <code>CONFIG += qmltypes</code> 配置就可以自动生成插件元数据信息，这点我测试确实可以，但生成的元数据是不完整的。这个配置只能生成使用了<code>QML_ELEMENT</code>宏的类，无法生成<code>QObject</code>类和<code>QML</code>控件的元数据，基本上无用。</li><li>生成元数据必须使用<code>qmlplugindump</code>工具，这个工具和<code>qmake</code>在同一个目录下。</li></ul><h2 id=qmlplugindump工具的使用>qmlplugindump工具的使用<a hidden class=anchor aria-hidden=true href=#qmlplugindump工具的使用>#</a></h2><p>这里使用的命令如下：</p><p><code>qmlplugindump -nonrelocatable QML导入URI 插件版本 插件目录 > 生成plugins.qmltypes路径</code></p><ul><li>QML导入URI：编译插件时指定的uri，如：com.mycompany.qmlcomponents</li><li>插件本本：编译插件时指定的版本，如：1.0</li><li><strong>插件目录</strong>：这个需要特别注意，这个指的是插件的目录，不是插件库的目录。比如我生成的插件是在<code>imports</code>目录，构建套件会根据插件的uri自动生成插件库的目录，如：<code>imports/com/mycompany/qmlcomponents/testplugin.so</code>，那么这里应该传入参数<code>/path/to/imports</code>，不要传入插件库所在的目录。</li><li>生成plugins.qmltypes路径：这个没什么好解释的，但注意<code>plugins.qmltypes</code>需要和插件库放在统一目录，所以这里最后传入参数<code>/path/to/imports/com/mycompany/qmlcomponents/plugins.qmltypes</code>。</li></ul><p>注意：</p><ol><li>qmldir文件和生成的插件需要放到同一目录下，否则<code>qmlplugindump</code>读不到插件信息。</li><li>如果生成的插件依赖其他动态库，一定要确保<code>qmlplugindump</code>能找到这些库，否则插件无法加载就不能生成元数据。</li></ol><p>问题：</p><ol><li>plugin cannot be loaded for module &ldquo;com.mycompany.qmlcomponents&rdquo;: Cannot load library testplugin.dll: 找不到指定的模块。(检查动态库的路径，可尝试添加到环境变量)</li><li>QQmlComponent: Component is not ready
file:///path/to/imports/com/mycompany/qmlcomponents/qmldir: plugin cannot be loaded for module &ldquo;&rdquo;: Module namespace &lsquo;com.mycompany.qmlcomponents&rsquo; does not match import URI &rsquo;&rsquo;
(检查传入参数的<em>插件目录</em>是否正确？)</li></ol><h2 id=使用qml插件>使用QML插件<a hidden class=anchor aria-hidden=true href=#使用qml插件>#</a></h2><ol><li>确保插件目录中包含以下几个文件：testplugin.so、plugins.qmltypes、qmldir。</li><li>将插件目录添加到Qml Emgine的导入目录列表：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cm>/* main.cpp */</span>
</span></span><span class=line><span class=cl><span class=n>QGuiApplication</span> <span class=nf>app</span><span class=p>(</span><span class=n>argc</span><span class=p>,</span> <span class=n>argv</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>QQmlApplicationEngine</span> <span class=nf>engine</span><span class=p>(</span><span class=o>&amp;</span><span class=n>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=c1>// 添加插件路径到导入目录列表
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>engine</span><span class=p>.</span><span class=n>addImportPath</span><span class=p>(</span><span class=s>&#34;imports&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>engine</span><span class=p>.</span><span class=n>load</span><span class=p>(</span><span class=n>url</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><ol start=3><li>在qml中导入、使用自定义控件</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-qml data-lang=qml><span class=line><span class=cl><span class=cm>/* main.qml */</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>com</span><span class=p>.</span><span class=nx>mycompany</span><span class=p>.</span><span class=nx>qmlcomponents</span> <span class=mf>1.0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Window</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>id: window</span>
</span></span><span class=line><span class=cl>  <span class=k>width:</span> <span class=mi>640</span>
</span></span><span class=line><span class=cl>  <span class=k>height:</span> <span class=mi>480</span>
</span></span><span class=line><span class=cl>  <span class=k>visible:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=k>title:</span> <span class=nx>qsTr</span><span class=p>(</span><span class=s2>&#34;Hello World&#34;</span><span class=p>)</span>  <span class=c1>// @disable-check M16
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>MyItem</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kd>id: myitem</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>MyLabel</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kd>id: mylabel</span>
</span></span><span class=line><span class=cl>      <span class=k>text:</span> <span class=nx>qsTr</span><span class=p>(</span><span class=s2>&#34;Hello World&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>backgroundColor:</span> <span class=s1>&#39;red&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=如何使用插件中的静态函数>如何使用插件中的静态函数？<a hidden class=anchor aria-hidden=true href=#如何使用插件中的静态函数>#</a></h2><p>这里需要对静态函数做一下封装。例如，我定义了一个静态函数：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cm>/* myutils.h */</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MyUtils</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=k>static</span> <span class=kt>void</span> <span class=n>myFunc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Hello from myFunc().&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>这里需要定义一个插件的Helper类，然后在插件里面注册这个类，在这个类里面实现静态函数调用。例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cm>/* testpluginhelper.h */</span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;QObject&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;myutils.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TestPluginHelper</span> <span class=o>:</span> <span class=k>public</span> <span class=n>QObject</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Q_OBJECT</span>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>Q_INVOKABLE</span> <span class=kt>void</span> <span class=n>callMyFunc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>MyUtils</span><span class=o>::</span><span class=n>myFunc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cm>/* testplugin.cpp */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=n>TestPlugin</span><span class=o>::</span><span class=n>initializeEngine</span><span class=p>(</span><span class=n>QQmlEngine</span> <span class=o>*</span><span class=n>engine</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>QQmlExtensionPlugin</span><span class=o>::</span><span class=n>initializeEngine</span><span class=p>(</span><span class=n>engine</span><span class=p>,</span> <span class=n>uri</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 注册对象到上下文
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>engine</span><span class=o>-&gt;</span><span class=n>rootContext</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>setContextProperty</span><span class=p>(</span><span class=s>&#34;testPluginHelper&#34;</span><span class=p>,</span> <span class=k>new</span> <span class=n>TestPluginHelper</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在QML中调用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-qml data-lang=qml><span class=line><span class=cl><span class=nx>Item</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>id: item</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>Component.onCompleted:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>testPluginHelper</span><span class=p>.</span><span class=nx>callMyFunc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://kira-96.github.io/tags/qt/>Qt</a></li><li><a href=https://kira-96.github.io/tags/qml/>QML</a></li></ul><nav class=paginav><a class=prev href=https://kira-96.github.io/posts/%E4%B8%AA%E4%BA%BA%E5%B8%B8%E7%94%A8%E8%BD%AF%E4%BB%B6%E5%88%86%E4%BA%AB/><span class=title>« 上一页</span><br><span>个人常用软件分享</span>
</a><a class=next href=https://kira-96.github.io/posts/qml%E6%8E%A7%E4%BB%B6%E8%AE%BF%E9%97%AEepics%E8%BF%87%E7%A8%8B%E5%8F%98%E9%87%8F%E7%9A%84%E6%80%9D%E8%B7%AF/><span class=title>下一页 »</span><br><span>QML控件访问EPICS过程变量的思路</span></a></nav></footer><script src=https://utteranc.es/client.js repo=kira-96/kira-96.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></article></main><footer class=footer><span>Copyright © 2019-2025 <a href=/>kira&rsquo;s blog</a> ·</span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>