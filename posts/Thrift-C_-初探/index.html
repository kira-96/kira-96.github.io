<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="Hugo 0.83.1" />

  <title> Thrift C# 初探 |  kira&#39;s 博客</title>
  <meta name="description" content="Thrift简单使用">
  <link rel="stylesheet" href="https://kira-96.github.io/css/simpleness.css">
  <link rel="canonical" href="https://kira-96.github.io/posts/Thrift-C_-%E5%88%9D%E6%8E%A2/">
  <link rel="alternate" type="application/rss+xml" href="" title="kira&#39;s 博客">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css">
  
  <meta name="theme-color" content="#ffffff">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Thrift C# 初探">
  <link rel="apple-touch-icon" sizes="152x152" href="https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/icons/apple-icon-180x180.png">
  <link rel="icon" href="https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/favicon.ico">
  <link rel="icon" sizes="16x16" href="https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/favicon-16x16.png">
  <link rel="icon" sizes="32x32" href="https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/favicon-32x32.png">
  <link rel="icon" sizes="96x96" href="https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/favicon-96x96.png">
  <link rel="manifest"  href="https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/manifest.json">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">
  <script defer src="https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script>
</head>


<body>
  <header class="menus">
  

  <nav >
    
    <a href="/"> Home</a>
    
    <a href="/notes/"> Notes</a>
    
  </nav>

  <nav class="fontawesome">
    
    <a href="https://github.com/kira-96/" target="_blank">
        <i title="GitHub" class="fab fa-github"></i>
    </a>
    
    
    <a href="https://kira-96.github.io/index.xml" target="_blank">
        <i title="RSS" class="fas fa-rss"></i>
    </a>
    
  </nav>
  
  
  <div class="hidden description">kira's blog</div>
  
</header>

<article class="article">
  <header>
    <h1 style="text-align: center;" >Thrift C# 初探</h1>

    <div class="post-meta">
    
      <time datetime="2019-08-19T19:51:15&#43;08:00">August 19, 2019</time> &nbsp; 
    

     &nbsp;

    
    
      <i class="far fa-eye"></i>
      <span id="/posts/Thrift-C_-%E5%88%9D%E6%8E%A2/" class="leancloud_visitors" data-flag-title="Thrift C# 初探">
          <span class="leancloud-visitors-count">  </span>
      </span> &nbsp;
    
    

    
      <i class="far fa-clock"></i>
      
      
      

      
        5 min
      
      34 s
      &nbsp;
    

    
      <i class="fas fa-folder"></i>
      
      <a href="/categories/%E7%BC%96%E7%A8%8B">编程</a>
      &nbsp;
      
    
    </div>
  </header>

   

  <div class="text">
    <h2 id="简介">简介</h2>
<p><a href="http://thrift.apache.org/">Thrift</a>是由Facebook为“大规模跨语言服务开发”而开发的一种接口描述语言和二进制通讯协议，它被用来定义和创建跨语言的服务。目前被作为一个<strong>RPC</strong>框架使用。</p>
<h2 id="下载">下载</h2>
<p>使用之前需要先<a href="http://thrift.apache.org/download">下载</a>Thrift的源代码和Thrift编译器。</p>
<p>下载源代码后解压，进入到<code>thrift-0.12.0\lib\csharp\src</code>目录下，打开<code>Thrift.sln</code>，根据需要编译相应的库，这里选择<code>Thrift.45</code>，即.NET 4.5可以使用的库，编译生成<code>Thrift45.dll</code>。</p>
<h2 id="创建项目">创建项目</h2>
<p>新建解决方案，包含3个项目</p>
<ul>
<li>
<p>ThriftSample</p>
<p>类库，Thrift生成的服务接口</p>
</li>
<li>
<p>server</p>
<p>控制台程序，服务端</p>
</li>
<li>
<p>client</p>
<p>控制台程序，客户端</p>
</li>
</ul>
<p>这3个项目都需要引用刚刚编译的<code>Thrift45.dll</code>，为什么不用Nuget来安装Thrift呢？因为我注意到Nuget上的Thrift已经好几年没更新了，还是手动编译最新的要好。</p>
<p>然后，<code>server</code>和<code>client</code>同时引用项目<code>ThriftSample</code>。</p>
<h2 id="定义服务接口">定义服务接口</h2>
<p>在解决方案目录下新建一个文件<code>Sample.thrift</code>来定义服务接口，Thrift语法可以在网上找到</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf">namespace csharp kira.Interface<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">service</span> SampleService {<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    ServiceVersion GetVersion()<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    list&lt;<span style="color:#66d9ef">string</span>&gt; SayHello(<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span> name)<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>struct ServiceVersion {<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">required</span> <span style="color:#66d9ef">string</span> name;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#ae81ff">2</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">required</span> <span style="color:#66d9ef">string</span> version;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>这里指定了生成类的命名空间，以及定义了一个结构体作为返回值</p>
<h2 id="生成服务接口">生成服务接口</h2>
<p>这里就需要用到之前下载的Thrift编译器，可以直接在Thrift官网找到。将下载的<code>thrift-0.12.0.exe</code>也拷贝到解决方案目录下（和Sample.thrift相同目录），打开命令窗口，执行以下命令</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ thrift-0.12.0.exe -gen csharp Sample.thrift
</code></pre></div><p>不得不说，Thrift的命令行语法真的比gRPC简洁多了。</p>
<p>执行完没有错误的话，就可以看到目录下又多出了一个<code>gen-csharp</code>的文件夹，里面有对应命名空间的文件夹，最后找到生成的<code>.cs</code>文件。将文件全部拷贝到<code>ThriftSample</code>项目目录下，并将它们添加到项目，编译生成库。</p>
<h2 id="服务端程序">服务端程序</h2>
<p>在<code>server</code>项目下新建类<code>MySampleService</code>并实现接口<code>SampleService.Iface</code>，重写其中的两个服务接口函数</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">namespace</span> server
{
    <span style="color:#66d9ef">using</span> System.Collections.Generic;
    <span style="color:#66d9ef">using</span> kira.Interface;

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MySampleService</span> : SampleService.Iface
    {
        <span style="color:#66d9ef">public</span> ServiceVersion GetVersion()
        {
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> ServiceVersion()
            {
                Name = <span style="color:#e6db74">&#34;My Sample Service&#34;</span>,
                Version = <span style="color:#e6db74">&#34;0.0.1.20&#34;</span>
            };
        }

        <span style="color:#66d9ef">public</span> List&lt;<span style="color:#66d9ef">string</span>&gt; SayHello(<span style="color:#66d9ef">string</span> name)
        {
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> List&lt;<span style="color:#66d9ef">string</span>&gt;()
            {
                <span style="color:#e6db74">$&#34;你好 {name}&#34;</span>,
                <span style="color:#e6db74">$&#34;Hello {name}&#34;</span>,
                <span style="color:#e6db74">$&#34;Hola {name}&#34;</span>,
                <span style="color:#e6db74">$&#34;Bonjour {name}&#34;</span>,
                <span style="color:#e6db74">$&#34;こんにちは {name}&#34;</span>,
                <span style="color:#e6db74">$&#34;hallo {name}&#34;</span>
            };
        }
    }
}
</code></pre></div><p>编写服务启动程序</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">namespace</span> server
{
    <span style="color:#66d9ef">using</span> Thrift.Server;
    <span style="color:#66d9ef">using</span> Thrift.Transport;
    <span style="color:#66d9ef">using</span> kira.Interface;

    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Program</span>
    {
        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Main(<span style="color:#66d9ef">string</span>[] args)
        {
            MySampleService service = <span style="color:#66d9ef">new</span> MySampleService();

            SampleService.Processor processor = <span style="color:#66d9ef">new</span> SampleService.Processor(service);

            TServerTransport serverTransport = <span style="color:#66d9ef">new</span> TServerSocket(<span style="color:#ae81ff">10240</span>);
            TServer server = <span style="color:#66d9ef">new</span> TThreadPoolServer(processor, serverTransport);
            System.Console.WriteLine(<span style="color:#e6db74">&#34;server listening at tcp://localhost:10240/&#34;</span>);
            server.Serve();
        }
    }
}
</code></pre></div><h2 id="客户端程序">客户端程序</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">namespace</span> client
{
    <span style="color:#66d9ef">using</span> Thrift.Protocol;
    <span style="color:#66d9ef">using</span> Thrift.Transport;
    <span style="color:#66d9ef">using</span> kira.Interface;

    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Program</span>
    {
        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Main(<span style="color:#66d9ef">string</span>[] args)
        {
            TTransport transport = <span style="color:#66d9ef">new</span> TSocket(<span style="color:#e6db74">&#34;localhost&#34;</span>, <span style="color:#ae81ff">10240</span>);
            transport.Open();

            TProtocol protocol = <span style="color:#66d9ef">new</span> TBinaryProtocol(transport);
            SampleService.Client cli = <span style="color:#66d9ef">new</span> SampleService.Client(protocol);

            ServiceVersion ver = cli.GetVersion();
            System.Console.WriteLine(<span style="color:#e6db74">&#34;Remote Service Version: {0} - v{1}&#34;</span>, ver.Name, ver.Version);

            <span style="color:#66d9ef">var</span> hellos = cli.SayHello(<span style="color:#e6db74">&#34;Thrift&#34;</span>);

            <span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">string</span> item <span style="color:#66d9ef">in</span> hellos)
            {
                System.Console.WriteLine(item);
            }

            System.Console.ReadKey();
            transport.Close();
        }
    }
}
</code></pre></div><h2 id="运行测试">运行测试</h2>
<p>老样子，先启动服务端程序，然后运行客户端程序，可以看到客户端输出</p>
<pre><code>Remote Service Version: My Sample Service - v0.0.1.20
你好 Thrift
Hello Thrift
Hola Thrift
Bonjour Thrift
こんにちは Thrift
hallo Thrift
</code></pre><h2 id="总结">总结</h2>
<p>对比Thrift和gRPC两个主流的RPC框架，个人感觉Thrift使用起来要更加灵活一些，当然这只是初步接触，较深层次的内容还没有去研究，实际项目的应用感觉两个都可以，有对比说Thrift框架的性能要优于gRPC，但对于小的项目来说已经完全够用了。</p>

  </div>

  <footer>
    <hr class="end-line">

    

    
    <div class="post-tags">
      <i class="fas fa-tags"></i>
      
        <a href="/tags/C">C#</a>
        &nbsp;
      
        <a href="/tags/%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1">进程通信</a>
        &nbsp;
      
    </div>
    

    
    
    <div class="releated-posts">
      <h3>Related Posts</h3>
      
      <i class="fas fa-paperclip"></i>
      <a href="/posts/gRPC-C_-%E5%88%9D%E6%8E%A2/">gRPC C# 初探</a>
      <br>
      
      <i class="fas fa-paperclip"></i>
      <a href="/posts/WPF%E5%92%8CMFC%E8%BF%9B%E7%A8%8B%E9%97%B4%E4%BC%A0%E9%80%92%E6%95%B0%E6%8D%AE/">WPF和MFC进程间传递数据</a>
      <br>
      
      <i class="fas fa-paperclip"></i>
      <a href="/posts/WPF%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86Windows%E6%B6%88%E6%81%AF/">WPF如何处理Windows消息</a>
      <br>
      
    </div>
    
  </footer>

  <div class="comments">



  <div class="comments-item comments-valine" >
    
    
    
    <div id="vcomments"></div>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
    <script type="text/javascript">
      new Valine({
          el: '#vcomments',
          highlight: false,
          lang: "zh-CN",
          appId: "X8gbfFnXlzbwF0YQQ91rSogz-gzGzoHsz",
          appKey: "ljO0GYMaeqs5KWK2vCtk1Ii8",
          placeholder: "在这里写下你的留言丨支持 Markdown 语法",
          requiredFields: ["nick","mail"],
          avatar: "mp",
          visitor:  true ,
          recordIP: true
      });
    </script>
    <script>
      if(window.location.hash){
          var checkExist = setInterval(function() {
             if ($(window.location.hash).length) {
                $('html, body, article').animate({scrollTop: $(window.location.hash).offset().top-90}, 1000);
                clearInterval(checkExist);
             }
          }, 100);
      }
    </script>
  </div>

</div>

</article>


</body>
<div class="foot">
  
  
    &copy; 2019 - 2021 &#183; 
    <a href="/">kira-96</a> · Theme <a href="https://github.com/RainerChiang/simpleness">Simpleness</a>|Powered by <a href="https://gohugo.io/">Hugo</a> &#183;
    <a href="#"><i class="fas fa-chevron-up"></i></a>
  

  
</div>

<script src="/js/lazyload.min.js"></script>
<script>
  var lazyImage = new LazyLoad({
    container: document.getElementById('article')
  });
</script>


</html>
