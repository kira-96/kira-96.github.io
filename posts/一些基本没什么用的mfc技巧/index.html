<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>一些基本没什么用的MFC技巧 | ✨kiraの博客</title>
<meta name=keywords content="MFC"><meta name=description content="MFC小技巧"><meta name=author content><link rel=canonical href=https://kira-96.github.io/posts/%E4%B8%80%E4%BA%9B%E5%9F%BA%E6%9C%AC%E6%B2%A1%E4%BB%80%E4%B9%88%E7%94%A8%E7%9A%84mfc%E6%8A%80%E5%B7%A7/><link crossorigin=anonymous href=/assets/css/stylesheet.3885277a87a498ed2522e7ff68054e29ab8db4095b653379837d1193311cfcc9.css integrity="sha256-OIUneoekmO0lIuf/aAVOKauNtAlbZTN5g30RkzEc/Mk=" rel="preload stylesheet" as=style><link rel=icon href=https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/favicon-32x32.png><link rel=apple-touch-icon href=https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/icons/apple-icon-180x180.png><link rel=mask-icon href=https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/icons/apple-icon-76x76.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://kira-96.github.io/posts/%E4%B8%80%E4%BA%9B%E5%9F%BA%E6%9C%AC%E6%B2%A1%E4%BB%80%E4%B9%88%E7%94%A8%E7%9A%84mfc%E6%8A%80%E5%B7%A7/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=manifest href=https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/manifest.json><script src=https://fastly.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js></script><script type=text/javascript src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><meta property="og:title" content="一些基本没什么用的MFC技巧"><meta property="og:description" content="MFC小技巧"><meta property="og:type" content="article"><meta property="og:url" content="https://kira-96.github.io/posts/%E4%B8%80%E4%BA%9B%E5%9F%BA%E6%9C%AC%E6%B2%A1%E4%BB%80%E4%B9%88%E7%94%A8%E7%9A%84mfc%E6%8A%80%E5%B7%A7/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-04-24T14:35:30+08:00"><meta property="article:modified_time" content="2020-04-24T14:35:30+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="一些基本没什么用的MFC技巧"><meta name=twitter:description content="MFC小技巧"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://kira-96.github.io/posts/"},{"@type":"ListItem","position":2,"name":"一些基本没什么用的MFC技巧","item":"https://kira-96.github.io/posts/%E4%B8%80%E4%BA%9B%E5%9F%BA%E6%9C%AC%E6%B2%A1%E4%BB%80%E4%B9%88%E7%94%A8%E7%9A%84mfc%E6%8A%80%E5%B7%A7/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"一些基本没什么用的MFC技巧","name":"一些基本没什么用的MFC技巧","description":"MFC小技巧","keywords":["MFC"],"articleBody":"前言 由于我很少用MFC，只有工作上需要的时候才会用到，所以我也是个新手，遇到问题需要到网上找很久资料。这里只是记录一些特殊情景下会用到的技巧，方便以后查找。\n隐藏窗口任务栏图标 这个问题我在网上找了很久，大致有两种方案：\n修改窗口的扩展样式\n1 ModifyStyleEx(WS_EX_APPWINDOW,WS_EX_TOOLWINDOW); 但是这样做会导致整个窗口的样式会变得很难看。\n将一个隐藏窗口设置成主窗口的父窗口\n这样做比较麻烦，而且任务视图下也不能再看到窗口，显然不是我想要的效果。\n最后终于找到了一个比较完美的解决方案，通过COM的方式移除任务栏列表中的图标。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 // 显示/隐藏任务栏图标(COM方式) bool ShowInTaskbar(HWND hWnd, bool isShow) { CoInitialize(nullptr); ITaskbarList* pTaskbarList; HRESULT hr = CoCreateInstance(CLSID_TaskbarList, nullptr, CLSCTX_INPROC_SERVER, IID_ITaskbarList, (void**)\u0026pTaskbarList); if (SUCCEEDED(hr)) { pTaskbarList-\u003eHrInit(); if (isShow) { pTaskbarList-\u003eAddTab(hWnd); } else { pTaskbarList-\u003eDeleteTab(hWnd); } CoUninitialize(); return true; } CoUninitialize(); return false; } 程序启动时默认隐藏窗口 一种比较简单的方法是在程序启动时将窗口移动到屏幕外的不可见区域。 如果直接在OnInitDialog中设置ShowWindow(SW_HIDE)是无效的，因为此时窗口还没有显示出来，自然也无法隐藏。\n这里的思路是在程序启动的时候先将窗口移动到屏幕外，然后通过另一个线程将窗口隐藏起来，这样做虽然程序启动后窗口还是会一闪即逝，但由于是在屏幕之外，实际上并不能看到，然后在窗口需要显示的时候调用ShowWindow(SW_SHOW)即可。\n1 2 3 4 5 6 7 8 9 10 11 12 // CxxxDlg.h 头文件 #include class CxxxDlg : public CDialogEx { ... ... ... private: std::future\u003cint\u003e hideTask; // 后台隐藏窗口线程 } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 BOOL CxxxDlg::OnInitDialog() { ... CRect rcClient; GetWindowRect(\u0026rcClient); // 将窗口移动到屏幕外 MoveWindow(-rcClient.Width(), rcClient.top, rcClient.Width(), rcClient.Height()); // 新建线程，延时1s后隐藏窗口 hideTask = std::async( std::launch::async, [\u0026] { std::this_thread::sleep_for(std::chrono::seconds(1)); // ShowWindow(SW_HIDE); ShowWindowAsync(m_hWnd, SW_HIDE); std::this_thread::sleep_for(std::chrono::seconds(1)); // 延时1s，待窗口完全隐藏后再将窗口居中 CenterWindow(); return 0; }); ... return TRUE; // 除非将焦点设置到控件，否则返回 TRUE } 点击关闭时隐藏窗口 有时候我们希望在点击主窗口的关闭按钮之后将窗口隐藏或者最小化，而不是退出程序。这时只需要拦截掉窗口的关闭消息即可。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 // CxxxDlg.h 头文件 class CxxxDlg : public CDialogEx { ... protected: afx_msg void OnSysCommand(UINT nID, LPARAM lParam); ... } void CxxxDlg::OnSysCommand(UINT nID, LPARAM lParam) { ///////////////////////////////////// // 这里捕获窗口的关闭消息 // 不直接关闭窗口，而是隐藏起来 if (nID == SC_CLOSE) { ShowWindowAsync(m_hWnd, SW_HIDE); } ///////////////////////////////////// else { CDialogEx::OnSysCommand(nID, lParam); } } 这样就可以拦截掉窗口的关闭消息了，这样不仅仅是点击关闭按钮时会隐藏窗口，通过窗口菜单关闭窗口或是使用Alt+F4都不能真正关闭窗口。那么我怎样才能退出程序呢，总不能用任务管理器吧。\n其实很简单，在需要退出程序的时候向窗口发送WM_CLOSE消息即可。\n1 SendMessage(WM_CLOSE); CFileDialog导致CDialogEx“失去焦点”的解决方法 继承自CDialogEx的窗口在使用CFileDialog之后会导致窗口标题栏变成灰色，很像是窗口失去了焦点，此时窗口仍然能够正常操作，但即使鼠标点击在窗口上窗口的标题栏依旧是灰色，无法恢复到窗口激活状态的颜色，即使将窗口属性设置为WS_EX_TOPMOST（置顶）依旧是这样，必须点击窗口外的其它区域或者使用Tab切换一下才能恢复正常。\n而继承自CDialog的窗口则没有这个问题，可以将窗口的基类改成CDialog来避免这个问题。对于我这样的强迫症来说是无法忍受的，所以用尽千方百计终于找到了一个可行的解决方案。\n经过尝试，单纯让窗口获取焦点或者将窗口放到前台的方法都是无效的。\n1 2 3 4 5 6 7 8 9 10 11 12 CFileDialog dlg( TRUE, _T(\"ini\"), nullptr, OFN_HIDEREADONLY | OFN_OVERWRITEPROMPT, _T(\"ini(*.ini)|*.ini|TEXT(*.txt)|*.txt|\"), this); auto dlgResult = dlg.DoModal(); // 无效的方法 this-\u003eSetFocus(); this-\u003eSetForegroundWindow(); ... 所以只能曲线救国，既然通过手动切换的方式可以恢复到正常状态，不妨先切换到其它窗口再切换回来。\n1 2 3 4 5 6 7 8 9 10 11 12 CFileDialog dlg( TRUE, _T(\"ini\"), nullptr, OFN_HIDEREADONLY | OFN_OVERWRITEPROMPT, _T(\"ini(*.ini)|*.ini|TEXT(*.txt)|*.txt|\"), this); auto dlgResult = dlg.DoModal(); // 先将焦点放到桌面，再切换回本窗口 ::SetForegroundWindow(::GetDesktopWindow()); this-\u003eSetForegroundWindow(); ... 完美解决了问题。\n窗口启用视觉样式 启用视觉样式之后，可以让程序看起来更加现代化一些，只支持Window XP以后的系统。 可以通过为程序添加清单文件来实现，不过比较麻烦。在VC++ 2005之后，直接添加编译器指令到代码中就可以了。\n在预编译头文件中添加下面代码即可。\n1 2 3 4 5 6 7 8 9 #if defined _M_IX86 #pragma comment(linker,\"/manifestdependency:\\\"type='win32' name='Microsoft.Windows.Common-Controls' version='6.0.0.0' processorArchitecture='x86' publicKeyToken='6595b64144ccf1df' language='*'\\\"\") #elif defined _M_IA64 #pragma comment(linker,\"/manifestdependency:\\\"type='win32' name='Microsoft.Windows.Common-Controls' version='6.0.0.0' processorArchitecture='ia64' publicKeyToken='6595b64144ccf1df' language='*'\\\"\") #elif defined _M_X64 #pragma comment(linker,\"/manifestdependency:\\\"type='win32' name='Microsoft.Windows.Common-Controls' version='6.0.0.0' processorArchitecture='amd64' publicKeyToken='6595b64144ccf1df' language='*'\\\"\") #else #pragma comment(linker,\"/manifestdependency:\\\"type='win32' name='Microsoft.Windows.Common-Controls' version='6.0.0.0' processorArchitecture='*' publicKeyToken='6595b64144ccf1df' language='*'\\\"\") #endif 任务栏显示进度 为窗口的任务栏图标添加进度显示，也可以为任务栏添加按钮。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 ITaskbarList3* pTaskbar; // 初始化COM组件 CoInitialize(NULL); CoCreateInstance(CLSID_TaskbarList, NULL, CLSCTX_INPROC_SERVER, IID_PPV_ARGS(\u0026pTaskbar)); // TBPF_NOPROGRESS\t= 0, // 正常状态，不显示进度 // TBPF_INDETERMINATE\t= 0x1, // 忙碌状态，不显示进度 // TBPF_NORMAL\t= 0x2, // 正常状态，显示进度（绿色） // TBPF_ERROR\t= 0x4, // 错误状态，显示进度（红色） // TBPF_PAUSED\t= 0x8 // 停止状态，显示进度（黄色） pTaskbar-\u003eSetProgressState(GetSafeHwnd(), TBPF_NORMAL); pTaskbar-\u003eSetProgressValue(GetSafeHwnd(), 60, 100); // 设置提示信息 pTaskbar-\u003eSetThumbnailTooltip(GetSafeHwnd(), TEXT(\"Tooltip\")); // 设置覆盖图标 HICON hIcon = AfxGetApp()-\u003eLoadIcon(IDI_ICON_ERR); pTaskbar-\u003eSetOverlayIcon(GetSafeHwnd(), hIcon, _T(\"Error\")); // 添加任务栏按钮 THUMBBUTTONMASK dwMask = THB_ICON | THB_TOOLTIP; THUMBBUTTON buttons[3]; buttons[0].iId = 0; buttons[0].dwMask = dwMask; buttons[0].hIcon = hIcon; memcpy(buttons[0].szTip, TEXT(\"Tooltip\"), sizeof(buttons[0].szTip)); // ... pTaskbar-\u003eThumbBarAddButtons(GetSafeHwnd(), 3, buttons); // 最后释放COM组件 CoUninitialize(); 未完待续，持续更新中… 参考\nMFC简单的启动时隐藏界面方式(仅启动时隐藏)\nEnabling Visual Styles\n","wordCount":"1900","inLanguage":"zh","datePublished":"2020-04-24T14:35:30+08:00","dateModified":"2020-04-24T14:35:30+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://kira-96.github.io/posts/%E4%B8%80%E4%BA%9B%E5%9F%BA%E6%9C%AC%E6%B2%A1%E4%BB%80%E4%B9%88%E7%94%A8%E7%9A%84mfc%E6%8A%80%E5%B7%A7/"},"publisher":{"@type":"Organization","name":"✨kiraの博客","logo":{"@type":"ImageObject","url":"https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://kira-96.github.io/ accesskey=h title="✨kiraの博客 (Alt + H)">✨kiraの博客</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://kira-96.github.io/ title=🏠主页><span>🏠主页</span></a></li><li><a href=https://kira-96.github.io/notes/ title=📓笔记><span>📓笔记</span></a></li><li><a href=https://kira-96.github.io/search/ title=🔍️搜索><span>🔍️搜索</span></a></li><li><a href=https://kira-96.github.io/archives/ title=🗃️存档><span>🗃️存档</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://kira-96.github.io/>主页</a>&nbsp;»&nbsp;<a href=https://kira-96.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">一些基本没什么用的MFC技巧</h1><div class=post-description>MFC小技巧</div><div class=post-meta><span title='2020-04-24 14:35:30 +0800 +0800'>四月 24, 2020</span>&nbsp;·&nbsp;4 分钟&nbsp;·&nbsp;1900 字&nbsp;|&nbsp;<a href=https://github.com/kira-96/kira-96.github.io/tree/main/content/posts/ rel="noopener noreferrer" target=_blank>✏️编辑</a></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e5%89%8d%e8%a8%80 aria-label=前言>前言</a></li><li><a href=#%e9%9a%90%e8%97%8f%e7%aa%97%e5%8f%a3%e4%bb%bb%e5%8a%a1%e6%a0%8f%e5%9b%be%e6%a0%87 aria-label=隐藏窗口任务栏图标>隐藏窗口任务栏图标</a></li><li><a href=#%e7%a8%8b%e5%ba%8f%e5%90%af%e5%8a%a8%e6%97%b6%e9%bb%98%e8%ae%a4%e9%9a%90%e8%97%8f%e7%aa%97%e5%8f%a3 aria-label=程序启动时默认隐藏窗口>程序启动时默认隐藏窗口</a></li><li><a href=#%e7%82%b9%e5%87%bb%e5%85%b3%e9%97%ad%e6%97%b6%e9%9a%90%e8%97%8f%e7%aa%97%e5%8f%a3 aria-label=点击关闭时隐藏窗口>点击关闭时隐藏窗口</a></li><li><a href=#cfiledialog%e5%af%bc%e8%87%b4cdialogex%e5%a4%b1%e5%8e%bb%e7%84%a6%e7%82%b9%e7%9a%84%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95 aria-label=CFileDialog导致CDialogEx“失去焦点”的解决方法>CFileDialog导致CDialogEx“失去焦点”的解决方法</a></li><li><a href=#%e7%aa%97%e5%8f%a3%e5%90%af%e7%94%a8%e8%a7%86%e8%a7%89%e6%a0%b7%e5%bc%8f aria-label=窗口启用视觉样式>窗口启用视觉样式</a></li><li><a href=#%e4%bb%bb%e5%8a%a1%e6%a0%8f%e6%98%be%e7%a4%ba%e8%bf%9b%e5%ba%a6 aria-label=任务栏显示进度>任务栏显示进度</a></li><li><a href=#%e6%9c%aa%e5%ae%8c%e5%be%85%e7%bb%ad%e6%8c%81%e7%bb%ad%e6%9b%b4%e6%96%b0%e4%b8%ad aria-label=未完待续，持续更新中&mldr;>未完待续，持续更新中&mldr;</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=前言>前言<a hidden class=anchor aria-hidden=true href=#前言>#</a></h2><p>由于我很少用MFC，只有工作上需要的时候才会用到，所以我也是个新手，遇到问题需要到网上找很久资料。这里只是记录一些特殊情景下会用到的技巧，方便以后查找。</p><h2 id=隐藏窗口任务栏图标>隐藏窗口任务栏图标<a hidden class=anchor aria-hidden=true href=#隐藏窗口任务栏图标>#</a></h2><p>这个问题我在网上找了很久，大致有两种方案：</p><p><strong>修改窗口的扩展样式</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>ModifyStyleEx</span><span class=p>(</span><span class=n>WS_EX_APPWINDOW</span><span class=p>,</span><span class=n>WS_EX_TOOLWINDOW</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>但是这样做会导致整个窗口的样式会变得很难看。</p><p><strong>将一个隐藏窗口设置成主窗口的父窗口</strong></p><p>这样做比较麻烦，而且任务视图下也不能再看到窗口，显然不是我想要的效果。</p><p>最后终于找到了一个比较完美的解决方案，通过COM的方式移除任务栏列表中的图标。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// 显示/隐藏任务栏图标(COM方式)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>bool</span> <span class=nf>ShowInTaskbar</span><span class=p>(</span><span class=n>HWND</span> <span class=n>hWnd</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>isShow</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>CoInitialize</span><span class=p>(</span><span class=k>nullptr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>ITaskbarList</span><span class=o>*</span> <span class=n>pTaskbarList</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>HRESULT</span> <span class=n>hr</span> <span class=o>=</span> <span class=n>CoCreateInstance</span><span class=p>(</span><span class=n>CLSID_TaskbarList</span><span class=p>,</span> <span class=k>nullptr</span><span class=p>,</span> <span class=n>CLSCTX_INPROC_SERVER</span><span class=p>,</span> <span class=n>IID_ITaskbarList</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span><span class=o>**</span><span class=p>)</span><span class=o>&amp;</span><span class=n>pTaskbarList</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>SUCCEEDED</span><span class=p>(</span><span class=n>hr</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>pTaskbarList</span><span class=o>-&gt;</span><span class=n>HrInit</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>isShow</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>pTaskbarList</span><span class=o>-&gt;</span><span class=n>AddTab</span><span class=p>(</span><span class=n>hWnd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>pTaskbarList</span><span class=o>-&gt;</span><span class=n>DeleteTab</span><span class=p>(</span><span class=n>hWnd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>CoUninitialize</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>CoUninitialize</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=程序启动时默认隐藏窗口>程序启动时默认隐藏窗口<a hidden class=anchor aria-hidden=true href=#程序启动时默认隐藏窗口>#</a></h2><p>一种比较简单的方法是在程序启动时将窗口移动到屏幕外的不可见区域。
如果直接在<code>OnInitDialog</code>中设置<code>ShowWindow(SW_HIDE)</code>是无效的，因为此时窗口还没有显示出来，自然也无法隐藏。</p><p>这里的思路是在程序启动的时候先将窗口移动到屏幕外，然后通过另一个线程将窗口隐藏起来，这样做虽然程序启动后窗口还是会一闪即逝，但由于是在屏幕之外，实际上并不能看到，然后在窗口需要显示的时候调用<code>ShowWindow(SW_SHOW)</code>即可。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// CxxxDlg.h 头文件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#include</span> <span class=cpf>&lt;future&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CxxxDlg</span> <span class=o>:</span> <span class=k>public</span> <span class=n>CDialogEx</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>private</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>future</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span> <span class=n>hideTask</span><span class=p>;</span>  <span class=c1>// 后台隐藏窗口线程
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>BOOL</span> <span class=n>CxxxDlg</span><span class=o>::</span><span class=n>OnInitDialog</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>CRect</span> <span class=n>rcClient</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>GetWindowRect</span><span class=p>(</span><span class=o>&amp;</span><span class=n>rcClient</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 将窗口移动到屏幕外
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>MoveWindow</span><span class=p>(</span><span class=o>-</span><span class=n>rcClient</span><span class=p>.</span><span class=n>Width</span><span class=p>(),</span> <span class=n>rcClient</span><span class=p>.</span><span class=n>top</span><span class=p>,</span> <span class=n>rcClient</span><span class=p>.</span><span class=n>Width</span><span class=p>(),</span> <span class=n>rcClient</span><span class=p>.</span><span class=n>Height</span><span class=p>());</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 新建线程，延时1s后隐藏窗口
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>hideTask</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>async</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=n>std</span><span class=o>::</span><span class=n>launch</span><span class=o>::</span><span class=n>async</span><span class=p>,</span> <span class=p>[</span><span class=o>&amp;</span><span class=p>]</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>sleep_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>seconds</span><span class=p>(</span><span class=mi>1</span><span class=p>));</span>
</span></span><span class=line><span class=cl>		<span class=c1>// ShowWindow(SW_HIDE);
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=n>ShowWindowAsync</span><span class=p>(</span><span class=n>m_hWnd</span><span class=p>,</span> <span class=n>SW_HIDE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>sleep_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>seconds</span><span class=p>(</span><span class=mi>1</span><span class=p>));</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 延时1s，待窗口完全隐藏后再将窗口居中
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=n>CenterWindow</span><span class=p>();</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>TRUE</span><span class=p>;</span>  <span class=c1>// 除非将焦点设置到控件，否则返回 TRUE
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=点击关闭时隐藏窗口>点击关闭时隐藏窗口<a hidden class=anchor aria-hidden=true href=#点击关闭时隐藏窗口>#</a></h2><p>有时候我们希望在点击主窗口的关闭按钮之后将窗口隐藏或者最小化，而不是退出程序。这时只需要拦截掉窗口的关闭消息即可。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// CxxxDlg.h 头文件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>class</span> <span class=nc>CxxxDlg</span> <span class=o>:</span> <span class=k>public</span> <span class=n>CDialogEx</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>protected</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	<span class=n>afx_msg</span> <span class=kt>void</span> <span class=n>OnSysCommand</span><span class=p>(</span><span class=n>UINT</span> <span class=n>nID</span><span class=p>,</span> <span class=n>LPARAM</span> <span class=n>lParam</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=n>CxxxDlg</span><span class=o>::</span><span class=n>OnSysCommand</span><span class=p>(</span><span class=n>UINT</span> <span class=n>nID</span><span class=p>,</span> <span class=n>LPARAM</span> <span class=n>lParam</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>/////////////////////////////////////
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 这里捕获窗口的关闭消息
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 不直接关闭窗口，而是隐藏起来
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=p>(</span><span class=n>nID</span> <span class=o>==</span> <span class=n>SC_CLOSE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>ShowWindowAsync</span><span class=p>(</span><span class=n>m_hWnd</span><span class=p>,</span> <span class=n>SW_HIDE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>/////////////////////////////////////
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>else</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>CDialogEx</span><span class=o>::</span><span class=n>OnSysCommand</span><span class=p>(</span><span class=n>nID</span><span class=p>,</span> <span class=n>lParam</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这样就可以拦截掉窗口的关闭消息了，这样不仅仅是点击关闭按钮时会隐藏窗口，通过窗口菜单关闭窗口或是使用<code>Alt+F4</code>都不能真正关闭窗口。那么我怎样才能退出程序呢，总不能用任务管理器吧。</p><p>其实很简单，在需要退出程序的时候向窗口发送<code>WM_CLOSE</code>消息即可。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>SendMessage</span><span class=p>(</span><span class=n>WM_CLOSE</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=cfiledialog导致cdialogex失去焦点的解决方法><code>CFileDialog</code>导致<code>CDialogEx</code>“失去焦点”的解决方法<a hidden class=anchor aria-hidden=true href=#cfiledialog导致cdialogex失去焦点的解决方法>#</a></h2><p>继承自<code>CDialogEx</code>的窗口在使用<code>CFileDialog</code>之后会导致窗口标题栏变成灰色，很像是窗口失去了焦点，此时窗口仍然能够正常操作，但即使鼠标点击在窗口上窗口的标题栏依旧是灰色，无法恢复到窗口激活状态的颜色，即使将窗口属性设置为<code>WS_EX_TOPMOST</code>（置顶）依旧是这样，必须点击窗口外的其它区域或者使用Tab切换一下才能恢复正常。</p><p>而继承自<code>CDialog</code>的窗口则没有这个问题，可以将窗口的基类改成<code>CDialog</code>来避免这个问题。对于我这样的强迫症来说是无法忍受的，所以用尽千方百计终于找到了一个可行的解决方案。</p><p>经过尝试，单纯让窗口获取焦点或者将窗口放到前台的方法都是无效的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>CFileDialog</span> <span class=nf>dlg</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=n>TRUE</span><span class=p>,</span> <span class=n>_T</span><span class=p>(</span><span class=s>&#34;ini&#34;</span><span class=p>),</span> <span class=k>nullptr</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>OFN_HIDEREADONLY</span> <span class=o>|</span> <span class=n>OFN_OVERWRITEPROMPT</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>_T</span><span class=p>(</span><span class=s>&#34;ini(*.ini)|*.ini|TEXT(*.txt)|*.txt|&#34;</span><span class=p>),</span> <span class=k>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>auto</span> <span class=n>dlgResult</span> <span class=o>=</span> <span class=n>dlg</span><span class=p>.</span><span class=n>DoModal</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 无效的方法
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>this</span><span class=o>-&gt;</span><span class=n>SetFocus</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=k>this</span><span class=o>-&gt;</span><span class=n>SetForegroundWindow</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span></code></pre></td></tr></table></div></div><p>所以只能曲线救国，既然通过手动切换的方式可以恢复到正常状态，不妨先切换到其它窗口再切换回来。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>CFileDialog</span> <span class=nf>dlg</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=n>TRUE</span><span class=p>,</span> <span class=n>_T</span><span class=p>(</span><span class=s>&#34;ini&#34;</span><span class=p>),</span> <span class=k>nullptr</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>OFN_HIDEREADONLY</span> <span class=o>|</span> <span class=n>OFN_OVERWRITEPROMPT</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>_T</span><span class=p>(</span><span class=s>&#34;ini(*.ini)|*.ini|TEXT(*.txt)|*.txt|&#34;</span><span class=p>),</span> <span class=k>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>auto</span> <span class=n>dlgResult</span> <span class=o>=</span> <span class=n>dlg</span><span class=p>.</span><span class=n>DoModal</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 先将焦点放到桌面，再切换回本窗口
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>::</span><span class=n>SetForegroundWindow</span><span class=p>(</span><span class=o>::</span><span class=n>GetDesktopWindow</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=k>this</span><span class=o>-&gt;</span><span class=n>SetForegroundWindow</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span></code></pre></td></tr></table></div></div><p>完美解决了问题。</p><h2 id=窗口启用视觉样式>窗口启用视觉样式<a hidden class=anchor aria-hidden=true href=#窗口启用视觉样式>#</a></h2><p>启用视觉样式之后，可以让程序看起来更加现代化一些，只支持Window XP以后的系统。
可以通过为程序添加清单文件来实现，不过比较麻烦。在VC++ 2005之后，直接添加编译器指令到代码中就可以了。</p><p>在预编译头文件中添加下面代码即可。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#if defined _M_IX86
</span></span></span><span class=line><span class=cl><span class=cp>#pragma comment(linker,&#34;/manifestdependency:\&#34;type=&#39;win32&#39; name=&#39;Microsoft.Windows.Common-Controls&#39; version=&#39;6.0.0.0&#39; processorArchitecture=&#39;x86&#39; publicKeyToken=&#39;6595b64144ccf1df&#39; language=&#39;*&#39;\&#34;&#34;)
</span></span></span><span class=line><span class=cl><span class=cp>#elif defined _M_IA64
</span></span></span><span class=line><span class=cl><span class=cp>#pragma comment(linker,&#34;/manifestdependency:\&#34;type=&#39;win32&#39; name=&#39;Microsoft.Windows.Common-Controls&#39; version=&#39;6.0.0.0&#39; processorArchitecture=&#39;ia64&#39; publicKeyToken=&#39;6595b64144ccf1df&#39; language=&#39;*&#39;\&#34;&#34;)
</span></span></span><span class=line><span class=cl><span class=cp>#elif defined _M_X64
</span></span></span><span class=line><span class=cl><span class=cp>#pragma comment(linker,&#34;/manifestdependency:\&#34;type=&#39;win32&#39; name=&#39;Microsoft.Windows.Common-Controls&#39; version=&#39;6.0.0.0&#39; processorArchitecture=&#39;amd64&#39; publicKeyToken=&#39;6595b64144ccf1df&#39; language=&#39;*&#39;\&#34;&#34;)
</span></span></span><span class=line><span class=cl><span class=cp>#else
</span></span></span><span class=line><span class=cl><span class=cp>#pragma comment(linker,&#34;/manifestdependency:\&#34;type=&#39;win32&#39; name=&#39;Microsoft.Windows.Common-Controls&#39; version=&#39;6.0.0.0&#39; processorArchitecture=&#39;*&#39; publicKeyToken=&#39;6595b64144ccf1df&#39; language=&#39;*&#39;\&#34;&#34;)
</span></span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span></code></pre></td></tr></table></div></div><h2 id=任务栏显示进度>任务栏显示进度<a hidden class=anchor aria-hidden=true href=#任务栏显示进度>#</a></h2><p>为窗口的任务栏图标添加进度显示，也可以为任务栏添加按钮。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>ITaskbarList3</span><span class=o>*</span> <span class=n>pTaskbar</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 初始化COM组件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>CoInitialize</span><span class=p>(</span><span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>CoCreateInstance</span><span class=p>(</span><span class=n>CLSID_TaskbarList</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=n>CLSCTX_INPROC_SERVER</span><span class=p>,</span> <span class=n>IID_PPV_ARGS</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pTaskbar</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// TBPF_NOPROGRESS	= 0,        // 正常状态，不显示进度
</span></span></span><span class=line><span class=cl><span class=c1>// TBPF_INDETERMINATE	= 0x1,  // 忙碌状态，不显示进度
</span></span></span><span class=line><span class=cl><span class=c1>// TBPF_NORMAL	= 0x2,          // 正常状态，显示进度（绿色）
</span></span></span><span class=line><span class=cl><span class=c1>// TBPF_ERROR	= 0x4,          // 错误状态，显示进度（红色）
</span></span></span><span class=line><span class=cl><span class=c1>// TBPF_PAUSED	= 0x8           // 停止状态，显示进度（黄色）
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>pTaskbar</span><span class=o>-&gt;</span><span class=n>SetProgressState</span><span class=p>(</span><span class=n>GetSafeHwnd</span><span class=p>(),</span> <span class=n>TBPF_NORMAL</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>pTaskbar</span><span class=o>-&gt;</span><span class=n>SetProgressValue</span><span class=p>(</span><span class=n>GetSafeHwnd</span><span class=p>(),</span> <span class=mi>60</span><span class=p>,</span> <span class=mi>100</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 设置提示信息
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>pTaskbar</span><span class=o>-&gt;</span><span class=n>SetThumbnailTooltip</span><span class=p>(</span><span class=n>GetSafeHwnd</span><span class=p>(),</span> <span class=n>TEXT</span><span class=p>(</span><span class=s>&#34;Tooltip&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 设置覆盖图标
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>HICON</span> <span class=n>hIcon</span> <span class=o>=</span> <span class=n>AfxGetApp</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>LoadIcon</span><span class=p>(</span><span class=n>IDI_ICON_ERR</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>pTaskbar</span><span class=o>-&gt;</span><span class=n>SetOverlayIcon</span><span class=p>(</span><span class=n>GetSafeHwnd</span><span class=p>(),</span> <span class=n>hIcon</span><span class=p>,</span> <span class=n>_T</span><span class=p>(</span><span class=s>&#34;Error&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 添加任务栏按钮
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>THUMBBUTTONMASK</span> <span class=n>dwMask</span> <span class=o>=</span> <span class=n>THB_ICON</span> <span class=o>|</span> <span class=n>THB_TOOLTIP</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>THUMBBUTTON</span> <span class=n>buttons</span><span class=p>[</span><span class=mi>3</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=n>buttons</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>iId</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>buttons</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>dwMask</span> <span class=o>=</span> <span class=n>dwMask</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>buttons</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>hIcon</span> <span class=o>=</span> <span class=n>hIcon</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>memcpy</span><span class=p>(</span><span class=n>buttons</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>szTip</span><span class=p>,</span> <span class=n>TEXT</span><span class=p>(</span><span class=s>&#34;Tooltip&#34;</span><span class=p>),</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>buttons</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>szTip</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>pTaskbar</span><span class=o>-&gt;</span><span class=n>ThumbBarAddButtons</span><span class=p>(</span><span class=n>GetSafeHwnd</span><span class=p>(),</span> <span class=mi>3</span><span class=p>,</span> <span class=n>buttons</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 最后释放COM组件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>CoUninitialize</span><span class=p>();</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=未完待续持续更新中>未完待续，持续更新中&mldr;<a hidden class=anchor aria-hidden=true href=#未完待续持续更新中>#</a></h2><p><strong>参考</strong></p><p><a href=https://blog.csdn.net/wgxh05/article/details/83415463>MFC简单的启动时隐藏界面方式(仅启动时隐藏)</a></p><p><a href=https://docs.microsoft.com/zh-cn/windows/win32/controls/cookbook-overview>Enabling Visual Styles</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://kira-96.github.io/tags/mfc/>MFC</a></li></ul><nav class=paginav><a class=prev href=https://kira-96.github.io/posts/%E4%B8%89%E7%BB%B4%E5%9B%BE%E5%BD%A2%E7%9F%A9%E9%98%B5%E5%8F%98%E6%8D%A2/><span class=title>« 上一页</span><br><span>三维图形矩阵变换</span>
</a><a class=next href=https://kira-96.github.io/posts/%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96windows10%E4%B8%BB%E9%A2%98%E9%A2%9C%E8%89%B2/><span class=title>下一页 »</span><br><span>如何获取Windows10主题颜色</span></a></nav></footer><script src=https://utteranc.es/client.js repo=kira-96/kira-96.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></article></main><footer class=footer><span>Copyright © 2019-2024 <a href=/>kira&rsquo;s blog</a> ·</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>