<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>龙芯开发板移植 IgH EtherCAT Master | ✨kiraの博客</title>
<meta name=keywords content="linux,EPICS,EtherCAT,龙芯"><meta name=description content="龙芯2K0500开发板移植EtherCAT主站程序和EPICS EtherCAT模块"><meta name=author content><link rel=canonical href=https://kira-96.github.io/posts/%E9%BE%99%E8%8A%AF%E5%BC%80%E5%8F%91%E6%9D%BF%E7%A7%BB%E6%A4%8Digh-ethercat-master/><link crossorigin=anonymous href=/assets/css/stylesheet.3885277a87a498ed2522e7ff68054e29ab8db4095b653379837d1193311cfcc9.css integrity="sha256-OIUneoekmO0lIuf/aAVOKauNtAlbZTN5g30RkzEc/Mk=" rel="preload stylesheet" as=style><link rel=icon href=https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/favicon-32x32.png><link rel=apple-touch-icon href=https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/icons/apple-icon-180x180.png><link rel=mask-icon href=https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/icons/apple-icon-76x76.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://kira-96.github.io/posts/%E9%BE%99%E8%8A%AF%E5%BC%80%E5%8F%91%E6%9D%BF%E7%A7%BB%E6%A4%8Digh-ethercat-master/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=manifest href=https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/manifest.json><script src=https://fastly.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js></script><script type=text/javascript src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><meta property="og:title" content="龙芯开发板移植 IgH EtherCAT Master"><meta property="og:description" content="龙芯2K0500开发板移植EtherCAT主站程序和EPICS EtherCAT模块"><meta property="og:type" content="article"><meta property="og:url" content="https://kira-96.github.io/posts/%E9%BE%99%E8%8A%AF%E5%BC%80%E5%8F%91%E6%9D%BF%E7%A7%BB%E6%A4%8Digh-ethercat-master/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-02-23T12:54:31+08:00"><meta property="article:modified_time" content="2024-03-12T15:57:25+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="龙芯开发板移植 IgH EtherCAT Master"><meta name=twitter:description content="龙芯2K0500开发板移植EtherCAT主站程序和EPICS EtherCAT模块"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://kira-96.github.io/posts/"},{"@type":"ListItem","position":2,"name":"龙芯开发板移植 IgH EtherCAT Master","item":"https://kira-96.github.io/posts/%E9%BE%99%E8%8A%AF%E5%BC%80%E5%8F%91%E6%9D%BF%E7%A7%BB%E6%A4%8Digh-ethercat-master/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"龙芯开发板移植 IgH EtherCAT Master","name":"龙芯开发板移植 IgH EtherCAT Master","description":"龙芯2K0500开发板移植EtherCAT主站程序和EPICS EtherCAT模块","keywords":["linux","EPICS","EtherCAT","龙芯"],"articleBody":"前言 IgH EtherCAT Master 是一个开源的EtherCAT主站驱动程序，用于管理EtherCAT从站设备，支持Linux操作系统，工控上使用的比较多。\ndls ethercat是由英国钻石光源开发的用于 EPICS 控制系统 EtherCAT 设备的支持程序，基于 IgH Master 主站程序开发，实现对 EtherCAT 总线设备的读写。\n交叉编译环境：Ubuntu\n运行开发板：龙芯2K0500金龙开发板\n内核版本：Linux LS-GD 5.10.0-rt17.lsgd #1 PREEMPT_RT\n相关软件包下载地址 epics-base - (launchpad.net) / epics-base/epics-base / EPICS Base (anl.gov)\nepics-modules/asyn: EPICS module for driver and device support\nepics-modules/busy: APS BCDA synApps module: busy\nepics-modules/autosave: APS BCDA synApps module: autosave\ndls-controls/ethercat: EPICS support to read/write to ethercat based hardware\nIgH EtherCAT Master for Linux\nPREEMPT RT patch\n配置交叉编译环境 关于这一节，之前的文章已经详细讲过，参考配置交叉编译环境。\n如果你使用的是其他开发套件，请按照开发手册安装配置好环境。\n编译 IgH EtherCAT Master 源码一定要下载 stable-1.5 分支的，其他版本我也没有测试！\n打补丁 1 2 3 4 5 6 7 # 先将补丁复制到ethercat驱动源码下 cp ethercat-master/etc/makeDocumentation/configurable-error-suppression.patch ethercat-stable-1.5/ cd ethercat-stable-1.5/ # 打补丁 patch -p1 \u003c configurable-error-suppression.patch # 这里需要注意一下patch的输出结果 由于补丁的时间比较早，跟现有的源码不太匹配，有些地方补丁会失败（FAILED）。比如我这里的报错，可能需要再手动修改一下。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 patching file lib/Makefile.am Hunk #1 succeeded at 32 (offset -2 lines). patching file lib/common.c patching file lib/domain.c patching file lib/liberror-documentation.txt patching file lib/liberror.c patching file lib/liberror.h patching file lib/master.c Hunk #1 succeeded at 37 (offset -2 lines). ... Hunk #12 FAILED at 419. Hunk #13 FAILED at 448. ... 2 out of 31 hunks FAILED -- saving rejects to file lib/master.c.rej patching file lib/reg_request.c Hunk #1 succeeded at 39 (offset -2 lines). ... patching file lib/sdo_request.c Hunk #1 succeeded at 39 (offset -2 lines). ... patching file lib/slave_config.c Hunk #1 succeeded at 39 (offset -1 lines). ... patching file lib/voe_handler.c Hunk #1 succeeded at 40 (offset -2 lines). ... 我们参考lib/master.c.rej，手动修改一下。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 # lib/master.c.rej --- lib/master.c\tTue Feb 12 17:31:08 2013 +0100 +++ lib/master.c\tMon Mar 23 15:52:53 2015 +0000 @@ -419,7 +431,8 @@ if (EC_IOCTL_ERRNO(ret) == EIO \u0026\u0026 abort_code) { *abort_code = download.abort_code; } - fprintf(stderr, \"Failed to execute SDO download: %s\\n\", + ecrt_errcode = ECRT_ERRMASTERSDODOWNLOAD; + ERRPRINTF(\"Failed to execute SDO download: %s\\n\", strerror(EC_IOCTL_ERRNO(ret))); return -EC_IOCTL_ERRNO(ret); } @@ -448,7 +461,8 @@ if (EC_IOCTL_ERRNO(ret) == EIO \u0026\u0026 abort_code) { *abort_code = download.abort_code; } - fprintf(stderr, \"Failed to execute SDO download: %s\\n\", + ecrt_errcode = ECRT_ERRMASTERSDODOWNLOADCOMPLETE; + ERRPRINTF(\"Failed to execute SDO download: %s\\n\", strerror(EC_IOCTL_ERRNO(ret))); return -EC_IOCTL_ERRNO(ret); } 然后这个补丁还有点问题，我们需要手动修改一下lib/liberror.c。这里源文件和头文件变量定义不一致，编译会报错，以头文件为准。\n1 2 3 4 5 6 7 #include \"liberror.h\" int ecrt_err_to_stderr = 1; // char *ecrt_errstring[ERRSTRING_LEN]; char ecrt_errstring[ERRSTRING_LEN]; int ecrt_errcode; 准备内核源码 由于需要将源码编译成相应的系统驱动，所以这里需要使用内核的源码。\n如果是标准系统，可以直接安装linux-headers。\n1 2 # Ubuntu/Debian sudo apt install linux-headers-$(uname -r) 树莓派系统\n1 sudo apt install raspberrypi-kernel-headers 而对于开发板系统，我们可以使用随开发板提供的内核源码。\n内核的编译步骤请根据开发板的用户手册完成。\n最好再给内核打上 PREEMPT_RT 补丁。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 # 解压内核源码 tar -xvf linux-5.10-2k500-src-f45937d-build.20230721100738.tar.gz # linux-5.10-2k500-cbd-src cd linux-5.10-2k500-cbd-src/ # 为内核打上实时补丁（可选） patch -p1 \u003c patch-5.10-rt17.patch # 配置交叉编译器 ./set_env.sh # 编译内核 make loongson_2k500_defconfig # make menuconfig make uImage # 编译模块 make modules 编译 EtherCAT Master 驱动 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 cd ethercat-stable-1.5/ # to create the configure script, if downloaded from the repo ./bootstrap # 这里需要注意是否出现报错，需要安装 autoconf、pkg-config 等工具 # 执行configure # --host 指定程序运行的主机架构 # --with-linux-dir 指定源码目录 # 如果是安装的linux-headers，通常在 /usr/src/linux-headers-xxx # 如果直接使用内核源码，则必须通过上述编译步骤！ # --prefix 指定安装目录 ./configure --host=loongarch64-linux-gnu CC=loongarch64-linux-gnu-gcc --enable-generic=yes --enable-8139too=no --with-linux-dir=/path/to/linux-5.10-2k500-cbd-src --prefix=/path/to/__install_dir # 编译 make all modules # 或者 # make # make ARCH=loongarch CORSS_COMPILE=loongarch64-linux-gnu- modules # 安装生成的文件 # make install 如果完全按照上述步骤，应该可以编译成功。\n下面整理一下生成的文件。\n1 2 3 4 5 # 复制生成的主程序 cp tool/ethercat /path/to/__install_dir/bin/ # 复制生成的驱动程序 cp device/ec_generic.ko /path/to/__install_dir/modules/ cp master/ec_master.ko /path/to/__install_dir/modules/ 这是我整理的文件，后面需要将这些文件下载到开发板。\n__install_dir ├─ bin │ └─ ethercat (主程序) ├─ etc (配置) ├─ include (头文件) ├─ lib (libethercat.so) ├─ modules (驱动目录) │ ├─ ec_master.ko │ └─ ec_generic.ko ├─ sbin │ └─ ethercatctl └─ share └─ bash-completion/ (bash自动补全) 编译 EPICS ethercat 模块 以下步骤需要先安装好EPICS Base!\n编译 asyn 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 cd asyn touch configure/RELEASE.local vi configure/RELEASE.local # 修改成和EPICS Base一样的架构 EPICS_HOST_ARCH=linux-la64 # EPICS Base路径（示例） EPICS_BASE=/home/ubuntu/loongson/base-7.0.8 # 放置EPICS模块的路径（示例） SUPPORT=/home/ubuntu/loongson/modules # SSCAN模块路径 # SSCAN=$(SUPPORT)/sscan # CALC模块路径 # CALC=$(SUPPORT)/calc # 直接编译 # make # 交叉编译（示例） make LD=loongarch64-linux-gnu-ld CC=loongarch64-linux-gnu-gcc CCC=loongarch64-linux-gnu-g++ 编译 autosave 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 cd autosave touch configure/RELEASE.local vi configure/RELEASE.local # 修改成和EPICS Base一样的架构 EPICS_HOST_ARCH=linux-la64 # EPICS Base路径（示例） EPICS_BASE=/home/ubuntu/loongson/base-7.0.8 # 放置EPICS模块的路径（示例） SUPPORT=/home/ubuntu/loongson/modules # 直接编译 # make # 交叉编译（示例） make LD=loongarch64-linux-gnu-ld CC=loongarch64-linux-gnu-gcc CCC=loongarch64-linux-gnu-g++ 编译 busy 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 cd busy touch configure/RELEASE.local vi configure/RELEASE.local # 修改成和EPICS Base一样的架构 EPICS_HOST_ARCH=linux-la64 # EPICS Base路径（示例） EPICS_BASE=/home/ubuntu/loongson/base-7.0.8 # 放置EPICS模块的路径（示例） SUPPORT=/home/ubuntu/loongson/modules # ASYN模块路径 ASYN=$(SUPPORT)/asyn # AUTOSAVE模块路径 AUTOSAVE=$(SUPPORT)/autosave # BUSY模块路径 BUSY=$(SUPPORT)/busy # 直接编译 # make # 交叉编译（示例） make LD=loongarch64-linux-gnu-ld CC=loongarch64-linux-gnu-gcc CCC=loongarch64-linux-gnu-g++ 编译 ethercat 这一步可以说是最麻烦，问题最多的。编译出什么问题都需要去找到相应的Makefile修改。\n由于该软件包已经长时间无人维护，建议使用我修改过的版本。\n首先需要安装所需的包libxml2-dev。但我们实际上并不需要用这个软件包，我们只需要它的头文件。\n软件依赖的动态库(.so)文件，我们则需要从开发板系统中拷贝出来，无法直接用编译电脑的动态库。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 cd ethercat-master/ # 创建 3rd 目录，用于放置所需的头文件和动态库 mkdir 3rd mkdir 3rd/include mkdir 3rd/lib # 安装 libxml2-dev sudo apt install libxml2-dev # 从系统目录中复制出libxml2的头文件 # 因为还需要做一些修改，不能直接使用 cp -r /usr/include/libxml2/ ./3rd/include/ # 复制刚刚编译生成的 libethercat cp /path/to/__install_dir/lib/libethercat.so* ./3rd/lib/ # 从开发板系统复制所需要的动态库 # libxml2 依赖 libz 和 liblzma scp root@192.168.1.10:/usr/lib/libxml2.so.2.9.12 ./3rd/lib/ scp root@192.168.1.10:/usr/lib/libz.so.1.2.11 ./3rd/lib/ scp root@192.168.1.10:/usr/lib/liblzma.so.5.2.5 ./3rd/lib/ # 手动创建一下链接 cd 3rd/lib/ ln -s libxml2.so.2.9.12 libxml2.so.2 ln -s libxml2.so.2 libxml2.so ln -s liblzma.so.5.2.5 liblzma.so.5 ln -s liblzma.so.5 liblzma.so ln -s libz.so.1.2.11 libz.so.1 ln -s libz.so.1 libz.so 然后需要修改一下libxml2的头文件，不然编译的时候会报错。\n报错信息：\n1 2 3 4 5 6 7 8 9 10 In file included from ../../../libxml2/libxml/parser.h:812, from ../../../libxml2/libxml/globals.h:18, from ../../../libxml2/libxml/threads.h:35, from ../../../libxml2/libxml/xmlmemory.h:218, from ../../../libxml2/libxml/tree.h:1307, from ../parser.c:10: ../../../libxml2/libxml/encoding.h:31:10: fatal error: unicode/ucnv.h: No such file or directory #include ^~~~~~~~~~~~~~~~ compilation terminated. 解决方法：\n1 2 3 4 5 6 # 修改 xmlversion.h vi 3rd/include/libxml2/libxml/xmlversion.h # 找到下面行，禁用 LIBXML_ICU_ENABLED #define LIBXML_ICU_ENABLED # 将 #if 1 改为 #if 0 1 2 3 4 5 6 7 8 9 /** * LIBXML_ICU_ENABLED: * * Whether icu support is available */ - #if 0 + #if 1 #define LIBXML_ICU_ENABLED #endif 做好上面的准备工作，还需要修改源码中的路径配置，然后才能正常编译。\n下面都是我踩坑留下的记录。\n修改 configure/RELEASE 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 cd ethercat-master/ # 首先修改 configure/RELEASE vi configure/RELEASE # 需要修改的有4项 # 放置EPICS模块的路径（示例） SUPPORT=/home/ubuntu/loongson/modules # ASYN模块路径 ASYN=$(SUPPORT)/asyn # BUSY模块路径 BUSY=$(SUPPORT)/busy # 修改成和EPICS Base一样的架构 EPICS_HOST_ARCH=linux-la64 # EPICS Base路径（示例） EPICS_BASE=/home/ubuntu/loongson/base-7.0.8 修改 ethercatApp/scannerSrc/Makefile 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 cd ethercat-master/ # 修改 ethercatApp/scannerSrc/Makefile vi ethercatApp/scannerSrc/Makefile # 需要修改 EtherCAT Master 源码相关路径、 # libxml2头文件路径、动态库(.so)路径 # 修改 ETHERLAB 源码路径 ETHERLAB=/path/to/ethercat-stable-1.5 ETHERLABPREFIX=$(ETHERLAB) USR_INCLUDES += -I$(ETHERLABPREFIX)/include # 修改动态库路径 USR_LDFLAGS += -L$(TOP)/3rd/lib -Wl,-rpath=$(TOP)/3rd/lib # 修改 libxml2 头文件路径 USR_INCLUDES += -I$(TOP)/3rd/include/libxml2 USR_SYS_LIBS += ethercat xml2 # 下面类似 scanner_INCLUDES += -I$(ETHERLAB)/lib serialtool_INCLUDES += -I$(ETHERLAB)/master get-slave-revisions_INCLUDES += -I$(ETHERLAB)/master 修改 ethercatApp/src/Makefile，与上面类似。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 cd ethercat-master/ # 修改 ethercatApp/src/Makefile vi ethercatApp/src/Makefile # 需要修改 EtherCAT Master 源码相关路径、 # libxml2头文件路径、动态库(.so)路径 # 修改 ETHERLAB 源码路径 ETHERLAB=/path/to/ethercat-stable-1.5 # ecAsyn_INCLUDES += -I$(ETHERLAB)/src/ethercat-$(subst -,.,$(VERSION))/include # gadc_INCLUDES += -I$(ETHERLAB)/src/ethercat-$(subst -,.,$(VERSION))/include ecAsyn_INCLUDES += -I$(ETHERLAB)/include gadc_INCLUDES += -I$(ETHERLAB)/include # 修改 libxml2 头文件路径 USR_INCLUDES += -I$(TOP)/3rd/include/libxml2 # 添加动态库路径 USR_LDFLAGS += -L$(TOP)/3rd/lib -Wl,-rpath=$(TOP)/3rd/lib USR_SYS_LIBS += xml2 修改源码 由于ethercat-master的源码原本是为x86_64架构编写的，编译到LoongArch架构的设备上运行可能会出现一些奇怪的错误。\n例如，在运行slaveinfo时会出现Segmentation fault错误，而这通常是空指针导致内存访问出错。\n原因分析：\nslaveinfo在运行时会根据程序自己的路径寻找slave-types.txt文件，问题就出在这里。来看源码 ethercatApp/scannerSrc/slave-list-path.c。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // ethercatApp/scannerSrc/slave-list-path.c int get_root_dir_index(const char *program_name) { // Search for the binary path char binary_dir[] = \"bin/linux-x86_64/\"; // Find the binary path in the program path and return the pointer char *found = strstr(program_name, binary_dir); // Handle the case where it is not found if (found == NULL) { return -1; } // Calculate the difference in the pointers to get the index return found - program_name; } 这个get_root_dir_index函数是用于计算当前程序(slaveinfo)所在的根目录。这里向上查找的路径为bin/linux-x86_64，当然不能找到LoongArch的目录bin/linux-la64了。所以，此函数只在路径为bin/linux-x86_64/slaveinfo时才能正常运行，其它情况都返回-1。（第一次见到这样写的，真无语了……）\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 // ethercatApp/scannerSrc/slave-list-path.c char *get_slave_list_filename(const char *program_path) { char relative_path[] = \"etc/scripts/slave-types.txt\"; char *slave_list_filename = NULL; // Get absolute path of application char *real_path = calloc(PATH_MAX, sizeof(char)); get_app_path(program_path, real_path); // Get root directory int root_dir_index = get_root_dir_index(real_path); if (root_dir_index != -1) { slave_list_filename = calloc(root_dir_index + strlen(relative_path) + 1, sizeof(char)); strncpy(slave_list_filename, real_path, root_dir_index); } // Append relative path strcat(slave_list_filename, relative_path); // Check file struct stat fstat; int result = stat(slave_list_filename, \u0026fstat); if (result) { printf(\"Could not find slave list file at %s\\n\", slave_list_filename); } // Cleanup free(real_path); return slave_list_filename; } 而在get_slave_list_filename函数中，只处理了get_root_dir_index正常返回的情况。当get_root_dir_index返回-1时，slave_list_filename始终为NULL，这就导致后续操作出错。\n其实这个问题直接把程序放到bin/linux-x86_64目录下运行就可以了，不过既然找到了问题，索性就改一改。\n现在已经知道了出错的地方，该如何修改呢？这里我本着尽量少改动源码的原则，在get_root_dir_index查找根目录出错时，直接使用当前目录。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 char *get_slave_list_filename(const char *program_path) { char relative_path[] = \"etc/scripts/slave-types.txt\"; char *slave_list_filename = NULL; // Get absolute path of application char *real_path = calloc(PATH_MAX, sizeof(char)); get_app_path(program_path, real_path); // Get root directory int root_dir_index = get_root_dir_index(real_path); if (root_dir_index != -1) { slave_list_filename = calloc(root_dir_index + strlen(relative_path) + 1, sizeof(char)); strncpy(slave_list_filename, real_path, root_dir_index); } + else + { + slave_list_filename = calloc(PATH_MAX, sizeof(char)); + if (NULL != getcwd(slave_list_filename, PATH_MAX)) + { + strcat(slave_list_filename, \"/\"); + } + } // Append relative path strcat(slave_list_filename, relative_path); // Check file struct stat fstat; int result = stat(slave_list_filename, \u0026fstat); if (result) { printf(\"Could not find slave list file at %s\\n\", slave_list_filename); } // Cleanup free(real_path); return slave_list_filename; } 目前只发现了这个问题，希望后面没有坑了。\n编译 最后终于可以开始编译了。\n1 2 3 cd ethercat-master/ # 执行交叉编译 make LD=loongarch64-linux-gnu-ld CC=loongarch64-linux-gnu-gcc CCC=loongarch64-linux-gnu-g++ 到这里，编译过程还可能会出错，不过已经可以编译出我们所需要的东西了。\n最终编译得到scanner、slaveinfo程序就可以了。\n以下是我编译时的输出：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 ... Installing library ../../../lib/linux-la64/libscannerlib.a ... Installing created executable ../../../bin/linux-la64/serialtool Installing created executable ../../../bin/linux-la64/get-slave-revisions Installing created executable ../../../bin/linux-la64/scanner Installing created executable ../../../bin/linux-la64/slaveinfo Installing created executable ../../../bin/linux-la64/parsertest ... Installing shared library ../../../lib/linux-la64/libecAsyn.so Installing library ../../../lib/linux-la64/libecAsyn.a Installing created executable ../../../bin/linux-la64/parsertest ... Installing template file ../../../db/EK1100.template ... make -C ./protocol install make[2]: 进入目录“/home/deepin/ethercat-master/ethercatApp/protocol” make[2]: *** 没有规则可制作目标“install”。 停止。 make[2]: 离开目录“/home/deepin/ethercat-master/ethercatApp/protocol” make[1]: *** [/usr/local/epics/base-7.0.8/configure/RULES_DIRS:85：protocol.install] 错误 2 make[1]: 离开目录“/home/deepin/ethercat-master/ethercatApp” make: *** [/usr/local/epics/base-7.0.8/configure/RULES_DIRS:85：ethercatApp.install] 错误 2 最后的错误，我直接忽略了，因为已经得到了需要的可执行程序。\n整理一下编译生成的文件：\nethercat-master ├─ bin │ └─ linux-la64 ├─ db ├─ dbd └─ lib └─ linux-la64 测试运行 将整理好的文件下载到开发板后，我们测试运行一下。\n测试安装 EtherCAT 主站驱动程序。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 [root@LS-GD modules]# modinfo ec_generic.ko filename: /root/__install/modules/ec_generic.ko version: 1.5.2 unknown license: GPL description: EtherCAT master generic Ethernet device module author: Florian Pose srcversion: 848BB80F1C588A2FDA42EDB depends: ec_master name: ec_generic vermagic: 5.10.0-rt17.lsgd preempt_rt mod_unload modversions LOONGARCH 64BIT [root@LS-GD modules]# insmod ec_master.ko [root@LS-GD modules]# insmod ec_generic.ko [root@LS-GD modules]# lsmod Module Size Used by ec_generic 6427 0 ec_master 464125 1 ec_generic 测试ethercat主程序。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 [root@LS-GD tool]# ./ethercat Please specify a command! Usage: ethercat [OPTIONS] [ARGUMENTS] Commands (can be abbreviated): alias Write alias addresses. config Show slave configurations. crc CRC error register diagnosis. cstruct Generate slave PDO information in C language. data Output binary domain process data. debug Set the master's debug level. domains Show configured domains. download Write an SDO entry to a slave. eoe Display Ethernet over EtherCAT statictics. foe_read Read a file from a slave via FoE. foe_write Store a file on a slave via FoE. graph Output the bus topology as a graph. master Show master and Ethernet device information. pdos List Sync managers, PDO assignment and mapping. reg_read Output a slave's register contents. reg_write Write data to a slave's registers. rescan Rescan the bus. sdos List SDO dictionaries. sii_read Output a slave's SII contents. sii_write Write SII contents to a slave. slaves Display slaves on the bus. soe_read Read an SoE IDN from a slave. soe_write Write an SoE IDN to a slave. states Request application-layer states. upload Read an SDO entry from a slave. version Show version information. xml Generate slave information XML. Global options: --master -m Comma separated list of masters to select, ranges are allowed. Examples: '1,3', '5-7,9', '-3'. Default: '-' (all). --force -f Force a command. --quiet -q Output less information. --verbose -v Output more information. --help -h Show this help. Numerical values can be specified either with decimal (no prefix), octal (prefix '0') or hexadecimal (prefix '0x') base. Call 'ethercat --help' for command-specific help. Send bug reports to fp@igh.de. 测试scanner主程序。\n1 2 3 [root@LS-GD linux-la64]# chmod +x scanner [root@LS-GD linux-la64]# ./scanner usage: scanner [-m master_index] [-s] [-q] scanner.xml socket_path 可以看到，驱动程序和主程序都能在开发板上运行，说明已经编译完成了。\n安装 EtherCAT 主站到开发板系统 首先将编译好的EtherCAT Master下载到开发板系统，然后将各个目录下的文件放到相应的系统目录下。（这里我还以__install_dir的目录结构为例。）\n原文件/目录 系统文件/目录 bin/ethercat /usr/bin/ethercat etc/init.d/ethercat /etc/init.d/ethercat etc/sysconfig/ethercat /etc/sysconfig/ethercat etc/ethercat.conf /etc/ethercat.conf include/ - lib/libethercat.so* /usr/lib/libethercat.so* modules/ /lib/modules/5.10.0-rt17.lsgd/ sbin/ethercatctl /sbin/ethercatctl share/bash-completion/ usr/share/bash-completion/ 注意：如果系统目录存在/lib/modules/{内核版本}目录，则可以将modules目录下的ec_master.ko和ec_generic.ko复制到该目录下，然后在终端执行depmod命令。否则，可以按照下面的步骤做相应修改。\n例如，将modules下的驱动文件放到开发板文件系统的/root/modules/目录下。\n修改/etc/init.d/ethercat和/sbin/ethercatctl脚本文件。\n例：/etc/init.d/ethercat\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 LSMOD=/sbin/lsmod MODPROBE=/sbin/modprobe + INSMOD=/sbin/insmod RMMOD=/sbin/rmmod MODINFO=/sbin/modinfo - ETHERCAT=/home/loongson/__install_dir/bin/ethercat + ETHERCAT=/usr/bin/ethercat MASTER_ARGS= + MODULE_DIR=/root/modules start) echo -n \"Starting EtherCAT master 1.5.2 \" ... # load master module - if ! ${MODPROBE} ${MODPROBE_FLAGS} ec_master \"${MASTER_ARGS}\" \\ + if ! ${INSMOD} ${MODULE_DIR}/ec_master.ko \"${MASTER_ARGS}\" \\ main_devices=\"${DEVICES}\" backup_devices=\"${BACKUPS}\"; then exit_fail fi # check for modules to replace for MODULE in ${DEVICE_MODULES}; do ECMODULE=ec_${MODULE} - if ! ${MODINFO} \"${ECMODULE}\" \u003e /dev/null; then - continue # ec_* module not found - fi if [ \"${MODULE}\" != \"generic\" ]; then if ${LSMOD} | grep \"^${MODULE} \" \u003e /dev/null; then if ! ${RMMOD} \"${MODULE}\"; then exit_fail fi fi fi - if ! ${MODPROBE} ${MODPROBE_FLAGS} \"${ECMODULE}\"; then + if ! ${INSMOD} \"${MODULE_DIR}/${ECMODULE}.ko\"; then if [ \"${MODULE}\" != \"generic\" ]; then ${MODPROBE} ${MODPROBE_FLAGS} \"${MODULE}\" # try to restore fi exit_fail fi done exit_success ;; 例：/sbin/ethercatctl\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 LSMOD=/sbin/lsmod MODPROBE=/sbin/modprobe + INSMOD=/sbin/insmod RMMOD=/sbin/rmmod MODINFO=/sbin/modinfo IP=/bin/ip - ETHERCAT=/home/loongson/__install_dir/bin/ethercat + ETHERCAT=/usr/bin/ethercat + MODULE_DIR=/root/modules #------------------------------------------------------------------------------ - ETHERCAT_CONFIG=/home/loongson/__install_dir/etc/ethercat.conf + ETHERCAT_CONFIG=/etc/ethercat.conf start) ... # load master module - if ! ${MODPROBE} ${MODPROBE_FLAGS} ec_master \\ + if ! ${INSMOD} ${MODULE_DIR}/ec_master.ko \\ main_devices=\"${DEVICES}\" backup_devices=\"${BACKUPS}\"; then exit 1 fi LOADED_MODULES=ec_master # check for modules to replace for MODULE in ${DEVICE_MODULES}; do ECMODULE=ec_${MODULE} - if ! ${MODINFO} \"${ECMODULE}\" \u003e /dev/null; then - continue # ec_* module not found - fi if [ \"${MODULE}\" != \"generic\" ] \u0026\u0026 [ \"${MODULE}\" != \"ccat\" ]; then # unload standard module and check if unloading was successful ${RMMOD} \"${MODULE}\" 2\u003e /dev/null || true if ${LSMOD} | grep \"^${MODULE} \" \u003e /dev/null; then # could not unload module ${RMMOD} ${LOADED_MODULES} exit 1 fi fi - if ! ${MODPROBE} ${MODPROBE_FLAGS} \"${ECMODULE}\"; then + if ! ${INSMOD} \"${MODULE_DIR}/${ECMODULE}.ko\"; then if [ \"${MODULE}\" != \"generic\" ] \u0026\u0026 [ \"${MODULE}\" != \"ccat\" ]; then ${MODPROBE} ${MODPROBE_FLAGS} \"${MODULE}\" # try to restore fi ${RMMOD} ${LOADED_MODULES} exit 1 fi LOADED_MODULES=\"${ECMODULE} ${LOADED_MODULES}\" done exit 0 ;; 修改 EtherCAT Master 配置文件。\n例：/etc/sysconfig/ethercat和/etc/ethercat.conf\n1 2 3 4 5 6 MASTER0_DEVICE=\"00:11:22:33:44:55\" #MASTER1_DEVICE=\"\" #MASTER0_BACKUP=\"\" DEVICE_MODULES=\"generic\" MASTER_DEVICE配置网卡的物理地址（MAC），可通过ifconfig命令查看。\nDEVICE_MODULES配置使用的模块名称，这里仅使用通用网卡驱动generic。\n运行 EtherCAT Master 启动EtherCAT主站程序。\n1 2 3 /etc/init.d/ethercat start # 或者 /sbin/ethercatctl start 如果一切正常，可以看到/dev目录下有EtherCAT0设备文件。\n查看主站信息\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 [root@LS-GD ~]# ethercat master Master0 Phase: Idle Active: no Slaves: 1 Ethernet devices: Main: 00:11:22:33:44:55 (attached) Link: UP Tx frames: 370862 Tx bytes: 22319896 Rx frames: 370861 Rx bytes: 22319836 Tx errors: 0 Tx frame rate [1/s]: 125 125 125 Tx rate [KByte/s]: 7.3 7.3 7.3 Rx frame rate [1/s]: 125 125 125 Rx rate [KByte/s]: 7.3 7.3 7.3 Common: Tx frames: 1108336 Tx bytes: 66704720 Rx frames: 1108307 Rx bytes: 66702980 Lost frames: 29 Tx frame rate [1/s]: 125 125 125 Tx rate [KByte/s]: 7.3 7.3 7.3 Rx frame rate [1/s]: 125 125 125 Rx rate [KByte/s]: 7.3 7.3 7.3 Loss rate [1/s]: 0 0 0 Frame loss [%]: 0.0 0.0 0.0 Distributed clocks: Reference clock: Slave 0 DC reference time: 0 Application time: 0 2000-01-01 00:00:00.000000000 查看从站设备\n1 2 [root@LS-GD ~]# ethercat slaves 0 0:0 PREOP + XB6-EC0002(Modules/Slots and MDP) 生成从站信息XML文件\n1 [root@LS-GD ~]# ethercat xml \u003e scanner.xml 其他ethercat命令\n使用ethercat -h命令查看其他命令的使用方法。\n参考 IgH EtherCAT Master Building and installing IgH EtherCAT Master IgH EtherCAT Master for Linux EtherCAT DRIVER AND TOOLS FOR EPICS AND LINUX AT PSI INTEGRATION OF EtherCAT HARDWARE INTO THE EPICS BASED DISTRIBUTED CONTROL SYSTEM AT iThemba LABS 在“福珑2.0”主机上编译EPICS Ehtercat驱动软件的体验 ","wordCount":"2759","inLanguage":"zh","datePublished":"2024-02-23T12:54:31+08:00","dateModified":"2024-03-12T15:57:25+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://kira-96.github.io/posts/%E9%BE%99%E8%8A%AF%E5%BC%80%E5%8F%91%E6%9D%BF%E7%A7%BB%E6%A4%8Digh-ethercat-master/"},"publisher":{"@type":"Organization","name":"✨kiraの博客","logo":{"@type":"ImageObject","url":"https://cdn.jsdelivr.net/gh/kira-96/kira-96.github.io@gh-pages/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://kira-96.github.io/ accesskey=h title="✨kiraの博客 (Alt + H)">✨kiraの博客</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://kira-96.github.io/ title=🏠主页><span>🏠主页</span></a></li><li><a href=https://kira-96.github.io/notes/ title=📓笔记><span>📓笔记</span></a></li><li><a href=https://kira-96.github.io/search/ title=🔍️搜索><span>🔍️搜索</span></a></li><li><a href=https://kira-96.github.io/archives/ title=🗃️存档><span>🗃️存档</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://kira-96.github.io/>主页</a>&nbsp;»&nbsp;<a href=https://kira-96.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">龙芯开发板移植 IgH EtherCAT Master</h1><div class=post-description>龙芯2K0500开发板移植EtherCAT主站程序和EPICS EtherCAT模块</div><div class=post-meta><span title='2024-02-23 12:54:31 +0800 +0800'>二月 23, 2024</span>&nbsp;·&nbsp;13 分钟&nbsp;·&nbsp;2759 字&nbsp;|&nbsp;<a href=https://github.com/kira-96/kira-96.github.io/tree/main/content/posts/ rel="noopener noreferrer" target=_blank>✏️编辑</a></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e5%89%8d%e8%a8%80 aria-label=前言>前言</a></li><li><a href=#%e7%9b%b8%e5%85%b3%e8%bd%af%e4%bb%b6%e5%8c%85%e4%b8%8b%e8%bd%bd%e5%9c%b0%e5%9d%80 aria-label=相关软件包下载地址>相关软件包下载地址</a></li><li><a href=#%e9%85%8d%e7%bd%ae%e4%ba%a4%e5%8f%89%e7%bc%96%e8%af%91%e7%8e%af%e5%a2%83 aria-label=配置交叉编译环境>配置交叉编译环境</a></li><li><a href=#%e7%bc%96%e8%af%91-igh-ethercat-master aria-label="编译 IgH EtherCAT Master">编译 IgH EtherCAT Master</a><ul><li><a href=#%e6%89%93%e8%a1%a5%e4%b8%81 aria-label=打补丁>打补丁</a></li><li><a href=#%e5%87%86%e5%a4%87%e5%86%85%e6%a0%b8%e6%ba%90%e7%a0%81 aria-label=准备内核源码>准备内核源码</a></li><li><a href=#%e7%bc%96%e8%af%91-ethercat-master-%e9%a9%b1%e5%8a%a8 aria-label="编译 EtherCAT Master 驱动">编译 EtherCAT Master 驱动</a></li></ul></li><li><a href=#%e7%bc%96%e8%af%91-epics-ethercat-%e6%a8%a1%e5%9d%97 aria-label="编译 EPICS ethercat 模块">编译 EPICS ethercat 模块</a><ul><li><a href=#%e7%bc%96%e8%af%91-asyn aria-label="编译 asyn">编译 asyn</a></li><li><a href=#%e7%bc%96%e8%af%91-autosave aria-label="编译 autosave">编译 autosave</a></li><li><a href=#%e7%bc%96%e8%af%91-busy aria-label="编译 busy">编译 busy</a></li><li><a href=#%e7%bc%96%e8%af%91-ethercat aria-label="编译 ethercat">编译 ethercat</a></li></ul></li><li><a href=#%e6%b5%8b%e8%af%95%e8%bf%90%e8%a1%8c aria-label=测试运行>测试运行</a></li><li><a href=#%e5%ae%89%e8%a3%85-ethercat-%e4%b8%bb%e7%ab%99%e5%88%b0%e5%bc%80%e5%8f%91%e6%9d%bf%e7%b3%bb%e7%bb%9f aria-label="安装 EtherCAT 主站到开发板系统">安装 EtherCAT 主站到开发板系统</a></li><li><a href=#%e8%bf%90%e8%a1%8c-ethercat-master aria-label="运行 EtherCAT Master">运行 EtherCAT Master</a></li><li><a href=#%e5%8f%82%e8%80%83 aria-label=参考>参考</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=前言>前言<a hidden class=anchor aria-hidden=true href=#前言>#</a></h2><p>IgH EtherCAT Master 是一个开源的EtherCAT主站驱动程序，用于管理EtherCAT从站设备，支持Linux操作系统，工控上使用的比较多。</p><p>dls ethercat是由英国钻石光源开发的用于 EPICS 控制系统 EtherCAT 设备的支持程序，基于 IgH Master 主站程序开发，实现对 EtherCAT 总线设备的读写。</p><p>交叉编译环境：Ubuntu</p><p>运行开发板：龙芯2K0500金龙开发板</p><p>内核版本：Linux LS-GD 5.10.0-rt17.lsgd #1 PREEMPT_RT</p><h2 id=相关软件包下载地址>相关软件包下载地址<a hidden class=anchor aria-hidden=true href=#相关软件包下载地址>#</a></h2><ul><li><p><a href=https://git.launchpad.net/epics-base>epics-base - (launchpad.net)</a> / <a href=https://github.com/epics-base/epics-base>epics-base/epics-base</a> / <a href=https://epics.anl.gov/base/index.php>EPICS Base (anl.gov)</a></p></li><li><p><a href=https://github.com/epics-modules/asyn>epics-modules/asyn: EPICS module for driver and device support</a></p></li><li><p><a href=https://github.com/epics-modules/busy>epics-modules/busy: APS BCDA synApps module: busy</a></p></li><li><p><a href=https://github.com/epics-modules/autosave>epics-modules/autosave: APS BCDA synApps module: autosave</a></p></li><li><p><a href=https://github.com/dls-controls/ethercat>dls-controls/ethercat: EPICS support to read/write to ethercat based hardware</a></p></li><li><p><a href=https://gitlab.com/etherlab.org/ethercat/-/tree/stable-1.5>IgH EtherCAT Master for Linux</a></p></li><li><p><a href=https://mirrors.tuna.tsinghua.edu.cn/kernel/projects/rt/>PREEMPT RT patch</a></p></li></ul><h2 id=配置交叉编译环境>配置交叉编译环境<a hidden class=anchor aria-hidden=true href=#配置交叉编译环境>#</a></h2><p>关于这一节，之前的文章已经详细讲过，参考<a href=../%E9%BE%99%E8%8A%AF2k500%E5%BC%80%E5%8F%91%E6%9D%BF%E4%B8%8A%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%91%BC%E5%90%B8%E7%81%AF%E6%95%88%E6%9E%9C/#%E9%85%8D%E7%BD%AE%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83>配置交叉编译环境</a>。</p><p>如果你使用的是其他开发套件，请按照开发手册安装配置好环境。</p><h2 id=编译-igh-ethercat-master>编译 IgH EtherCAT Master<a hidden class=anchor aria-hidden=true href=#编译-igh-ethercat-master>#</a></h2><p><strong>源码一定要下载 <em>stable-1.5</em> 分支的，其他版本我也没有测试！</strong></p><h3 id=打补丁>打补丁<a hidden class=anchor aria-hidden=true href=#打补丁>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 先将补丁复制到ethercat驱动源码下</span>
</span></span><span class=line><span class=cl>cp ethercat-master/etc/makeDocumentation/configurable-error-suppression.patch ethercat-stable-1.5/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>cd</span> ethercat-stable-1.5/
</span></span><span class=line><span class=cl><span class=c1># 打补丁</span>
</span></span><span class=line><span class=cl>patch -p1 &lt; configurable-error-suppression.patch
</span></span><span class=line><span class=cl><span class=c1># 这里需要注意一下patch的输出结果</span>
</span></span></code></pre></td></tr></table></div></div><p>由于补丁的时间比较早，跟现有的源码不太匹配，有些地方补丁会失败（FAILED）。比如我这里的报错，可能需要再手动修改一下。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>patching file lib/Makefile.am
</span></span><span class=line><span class=cl>Hunk <span class=c1>#1 succeeded at 32 (offset -2 lines).</span>
</span></span><span class=line><span class=cl>patching file lib/common.c
</span></span><span class=line><span class=cl>patching file lib/domain.c
</span></span><span class=line><span class=cl>patching file lib/liberror-documentation.txt
</span></span><span class=line><span class=cl>patching file lib/liberror.c
</span></span><span class=line><span class=cl>patching file lib/liberror.h
</span></span><span class=line><span class=cl>patching file lib/master.c
</span></span><span class=line><span class=cl>Hunk <span class=c1>#1 succeeded at 37 (offset -2 lines).</span>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>Hunk <span class=c1>#12 FAILED at 419.</span>
</span></span><span class=line><span class=cl>Hunk <span class=c1>#13 FAILED at 448.</span>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl><span class=m>2</span> out of <span class=m>31</span> hunks FAILED -- saving rejects to file lib/master.c.rej
</span></span><span class=line><span class=cl>patching file lib/reg_request.c
</span></span><span class=line><span class=cl>Hunk <span class=c1>#1 succeeded at 39 (offset -2 lines).</span>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>patching file lib/sdo_request.c
</span></span><span class=line><span class=cl>Hunk <span class=c1>#1 succeeded at 39 (offset -2 lines).</span>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>patching file lib/slave_config.c
</span></span><span class=line><span class=cl>Hunk <span class=c1>#1 succeeded at 39 (offset -1 lines).</span>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>patching file lib/voe_handler.c
</span></span><span class=line><span class=cl>Hunk <span class=c1>#1 succeeded at 40 (offset -2 lines).</span>
</span></span><span class=line><span class=cl>...
</span></span></code></pre></td></tr></table></div></div><p>我们参考<code>lib/master.c.rej</code>，手动修改一下。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl># lib/master.c.rej
</span></span><span class=line><span class=cl><span class=gd>--- lib/master.c	Tue Feb 12 17:31:08 2013 +0100
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+++ lib/master.c	Mon Mar 23 15:52:53 2015 +0000
</span></span></span><span class=line><span class=cl><span class=gi></span><span class=gu>@@ -419,7 +431,8 @@
</span></span></span><span class=line><span class=cl><span class=gu></span>         if (EC_IOCTL_ERRNO(ret) == EIO &amp;&amp; abort_code) {
</span></span><span class=line><span class=cl>             *abort_code = download.abort_code;
</span></span><span class=line><span class=cl>         }
</span></span><span class=line><span class=cl><span class=gd>-        fprintf(stderr, &#34;Failed to execute SDO download: %s\n&#34;,
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+        ecrt_errcode = ECRT_ERRMASTERSDODOWNLOAD;
</span></span></span><span class=line><span class=cl><span class=gi>+        ERRPRINTF(&#34;Failed to execute SDO download: %s\n&#34;,
</span></span></span><span class=line><span class=cl><span class=gi></span>             strerror(EC_IOCTL_ERRNO(ret)));
</span></span><span class=line><span class=cl>         return -EC_IOCTL_ERRNO(ret);
</span></span><span class=line><span class=cl>     }
</span></span><span class=line><span class=cl><span class=gu>@@ -448,7 +461,8 @@
</span></span></span><span class=line><span class=cl><span class=gu></span>         if (EC_IOCTL_ERRNO(ret) == EIO &amp;&amp; abort_code) {
</span></span><span class=line><span class=cl>             *abort_code = download.abort_code;
</span></span><span class=line><span class=cl>         }
</span></span><span class=line><span class=cl><span class=gd>-        fprintf(stderr, &#34;Failed to execute SDO download: %s\n&#34;,
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+        ecrt_errcode = ECRT_ERRMASTERSDODOWNLOADCOMPLETE;
</span></span></span><span class=line><span class=cl><span class=gi>+        ERRPRINTF(&#34;Failed to execute SDO download: %s\n&#34;,
</span></span></span><span class=line><span class=cl><span class=gi></span>             strerror(EC_IOCTL_ERRNO(ret)));
</span></span><span class=line><span class=cl>         return -EC_IOCTL_ERRNO(ret);
</span></span><span class=line><span class=cl>     }
</span></span></code></pre></td></tr></table></div></div><p>然后这个补丁还有点问题，我们需要手动修改一下<code>lib/liberror.c</code>。这里源文件和头文件变量定义不一致，编译会报错，以头文件为准。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;liberror.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>ecrt_err_to_stderr</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>// char *ecrt_errstring[ERRSTRING_LEN];
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>char</span> <span class=n>ecrt_errstring</span><span class=p>[</span><span class=n>ERRSTRING_LEN</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>ecrt_errcode</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=准备内核源码>准备内核源码<a hidden class=anchor aria-hidden=true href=#准备内核源码>#</a></h3><p>由于需要将源码编译成相应的系统驱动，所以这里需要使用内核的源码。</p><p>如果是标准系统，可以直接安装<code>linux-headers</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># Ubuntu/Debian</span>
</span></span><span class=line><span class=cl>sudo apt install linux-headers-<span class=k>$(</span>uname -r<span class=k>)</span>
</span></span></code></pre></td></tr></table></div></div><p>树莓派系统</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo apt install raspberrypi-kernel-headers
</span></span></code></pre></td></tr></table></div></div><p><strong>而对于开发板系统，我们可以使用随开发板提供的内核源码。</strong></p><p><em>内核的编译步骤请根据开发板的用户手册完成。</em></p><p><strong>最好再给内核打上 <code>PREEMPT_RT</code> 补丁。</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 解压内核源码</span>
</span></span><span class=line><span class=cl>tar -xvf linux-5.10-2k500-src-f45937d-build.20230721100738.tar.gz
</span></span><span class=line><span class=cl><span class=c1># linux-5.10-2k500-cbd-src</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> linux-5.10-2k500-cbd-src/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 为内核打上实时补丁（可选）</span>
</span></span><span class=line><span class=cl>patch -p1 &lt; patch-5.10-rt17.patch
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 配置交叉编译器</span>
</span></span><span class=line><span class=cl>./set_env.sh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 编译内核</span>
</span></span><span class=line><span class=cl>make loongson_2k500_defconfig
</span></span><span class=line><span class=cl><span class=c1># make menuconfig</span>
</span></span><span class=line><span class=cl>make uImage
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 编译模块</span>
</span></span><span class=line><span class=cl>make modules
</span></span></code></pre></td></tr></table></div></div><h3 id=编译-ethercat-master-驱动>编译 EtherCAT Master 驱动<a hidden class=anchor aria-hidden=true href=#编译-ethercat-master-驱动>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>cd</span> ethercat-stable-1.5/
</span></span><span class=line><span class=cl><span class=c1># to create the configure script, if downloaded from the repo</span>
</span></span><span class=line><span class=cl>./bootstrap
</span></span><span class=line><span class=cl><span class=c1># 这里需要注意是否出现报错，需要安装 autoconf、pkg-config 等工具</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 执行configure</span>
</span></span><span class=line><span class=cl><span class=c1># --host 指定程序运行的主机架构</span>
</span></span><span class=line><span class=cl><span class=c1># --with-linux-dir 指定源码目录</span>
</span></span><span class=line><span class=cl><span class=c1># 如果是安装的linux-headers，通常在 /usr/src/linux-headers-xxx</span>
</span></span><span class=line><span class=cl><span class=c1># 如果直接使用内核源码，则必须通过上述编译步骤！</span>
</span></span><span class=line><span class=cl><span class=c1># --prefix 指定安装目录</span>
</span></span><span class=line><span class=cl>./configure --host<span class=o>=</span>loongarch64-linux-gnu <span class=nv>CC</span><span class=o>=</span>loongarch64-linux-gnu-gcc --enable-generic<span class=o>=</span>yes --enable-8139too<span class=o>=</span>no --with-linux-dir<span class=o>=</span>/path/to/linux-5.10-2k500-cbd-src --prefix<span class=o>=</span>/path/to/__install_dir
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 编译</span>
</span></span><span class=line><span class=cl>make all modules
</span></span><span class=line><span class=cl><span class=c1># 或者</span>
</span></span><span class=line><span class=cl><span class=c1># make</span>
</span></span><span class=line><span class=cl><span class=c1># make ARCH=loongarch CORSS_COMPILE=loongarch64-linux-gnu- modules</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 安装生成的文件</span>
</span></span><span class=line><span class=cl><span class=c1># make install</span>
</span></span></code></pre></td></tr></table></div></div><p>如果完全按照上述步骤，应该可以编译成功。</p><p>下面整理一下生成的文件。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 复制生成的主程序</span>
</span></span><span class=line><span class=cl>cp tool/ethercat /path/to/__install_dir/bin/
</span></span><span class=line><span class=cl><span class=c1># 复制生成的驱动程序</span>
</span></span><span class=line><span class=cl>cp device/ec_generic.ko /path/to/__install_dir/modules/
</span></span><span class=line><span class=cl>cp master/ec_master.ko /path/to/__install_dir/modules/
</span></span></code></pre></td></tr></table></div></div><p>这是我整理的文件，后面需要将这些文件下载到开发板。</p><pre tabindex=0><code>__install_dir
├─ bin
│   └─ ethercat (主程序)
├─ etc (配置)
├─ include (头文件)
├─ lib (libethercat.so)
├─ modules (驱动目录)
│   ├─ ec_master.ko
│   └─ ec_generic.ko
├─ sbin
│   └─ ethercatctl
└─ share
    └─ bash-completion/ (bash自动补全)
</code></pre><h2 id=编译-epics-ethercat-模块>编译 <strong>EPICS</strong> ethercat 模块<a hidden class=anchor aria-hidden=true href=#编译-epics-ethercat-模块>#</a></h2><p><strong>以下步骤需要先安装好EPICS Base!</strong></p><h3 id=编译-asyn>编译 asyn<a hidden class=anchor aria-hidden=true href=#编译-asyn>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>cd</span> asyn
</span></span><span class=line><span class=cl>touch configure/RELEASE.local
</span></span><span class=line><span class=cl>vi configure/RELEASE.local
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 修改成和EPICS Base一样的架构</span>
</span></span><span class=line><span class=cl><span class=nv>EPICS_HOST_ARCH</span><span class=o>=</span>linux-la64
</span></span><span class=line><span class=cl><span class=c1># EPICS Base路径（示例）</span>
</span></span><span class=line><span class=cl><span class=nv>EPICS_BASE</span><span class=o>=</span>/home/ubuntu/loongson/base-7.0.8
</span></span><span class=line><span class=cl><span class=c1># 放置EPICS模块的路径（示例）</span>
</span></span><span class=line><span class=cl><span class=nv>SUPPORT</span><span class=o>=</span>/home/ubuntu/loongson/modules
</span></span><span class=line><span class=cl><span class=c1># SSCAN模块路径</span>
</span></span><span class=line><span class=cl><span class=c1># SSCAN=$(SUPPORT)/sscan</span>
</span></span><span class=line><span class=cl><span class=c1># CALC模块路径</span>
</span></span><span class=line><span class=cl><span class=c1># CALC=$(SUPPORT)/calc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 直接编译</span>
</span></span><span class=line><span class=cl><span class=c1># make</span>
</span></span><span class=line><span class=cl><span class=c1># 交叉编译（示例）</span>
</span></span><span class=line><span class=cl>make <span class=nv>LD</span><span class=o>=</span>loongarch64-linux-gnu-ld <span class=nv>CC</span><span class=o>=</span>loongarch64-linux-gnu-gcc <span class=nv>CCC</span><span class=o>=</span>loongarch64-linux-gnu-g++
</span></span></code></pre></td></tr></table></div></div><h3 id=编译-autosave>编译 autosave<a hidden class=anchor aria-hidden=true href=#编译-autosave>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>cd</span> autosave
</span></span><span class=line><span class=cl>touch configure/RELEASE.local
</span></span><span class=line><span class=cl>vi configure/RELEASE.local
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 修改成和EPICS Base一样的架构</span>
</span></span><span class=line><span class=cl><span class=nv>EPICS_HOST_ARCH</span><span class=o>=</span>linux-la64
</span></span><span class=line><span class=cl><span class=c1># EPICS Base路径（示例）</span>
</span></span><span class=line><span class=cl><span class=nv>EPICS_BASE</span><span class=o>=</span>/home/ubuntu/loongson/base-7.0.8
</span></span><span class=line><span class=cl><span class=c1># 放置EPICS模块的路径（示例）</span>
</span></span><span class=line><span class=cl><span class=nv>SUPPORT</span><span class=o>=</span>/home/ubuntu/loongson/modules
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 直接编译</span>
</span></span><span class=line><span class=cl><span class=c1># make</span>
</span></span><span class=line><span class=cl><span class=c1># 交叉编译（示例）</span>
</span></span><span class=line><span class=cl>make <span class=nv>LD</span><span class=o>=</span>loongarch64-linux-gnu-ld <span class=nv>CC</span><span class=o>=</span>loongarch64-linux-gnu-gcc <span class=nv>CCC</span><span class=o>=</span>loongarch64-linux-gnu-g++
</span></span></code></pre></td></tr></table></div></div><h3 id=编译-busy>编译 busy<a hidden class=anchor aria-hidden=true href=#编译-busy>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>cd</span> busy
</span></span><span class=line><span class=cl>touch configure/RELEASE.local
</span></span><span class=line><span class=cl>vi configure/RELEASE.local
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 修改成和EPICS Base一样的架构</span>
</span></span><span class=line><span class=cl><span class=nv>EPICS_HOST_ARCH</span><span class=o>=</span>linux-la64
</span></span><span class=line><span class=cl><span class=c1># EPICS Base路径（示例）</span>
</span></span><span class=line><span class=cl><span class=nv>EPICS_BASE</span><span class=o>=</span>/home/ubuntu/loongson/base-7.0.8
</span></span><span class=line><span class=cl><span class=c1># 放置EPICS模块的路径（示例）</span>
</span></span><span class=line><span class=cl><span class=nv>SUPPORT</span><span class=o>=</span>/home/ubuntu/loongson/modules
</span></span><span class=line><span class=cl><span class=c1># ASYN模块路径</span>
</span></span><span class=line><span class=cl><span class=nv>ASYN</span><span class=o>=</span><span class=k>$(</span>SUPPORT<span class=k>)</span>/asyn
</span></span><span class=line><span class=cl><span class=c1># AUTOSAVE模块路径</span>
</span></span><span class=line><span class=cl><span class=nv>AUTOSAVE</span><span class=o>=</span><span class=k>$(</span>SUPPORT<span class=k>)</span>/autosave
</span></span><span class=line><span class=cl><span class=c1># BUSY模块路径</span>
</span></span><span class=line><span class=cl><span class=nv>BUSY</span><span class=o>=</span><span class=k>$(</span>SUPPORT<span class=k>)</span>/busy
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 直接编译</span>
</span></span><span class=line><span class=cl><span class=c1># make</span>
</span></span><span class=line><span class=cl><span class=c1># 交叉编译（示例）</span>
</span></span><span class=line><span class=cl>make <span class=nv>LD</span><span class=o>=</span>loongarch64-linux-gnu-ld <span class=nv>CC</span><span class=o>=</span>loongarch64-linux-gnu-gcc <span class=nv>CCC</span><span class=o>=</span>loongarch64-linux-gnu-g++
</span></span></code></pre></td></tr></table></div></div><h3 id=编译-ethercat>编译 ethercat<a hidden class=anchor aria-hidden=true href=#编译-ethercat>#</a></h3><p>这一步可以说是最麻烦，问题最多的。编译出什么问题都需要去找到相应的<code>Makefile</code>修改。</p><blockquote><p>由于该软件包已经长时间无人维护，建议使用我<a href=https://github.com/kira-96/epics-ethercat>修改过的版本</a>。</p></blockquote><p>首先需要安装所需的包<em>libxml2-dev</em>。但我们实际上并不需要用这个软件包，我们只需要它的头文件。</p><p><strong>软件依赖的动态库(.so)文件，我们则需要从开发板系统中拷贝出来，无法直接用编译电脑的动态库。</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>cd</span> ethercat-master/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建 3rd 目录，用于放置所需的头文件和动态库</span>
</span></span><span class=line><span class=cl>mkdir 3rd
</span></span><span class=line><span class=cl>mkdir 3rd/include
</span></span><span class=line><span class=cl>mkdir 3rd/lib
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 安装 libxml2-dev</span>
</span></span><span class=line><span class=cl>sudo apt install libxml2-dev
</span></span><span class=line><span class=cl><span class=c1># 从系统目录中复制出libxml2的头文件</span>
</span></span><span class=line><span class=cl><span class=c1># 因为还需要做一些修改，不能直接使用</span>
</span></span><span class=line><span class=cl>cp -r /usr/include/libxml2/ ./3rd/include/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 复制刚刚编译生成的 libethercat</span>
</span></span><span class=line><span class=cl>cp /path/to/__install_dir/lib/libethercat.so* ./3rd/lib/
</span></span><span class=line><span class=cl><span class=c1># 从开发板系统复制所需要的动态库</span>
</span></span><span class=line><span class=cl><span class=c1># libxml2 依赖 libz 和 liblzma</span>
</span></span><span class=line><span class=cl>scp root@192.168.1.10:/usr/lib/libxml2.so.2.9.12 ./3rd/lib/
</span></span><span class=line><span class=cl>scp root@192.168.1.10:/usr/lib/libz.so.1.2.11 ./3rd/lib/
</span></span><span class=line><span class=cl>scp root@192.168.1.10:/usr/lib/liblzma.so.5.2.5 ./3rd/lib/
</span></span><span class=line><span class=cl><span class=c1># 手动创建一下链接</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> 3rd/lib/
</span></span><span class=line><span class=cl>ln -s libxml2.so.2.9.12 libxml2.so.2
</span></span><span class=line><span class=cl>ln -s libxml2.so.2 libxml2.so
</span></span><span class=line><span class=cl>ln -s liblzma.so.5.2.5 liblzma.so.5
</span></span><span class=line><span class=cl>ln -s liblzma.so.5 liblzma.so
</span></span><span class=line><span class=cl>ln -s libz.so.1.2.11 libz.so.1
</span></span><span class=line><span class=cl>ln -s libz.so.1 libz.so
</span></span></code></pre></td></tr></table></div></div><p>然后需要修改一下<em>libxml2</em>的头文件，不然编译的时候会报错。</p><p>报错信息：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>In file included from ../../../libxml2/libxml/parser.h:812,
</span></span><span class=line><span class=cl>                 from ../../../libxml2/libxml/globals.h:18,
</span></span><span class=line><span class=cl>                 from ../../../libxml2/libxml/threads.h:35,
</span></span><span class=line><span class=cl>                 from ../../../libxml2/libxml/xmlmemory.h:218,
</span></span><span class=line><span class=cl>                 from ../../../libxml2/libxml/tree.h:1307,
</span></span><span class=line><span class=cl>                 from ../parser.c:10:
</span></span><span class=line><span class=cl>../../../libxml2/libxml/encoding.h:31:10: fatal error: unicode/ucnv.h: No such file or directory
</span></span><span class=line><span class=cl> <span class=c1>#include &lt;unicode/ucnv.h&gt;</span>
</span></span><span class=line><span class=cl>          ^~~~~~~~~~~~~~~~
</span></span><span class=line><span class=cl>compilation terminated.
</span></span></code></pre></td></tr></table></div></div><p>解决方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 修改 xmlversion.h</span>
</span></span><span class=line><span class=cl>vi 3rd/include/libxml2/libxml/xmlversion.h
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 找到下面行，禁用 LIBXML_ICU_ENABLED</span>
</span></span><span class=line><span class=cl><span class=c1>#define LIBXML_ICU_ENABLED</span>
</span></span><span class=line><span class=cl><span class=c1># 将 #if 1 改为 #if 0</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl>/**
</span></span><span class=line><span class=cl> * LIBXML_ICU_ENABLED:
</span></span><span class=line><span class=cl> *
</span></span><span class=line><span class=cl> * Whether icu support is available
</span></span><span class=line><span class=cl> */
</span></span><span class=line><span class=cl><span class=gd>- #if 0
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+ #if 1
</span></span></span><span class=line><span class=cl><span class=gi></span>#define LIBXML_ICU_ENABLED
</span></span><span class=line><span class=cl>#endif
</span></span></code></pre></td></tr></table></div></div><p>做好上面的准备工作，还需要修改源码中的路径配置，然后才能正常编译。<br>下面都是我踩坑留下的记录。</p><ol><li>修改 <em>configure/RELEASE</em></li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>cd</span> ethercat-master/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 首先修改 configure/RELEASE</span>
</span></span><span class=line><span class=cl>vi configure/RELEASE
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 需要修改的有4项</span>
</span></span><span class=line><span class=cl><span class=c1># 放置EPICS模块的路径（示例）</span>
</span></span><span class=line><span class=cl><span class=nv>SUPPORT</span><span class=o>=</span>/home/ubuntu/loongson/modules
</span></span><span class=line><span class=cl><span class=c1># ASYN模块路径</span>
</span></span><span class=line><span class=cl><span class=nv>ASYN</span><span class=o>=</span><span class=k>$(</span>SUPPORT<span class=k>)</span>/asyn
</span></span><span class=line><span class=cl><span class=c1># BUSY模块路径</span>
</span></span><span class=line><span class=cl><span class=nv>BUSY</span><span class=o>=</span><span class=k>$(</span>SUPPORT<span class=k>)</span>/busy
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 修改成和EPICS Base一样的架构</span>
</span></span><span class=line><span class=cl><span class=nv>EPICS_HOST_ARCH</span><span class=o>=</span>linux-la64
</span></span><span class=line><span class=cl><span class=c1># EPICS Base路径（示例）</span>
</span></span><span class=line><span class=cl><span class=nv>EPICS_BASE</span><span class=o>=</span>/home/ubuntu/loongson/base-7.0.8
</span></span></code></pre></td></tr></table></div></div><ol start=2><li>修改 <em>ethercatApp/scannerSrc/Makefile</em></li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>cd</span> ethercat-master/
</span></span><span class=line><span class=cl><span class=c1># 修改 ethercatApp/scannerSrc/Makefile</span>
</span></span><span class=line><span class=cl>vi ethercatApp/scannerSrc/Makefile
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 需要修改 EtherCAT Master 源码相关路径、</span>
</span></span><span class=line><span class=cl><span class=c1># libxml2头文件路径、动态库(.so)路径</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 修改 ETHERLAB 源码路径</span>
</span></span><span class=line><span class=cl><span class=nv>ETHERLAB</span><span class=o>=</span>/path/to/ethercat-stable-1.5
</span></span><span class=line><span class=cl><span class=nv>ETHERLABPREFIX</span><span class=o>=</span><span class=k>$(</span>ETHERLAB<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>USR_INCLUDES</span> <span class=o>+=</span> -I<span class=k>$(</span>ETHERLABPREFIX<span class=k>)</span>/include
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 修改动态库路径</span>
</span></span><span class=line><span class=cl><span class=nv>USR_LDFLAGS</span> <span class=o>+=</span> -L<span class=k>$(</span>TOP<span class=k>)</span>/3rd/lib -Wl,-rpath<span class=o>=</span><span class=k>$(</span>TOP<span class=k>)</span>/3rd/lib
</span></span><span class=line><span class=cl><span class=c1># 修改 libxml2 头文件路径</span>
</span></span><span class=line><span class=cl><span class=nv>USR_INCLUDES</span> <span class=o>+=</span> -I<span class=k>$(</span>TOP<span class=k>)</span>/3rd/include/libxml2
</span></span><span class=line><span class=cl><span class=nv>USR_SYS_LIBS</span> <span class=o>+=</span> ethercat xml2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 下面类似</span>
</span></span><span class=line><span class=cl><span class=nv>scanner_INCLUDES</span> <span class=o>+=</span> -I<span class=k>$(</span>ETHERLAB<span class=k>)</span>/lib
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>serialtool_INCLUDES</span> <span class=o>+=</span> -I<span class=k>$(</span>ETHERLAB<span class=k>)</span>/master
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>get-slave-revisions_INCLUDES +<span class=o>=</span> -I<span class=k>$(</span>ETHERLAB<span class=k>)</span>/master
</span></span></code></pre></td></tr></table></div></div><ol start=3><li>修改 <em>ethercatApp/src/Makefile</em>，与上面类似。</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>cd</span> ethercat-master/
</span></span><span class=line><span class=cl><span class=c1># 修改 ethercatApp/src/Makefile</span>
</span></span><span class=line><span class=cl>vi ethercatApp/src/Makefile
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 需要修改 EtherCAT Master 源码相关路径、</span>
</span></span><span class=line><span class=cl><span class=c1># libxml2头文件路径、动态库(.so)路径</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 修改 ETHERLAB 源码路径</span>
</span></span><span class=line><span class=cl><span class=nv>ETHERLAB</span><span class=o>=</span>/path/to/ethercat-stable-1.5
</span></span><span class=line><span class=cl><span class=c1># ecAsyn_INCLUDES += -I$(ETHERLAB)/src/ethercat-$(subst -,.,$(VERSION))/include</span>
</span></span><span class=line><span class=cl><span class=c1># gadc_INCLUDES += -I$(ETHERLAB)/src/ethercat-$(subst -,.,$(VERSION))/include</span>
</span></span><span class=line><span class=cl><span class=nv>ecAsyn_INCLUDES</span> <span class=o>+=</span> -I<span class=k>$(</span>ETHERLAB<span class=k>)</span>/include
</span></span><span class=line><span class=cl><span class=nv>gadc_INCLUDES</span> <span class=o>+=</span> -I<span class=k>$(</span>ETHERLAB<span class=k>)</span>/include
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 修改 libxml2 头文件路径</span>
</span></span><span class=line><span class=cl><span class=nv>USR_INCLUDES</span> <span class=o>+=</span> -I<span class=k>$(</span>TOP<span class=k>)</span>/3rd/include/libxml2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 添加动态库路径</span>
</span></span><span class=line><span class=cl><span class=nv>USR_LDFLAGS</span> <span class=o>+=</span> -L<span class=k>$(</span>TOP<span class=k>)</span>/3rd/lib -Wl,-rpath<span class=o>=</span><span class=k>$(</span>TOP<span class=k>)</span>/3rd/lib
</span></span><span class=line><span class=cl><span class=nv>USR_SYS_LIBS</span> <span class=o>+=</span> xml2
</span></span></code></pre></td></tr></table></div></div><ol start=4><li>修改源码</li></ol><p>由于<code>ethercat-master</code>的源码原本是为<code>x86_64</code>架构编写的，编译到<code>LoongArch</code>架构的设备上运行可能会出现一些奇怪的错误。</p><p>例如，在运行<code>slaveinfo</code>时会出现<code>Segmentation fault</code>错误，而这通常是<strong>空指针</strong>导致内存访问出错。</p><p>原因分析：</p><p><code>slaveinfo</code>在运行时会根据程序自己的路径寻找<code>slave-types.txt</code>文件，问题就出在这里。来看源码 <code>ethercatApp/scannerSrc/slave-list-path.c</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// ethercatApp/scannerSrc/slave-list-path.c
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>get_root_dir_index</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>program_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Search for the binary path
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>char</span> <span class=n>binary_dir</span><span class=p>[]</span> <span class=o>=</span> <span class=s>&#34;bin/linux-x86_64/&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Find the binary path in the program path and return the pointer
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>char</span> <span class=o>*</span><span class=n>found</span> <span class=o>=</span> <span class=nf>strstr</span><span class=p>(</span><span class=n>program_name</span><span class=p>,</span> <span class=n>binary_dir</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Handle the case where it is not found
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>found</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// Calculate the difference in the pointers to get the index
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>found</span> <span class=o>-</span> <span class=n>program_name</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这个<code>get_root_dir_index</code>函数是用于计算当前程序(<code>slaveinfo</code>)所在的<strong>根</strong>目录。这里向上查找的路径为<code>bin/linux-x86_64</code>，当然不能找到<code>LoongArch</code>的目录<code>bin/linux-la64</code>了。所以，此函数只在路径为<code>bin/linux-x86_64/slaveinfo</code>时才能正常运行，其它情况都返回<code>-1</code>。（第一次见到这样写的，真无语了……）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>//  ethercatApp/scannerSrc/slave-list-path.c
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=o>*</span><span class=nf>get_slave_list_filename</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>program_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>relative_path</span><span class=p>[]</span> <span class=o>=</span> <span class=s>&#34;etc/scripts/slave-types.txt&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=o>*</span><span class=n>slave_list_filename</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Get absolute path of application
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>char</span> <span class=o>*</span><span class=n>real_path</span> <span class=o>=</span> <span class=nf>calloc</span><span class=p>(</span><span class=n>PATH_MAX</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=kt>char</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nf>get_app_path</span><span class=p>(</span><span class=n>program_path</span><span class=p>,</span> <span class=n>real_path</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Get root directory
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>root_dir_index</span> <span class=o>=</span> <span class=nf>get_root_dir_index</span><span class=p>(</span><span class=n>real_path</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>root_dir_index</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>slave_list_filename</span> <span class=o>=</span> <span class=nf>calloc</span><span class=p>(</span><span class=n>root_dir_index</span> <span class=o>+</span> <span class=nf>strlen</span><span class=p>(</span><span class=n>relative_path</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=kt>char</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=nf>strncpy</span><span class=p>(</span><span class=n>slave_list_filename</span><span class=p>,</span> <span class=n>real_path</span><span class=p>,</span> <span class=n>root_dir_index</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Append relative path
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>strcat</span><span class=p>(</span><span class=n>slave_list_filename</span><span class=p>,</span> <span class=n>relative_path</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Check file
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>struct</span> <span class=n>stat</span> <span class=n>fstat</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>result</span> <span class=o>=</span> <span class=nf>stat</span><span class=p>(</span><span class=n>slave_list_filename</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>fstat</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Could not find slave list file at %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>slave_list_filename</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Cleanup
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>free</span><span class=p>(</span><span class=n>real_path</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>slave_list_filename</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>而在<code>get_slave_list_filename</code>函数中，只处理了<code>get_root_dir_index</code>正常返回的情况。当<code>get_root_dir_index</code>返回<code>-1</code>时，<code>slave_list_filename</code>始终为<code>NULL</code>，这就导致后续操作出错。</p><p>其实这个问题直接把程序放到<code>bin/linux-x86_64</code>目录下运行就可以了，不过既然找到了问题，索性就改一改。</p><p>现在已经知道了出错的地方，该如何修改呢？这里我本着尽量少改动源码的原则，在<code>get_root_dir_index</code>查找<strong>根</strong>目录出错时，直接使用当前目录。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl>char *get_slave_list_filename(const char *program_path)
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>    char relative_path[] = &#34;etc/scripts/slave-types.txt&#34;;
</span></span><span class=line><span class=cl>    char *slave_list_filename = NULL;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // Get absolute path of application
</span></span><span class=line><span class=cl>    char *real_path = calloc(PATH_MAX, sizeof(char));
</span></span><span class=line><span class=cl>    get_app_path(program_path, real_path);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // Get root directory
</span></span><span class=line><span class=cl>    int root_dir_index = get_root_dir_index(real_path);
</span></span><span class=line><span class=cl>    if (root_dir_index != -1)
</span></span><span class=line><span class=cl>    {
</span></span><span class=line><span class=cl>        slave_list_filename = calloc(root_dir_index + strlen(relative_path) + 1, sizeof(char));
</span></span><span class=line><span class=cl>        strncpy(slave_list_filename, real_path, root_dir_index);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl><span class=gi>+    else
</span></span></span><span class=line><span class=cl><span class=gi>+    {
</span></span></span><span class=line><span class=cl><span class=gi>+        slave_list_filename = calloc(PATH_MAX, sizeof(char));
</span></span></span><span class=line><span class=cl><span class=gi>+        if (NULL != getcwd(slave_list_filename, PATH_MAX))
</span></span></span><span class=line><span class=cl><span class=gi>+        {
</span></span></span><span class=line><span class=cl><span class=gi>+            strcat(slave_list_filename, &#34;/&#34;);
</span></span></span><span class=line><span class=cl><span class=gi>+        }
</span></span></span><span class=line><span class=cl><span class=gi>+    }
</span></span></span><span class=line><span class=cl><span class=gi></span>
</span></span><span class=line><span class=cl>    // Append relative path
</span></span><span class=line><span class=cl>    strcat(slave_list_filename, relative_path);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // Check file
</span></span><span class=line><span class=cl>    struct stat fstat;
</span></span><span class=line><span class=cl>    int result = stat(slave_list_filename, &amp;fstat);
</span></span><span class=line><span class=cl>    if (result)
</span></span><span class=line><span class=cl>    {
</span></span><span class=line><span class=cl>        printf(&#34;Could not find slave list file at %s\n&#34;, slave_list_filename);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // Cleanup
</span></span><span class=line><span class=cl>    free(real_path);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    return slave_list_filename;
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>目前只发现了这个问题，希望后面没有坑了。</p><ol start=5><li>编译</li></ol><p>最后终于可以开始编译了。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>cd</span> ethercat-master/
</span></span><span class=line><span class=cl><span class=c1># 执行交叉编译</span>
</span></span><span class=line><span class=cl>make <span class=nv>LD</span><span class=o>=</span>loongarch64-linux-gnu-ld <span class=nv>CC</span><span class=o>=</span>loongarch64-linux-gnu-gcc <span class=nv>CCC</span><span class=o>=</span>loongarch64-linux-gnu-g++
</span></span></code></pre></td></tr></table></div></div><p>到这里，编译过程还可能会出错，不过已经可以编译出我们所需要的东西了。<br>最终编译得到<code>scanner</code>、<code>slaveinfo</code>程序就可以了。</p><p>以下是我编译时的输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>Installing library ../../../lib/linux-la64/libscannerlib.a
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>Installing created executable ../../../bin/linux-la64/serialtool
</span></span><span class=line><span class=cl>Installing created executable ../../../bin/linux-la64/get-slave-revisions
</span></span><span class=line><span class=cl>Installing created executable ../../../bin/linux-la64/scanner
</span></span><span class=line><span class=cl>Installing created executable ../../../bin/linux-la64/slaveinfo
</span></span><span class=line><span class=cl>Installing created executable ../../../bin/linux-la64/parsertest
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>Installing shared library ../../../lib/linux-la64/libecAsyn.so
</span></span><span class=line><span class=cl>Installing library ../../../lib/linux-la64/libecAsyn.a
</span></span><span class=line><span class=cl>Installing created executable ../../../bin/linux-la64/parsertest
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>Installing template file ../../../db/EK1100.template
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>make -C ./protocol install
</span></span><span class=line><span class=cl>make<span class=o>[</span>2<span class=o>]</span>: 进入目录“/home/deepin/ethercat-master/ethercatApp/protocol”
</span></span><span class=line><span class=cl>make<span class=o>[</span>2<span class=o>]</span>: *** 没有规则可制作目标“install”。 停止。
</span></span><span class=line><span class=cl>make<span class=o>[</span>2<span class=o>]</span>: 离开目录“/home/deepin/ethercat-master/ethercatApp/protocol”
</span></span><span class=line><span class=cl>make<span class=o>[</span>1<span class=o>]</span>: *** <span class=o>[</span>/usr/local/epics/base-7.0.8/configure/RULES_DIRS:85：protocol.install<span class=o>]</span> 错误 <span class=m>2</span>
</span></span><span class=line><span class=cl>make<span class=o>[</span>1<span class=o>]</span>: 离开目录“/home/deepin/ethercat-master/ethercatApp”
</span></span><span class=line><span class=cl>make: *** <span class=o>[</span>/usr/local/epics/base-7.0.8/configure/RULES_DIRS:85：ethercatApp.install<span class=o>]</span> 错误 <span class=m>2</span>
</span></span></code></pre></td></tr></table></div></div><p>最后的错误，我直接忽略了，因为已经得到了需要的可执行程序。</p><p>整理一下编译生成的文件：</p><pre tabindex=0><code>ethercat-master
├─ bin
│   └─ linux-la64
├─ db
├─ dbd
└─ lib
    └─ linux-la64
</code></pre><h2 id=测试运行>测试运行<a hidden class=anchor aria-hidden=true href=#测试运行>#</a></h2><p>将整理好的文件下载到开发板后，我们测试运行一下。</p><p>测试安装 <strong>EtherCAT</strong> 主站驱动程序。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>root@LS-GD modules<span class=o>]</span><span class=c1># modinfo ec_generic.ko</span>
</span></span><span class=line><span class=cl>filename:       /root/__install/modules/ec_generic.ko
</span></span><span class=line><span class=cl>version:        1.5.2 unknown
</span></span><span class=line><span class=cl>license:        GPL
</span></span><span class=line><span class=cl>description:    EtherCAT master generic Ethernet device module
</span></span><span class=line><span class=cl>author:         Florian Pose &lt;fp@igh-essen.com&gt;
</span></span><span class=line><span class=cl>srcversion:     848BB80F1C588A2FDA42EDB
</span></span><span class=line><span class=cl>depends:        ec_master
</span></span><span class=line><span class=cl>name:           ec_generic
</span></span><span class=line><span class=cl>vermagic:       5.10.0-rt17.lsgd preempt_rt mod_unload modversions LOONGARCH 64BIT
</span></span><span class=line><span class=cl><span class=o>[</span>root@LS-GD modules<span class=o>]</span><span class=c1># insmod ec_master.ko</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@LS-GD modules<span class=o>]</span><span class=c1># insmod ec_generic.ko</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@LS-GD modules<span class=o>]</span><span class=c1># lsmod</span>
</span></span><span class=line><span class=cl>Module                  Size  Used by
</span></span><span class=line><span class=cl>ec_generic              <span class=m>6427</span>  <span class=m>0</span>
</span></span><span class=line><span class=cl>ec_master             <span class=m>464125</span>  <span class=m>1</span> ec_generic
</span></span></code></pre></td></tr></table></div></div><p>测试<code>ethercat</code>主程序。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>root@LS-GD tool<span class=o>]</span><span class=c1># ./ethercat</span>
</span></span><span class=line><span class=cl>Please specify a command!
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Usage: ethercat &lt;COMMAND&gt; <span class=o>[</span>OPTIONS<span class=o>]</span> <span class=o>[</span>ARGUMENTS<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Commands <span class=o>(</span>can be abbreviated<span class=o>)</span>:
</span></span><span class=line><span class=cl>  <span class=nb>alias</span>      Write <span class=nb>alias</span> addresses.
</span></span><span class=line><span class=cl>  config     Show slave configurations.
</span></span><span class=line><span class=cl>  crc        CRC error register diagnosis.
</span></span><span class=line><span class=cl>  cstruct    Generate slave PDO information in C language.
</span></span><span class=line><span class=cl>  data       Output binary domain process data.
</span></span><span class=line><span class=cl>  debug      Set the master<span class=s1>&#39;s debug level.
</span></span></span><span class=line><span class=cl><span class=s1>  domains    Show configured domains.
</span></span></span><span class=line><span class=cl><span class=s1>  download   Write an SDO entry to a slave.
</span></span></span><span class=line><span class=cl><span class=s1>  eoe        Display Ethernet over EtherCAT statictics.
</span></span></span><span class=line><span class=cl><span class=s1>  foe_read   Read a file from a slave via FoE.
</span></span></span><span class=line><span class=cl><span class=s1>  foe_write  Store a file on a slave via FoE.
</span></span></span><span class=line><span class=cl><span class=s1>  graph      Output the bus topology as a graph.
</span></span></span><span class=line><span class=cl><span class=s1>  master     Show master and Ethernet device information.
</span></span></span><span class=line><span class=cl><span class=s1>  pdos       List Sync managers, PDO assignment and mapping.
</span></span></span><span class=line><span class=cl><span class=s1>  reg_read   Output a slave&#39;</span>s register contents.
</span></span><span class=line><span class=cl>  reg_write  Write data to a slave<span class=s1>&#39;s registers.
</span></span></span><span class=line><span class=cl><span class=s1>  rescan     Rescan the bus.
</span></span></span><span class=line><span class=cl><span class=s1>  sdos       List SDO dictionaries.
</span></span></span><span class=line><span class=cl><span class=s1>  sii_read   Output a slave&#39;</span>s SII contents.
</span></span><span class=line><span class=cl>  sii_write  Write SII contents to a slave.
</span></span><span class=line><span class=cl>  slaves     Display slaves on the bus.
</span></span><span class=line><span class=cl>  soe_read   Read an SoE IDN from a slave.
</span></span><span class=line><span class=cl>  soe_write  Write an SoE IDN to a slave.
</span></span><span class=line><span class=cl>  states     Request application-layer states.
</span></span><span class=line><span class=cl>  upload     Read an SDO entry from a slave.
</span></span><span class=line><span class=cl>  version    Show version information.
</span></span><span class=line><span class=cl>  xml        Generate slave information XML.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Global options:
</span></span><span class=line><span class=cl>  --master  -m &lt;master&gt;  Comma separated list of masters
</span></span><span class=line><span class=cl>                         to <span class=k>select</span>, ranges are allowed.
</span></span><span class=line><span class=cl>                         Examples: <span class=s1>&#39;1,3&#39;</span>, <span class=s1>&#39;5-7,9&#39;</span>, <span class=s1>&#39;-3&#39;</span>.
</span></span><span class=line><span class=cl>                         Default: <span class=s1>&#39;-&#39;</span> <span class=o>(</span>all<span class=o>)</span>.
</span></span><span class=line><span class=cl>  --force   -f           Force a command.
</span></span><span class=line><span class=cl>  --quiet   -q           Output less information.
</span></span><span class=line><span class=cl>  --verbose -v           Output more information.
</span></span><span class=line><span class=cl>  --help    -h           Show this help.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Numerical values can be specified either with decimal <span class=o>(</span>no
</span></span><span class=line><span class=cl>prefix<span class=o>)</span>, octal <span class=o>(</span>prefix <span class=s1>&#39;0&#39;</span><span class=o>)</span> or hexadecimal <span class=o>(</span>prefix <span class=s1>&#39;0x&#39;</span><span class=o>)</span> base.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Call <span class=s1>&#39;ethercat &lt;COMMAND&gt; --help&#39;</span> <span class=k>for</span> command-specific help.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Send bug reports to fp@igh.de.
</span></span></code></pre></td></tr></table></div></div><p>测试<code>scanner</code>主程序。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>root@LS-GD linux-la64<span class=o>]</span><span class=c1># chmod +x scanner</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@LS-GD linux-la64<span class=o>]</span><span class=c1># ./scanner</span>
</span></span><span class=line><span class=cl>usage: scanner <span class=o>[</span>-m master_index<span class=o>]</span> <span class=o>[</span>-s<span class=o>]</span> <span class=o>[</span>-q<span class=o>]</span> scanner.xml socket_path
</span></span></code></pre></td></tr></table></div></div><p>可以看到，驱动程序和主程序都能在开发板上运行，说明已经编译完成了。</p><h2 id=安装-ethercat-主站到开发板系统>安装 EtherCAT 主站到开发板系统<a hidden class=anchor aria-hidden=true href=#安装-ethercat-主站到开发板系统>#</a></h2><p>首先将编译好的<code>EtherCAT Master</code>下载到开发板系统，然后将各个目录下的文件放到相应的系统目录下。（这里我还以<code>__install_dir</code>的目录结构为例。）</p><table><thead><tr><th style=text-align:left>原文件/目录</th><th style=text-align:left>系统文件/目录</th></tr></thead><tbody><tr><td style=text-align:left>bin/ethercat</td><td style=text-align:left>/usr/bin/ethercat</td></tr><tr><td style=text-align:left>etc/init.d/ethercat</td><td style=text-align:left>/etc/init.d/ethercat</td></tr><tr><td style=text-align:left>etc/sysconfig/ethercat</td><td style=text-align:left>/etc/sysconfig/ethercat</td></tr><tr><td style=text-align:left>etc/ethercat.conf</td><td style=text-align:left>/etc/ethercat.conf</td></tr><tr><td style=text-align:left>include/</td><td style=text-align:left>-</td></tr><tr><td style=text-align:left>lib/libethercat.so*</td><td style=text-align:left>/usr/lib/libethercat.so*</td></tr><tr><td style=text-align:left>modules/</td><td style=text-align:left>/lib/modules/5.10.0-rt17.lsgd/</td></tr><tr><td style=text-align:left>sbin/ethercatctl</td><td style=text-align:left>/sbin/ethercatctl</td></tr><tr><td style=text-align:left>share/bash-completion/</td><td style=text-align:left>usr/share/bash-completion/</td></tr></tbody></table><blockquote><p>注意：如果系统目录存在<code>/lib/modules/{内核版本}</code>目录，则可以将<code>modules</code>目录下的<code>ec_master.ko</code>和<code>ec_generic.ko</code>复制到该目录下，然后在终端执行<code>depmod</code>命令。否则，可以按照下面的步骤做相应修改。</p></blockquote><p>例如，将<code>modules</code>下的驱动文件放到开发板文件系统的<code>/root/modules/</code>目录下。</p><p>修改<code>/etc/init.d/ethercat</code>和<code>/sbin/ethercatctl</code>脚本文件。</p><p>例：<code>/etc/init.d/ethercat</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl>LSMOD=/sbin/lsmod
</span></span><span class=line><span class=cl>MODPROBE=/sbin/modprobe
</span></span><span class=line><span class=cl><span class=gi>+ INSMOD=/sbin/insmod
</span></span></span><span class=line><span class=cl><span class=gi></span>RMMOD=/sbin/rmmod
</span></span><span class=line><span class=cl>MODINFO=/sbin/modinfo
</span></span><span class=line><span class=cl><span class=gd>- ETHERCAT=/home/loongson/__install_dir/bin/ethercat
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+ ETHERCAT=/usr/bin/ethercat
</span></span></span><span class=line><span class=cl><span class=gi></span>MASTER_ARGS=
</span></span><span class=line><span class=cl><span class=gi>+ MODULE_DIR=/root/modules
</span></span></span><span class=line><span class=cl><span class=gi></span>
</span></span><span class=line><span class=cl>start)
</span></span><span class=line><span class=cl>    echo -n &#34;Starting EtherCAT master 1.5.2 &#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># load master module
</span></span><span class=line><span class=cl><span class=gd>- if ! ${MODPROBE} ${MODPROBE_FLAGS} ec_master &#34;${MASTER_ARGS}&#34; \
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+ if ! ${INSMOD} ${MODULE_DIR}/ec_master.ko &#34;${MASTER_ARGS}&#34; \
</span></span></span><span class=line><span class=cl><span class=gi></span>        main_devices=&#34;${DEVICES}&#34; backup_devices=&#34;${BACKUPS}&#34;; then
</span></span><span class=line><span class=cl>    exit_fail
</span></span><span class=line><span class=cl>fi
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># check for modules to replace
</span></span><span class=line><span class=cl>for MODULE in ${DEVICE_MODULES}; do
</span></span><span class=line><span class=cl>    ECMODULE=ec_${MODULE}
</span></span><span class=line><span class=cl><span class=gd>-    if ! ${MODINFO} &#34;${ECMODULE}&#34; &gt; /dev/null; then
</span></span></span><span class=line><span class=cl><span class=gd>-        continue # ec_* module not found
</span></span></span><span class=line><span class=cl><span class=gd>-    fi
</span></span></span><span class=line><span class=cl><span class=gd></span>    if [ &#34;${MODULE}&#34; != &#34;generic&#34; ]; then
</span></span><span class=line><span class=cl>        if ${LSMOD} | grep &#34;^${MODULE} &#34; &gt; /dev/null; then
</span></span><span class=line><span class=cl>            if ! ${RMMOD} &#34;${MODULE}&#34;; then
</span></span><span class=line><span class=cl>                exit_fail
</span></span><span class=line><span class=cl>            fi
</span></span><span class=line><span class=cl>        fi
</span></span><span class=line><span class=cl>    fi
</span></span><span class=line><span class=cl><span class=gd>-    if ! ${MODPROBE} ${MODPROBE_FLAGS} &#34;${ECMODULE}&#34;; then
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+    if ! ${INSMOD} &#34;${MODULE_DIR}/${ECMODULE}.ko&#34;; then
</span></span></span><span class=line><span class=cl><span class=gi></span>        if [ &#34;${MODULE}&#34; != &#34;generic&#34; ]; then
</span></span><span class=line><span class=cl>            ${MODPROBE} ${MODPROBE_FLAGS} &#34;${MODULE}&#34; # try to restore
</span></span><span class=line><span class=cl>        fi
</span></span><span class=line><span class=cl>        exit_fail
</span></span><span class=line><span class=cl>    fi
</span></span><span class=line><span class=cl>done
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>exit_success
</span></span><span class=line><span class=cl>;;
</span></span></code></pre></td></tr></table></div></div><p>例：<code>/sbin/ethercatctl</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl>LSMOD=/sbin/lsmod
</span></span><span class=line><span class=cl>MODPROBE=/sbin/modprobe
</span></span><span class=line><span class=cl><span class=gi>+ INSMOD=/sbin/insmod
</span></span></span><span class=line><span class=cl><span class=gi></span>RMMOD=/sbin/rmmod
</span></span><span class=line><span class=cl>MODINFO=/sbin/modinfo
</span></span><span class=line><span class=cl>IP=/bin/ip
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=gd>- ETHERCAT=/home/loongson/__install_dir/bin/ethercat
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+ ETHERCAT=/usr/bin/ethercat
</span></span></span><span class=line><span class=cl><span class=gi>+ MODULE_DIR=/root/modules
</span></span></span><span class=line><span class=cl><span class=gi></span>
</span></span><span class=line><span class=cl>#------------------------------------------------------------------------------
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=gd>- ETHERCAT_CONFIG=/home/loongson/__install_dir/etc/ethercat.conf
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+ ETHERCAT_CONFIG=/etc/ethercat.conf
</span></span></span><span class=line><span class=cl><span class=gi></span>
</span></span><span class=line><span class=cl>start)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># load master module
</span></span><span class=line><span class=cl><span class=gd>- if ! ${MODPROBE} ${MODPROBE_FLAGS} ec_master \
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+ if ! ${INSMOD} ${MODULE_DIR}/ec_master.ko \
</span></span></span><span class=line><span class=cl><span class=gi></span>        main_devices=&#34;${DEVICES}&#34; backup_devices=&#34;${BACKUPS}&#34;; then
</span></span><span class=line><span class=cl>    exit 1
</span></span><span class=line><span class=cl>fi
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>LOADED_MODULES=ec_master
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># check for modules to replace
</span></span><span class=line><span class=cl>for MODULE in ${DEVICE_MODULES}; do
</span></span><span class=line><span class=cl>    ECMODULE=ec_${MODULE}
</span></span><span class=line><span class=cl><span class=gd>-    if ! ${MODINFO} &#34;${ECMODULE}&#34; &gt; /dev/null; then
</span></span></span><span class=line><span class=cl><span class=gd>-        continue # ec_* module not found
</span></span></span><span class=line><span class=cl><span class=gd>-    fi
</span></span></span><span class=line><span class=cl><span class=gd></span>
</span></span><span class=line><span class=cl>    if [ &#34;${MODULE}&#34; != &#34;generic&#34; ] &amp;&amp; [ &#34;${MODULE}&#34; != &#34;ccat&#34; ]; then
</span></span><span class=line><span class=cl>        # unload standard module and check if unloading was successful
</span></span><span class=line><span class=cl>        ${RMMOD} &#34;${MODULE}&#34; 2&gt; /dev/null || true
</span></span><span class=line><span class=cl>        if ${LSMOD} | grep &#34;^${MODULE} &#34; &gt; /dev/null; then
</span></span><span class=line><span class=cl>            # could not unload module
</span></span><span class=line><span class=cl>            ${RMMOD} ${LOADED_MODULES}
</span></span><span class=line><span class=cl>            exit 1
</span></span><span class=line><span class=cl>        fi
</span></span><span class=line><span class=cl>    fi
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=gd>-    if ! ${MODPROBE} ${MODPROBE_FLAGS} &#34;${ECMODULE}&#34;; then
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+    if ! ${INSMOD} &#34;${MODULE_DIR}/${ECMODULE}.ko&#34;; then
</span></span></span><span class=line><span class=cl><span class=gi></span>        if [ &#34;${MODULE}&#34; != &#34;generic&#34; ] &amp;&amp; [ &#34;${MODULE}&#34; != &#34;ccat&#34; ]; then
</span></span><span class=line><span class=cl>            ${MODPROBE} ${MODPROBE_FLAGS} &#34;${MODULE}&#34; # try to restore
</span></span><span class=line><span class=cl>        fi
</span></span><span class=line><span class=cl>        ${RMMOD} ${LOADED_MODULES}
</span></span><span class=line><span class=cl>        exit 1
</span></span><span class=line><span class=cl>    fi
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    LOADED_MODULES=&#34;${ECMODULE} ${LOADED_MODULES}&#34;
</span></span><span class=line><span class=cl>done
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>exit 0
</span></span><span class=line><span class=cl>;;
</span></span></code></pre></td></tr></table></div></div><p><strong>修改 EtherCAT Master 配置文件。</strong></p><p>例：<code>/etc/sysconfig/ethercat</code>和<code>/etc/ethercat.conf</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nv>MASTER0_DEVICE</span><span class=o>=</span><span class=s2>&#34;00:11:22:33:44:55&#34;</span>
</span></span><span class=line><span class=cl><span class=c1>#MASTER1_DEVICE=&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#MASTER0_BACKUP=&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>DEVICE_MODULES</span><span class=o>=</span><span class=s2>&#34;generic&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p><code>MASTER&lt;X>_DEVICE</code>配置网卡的物理地址（MAC），可通过<code>ifconfig</code>命令查看。<br><code>DEVICE_MODULES</code>配置使用的模块名称，这里仅使用通用网卡驱动<code>generic</code>。</p><h2 id=运行-ethercat-master>运行 EtherCAT Master<a hidden class=anchor aria-hidden=true href=#运行-ethercat-master>#</a></h2><ul><li><p>启动<code>EtherCAT</code>主站程序。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>/etc/init.d/ethercat start
</span></span><span class=line><span class=cl><span class=c1># 或者</span>
</span></span><span class=line><span class=cl>/sbin/ethercatctl start
</span></span></code></pre></td></tr></table></div></div><p>如果一切正常，可以看到<code>/dev</code>目录下有<code>EtherCAT0</code>设备文件。</p></li><li><p>查看主站信息</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>root@LS-GD ~<span class=o>]</span><span class=c1># ethercat master</span>
</span></span><span class=line><span class=cl>Master0
</span></span><span class=line><span class=cl>Phase: Idle
</span></span><span class=line><span class=cl>Active: no
</span></span><span class=line><span class=cl>Slaves: <span class=m>1</span>
</span></span><span class=line><span class=cl>Ethernet devices:
</span></span><span class=line><span class=cl>  Main: 00:11:22:33:44:55 <span class=o>(</span>attached<span class=o>)</span>
</span></span><span class=line><span class=cl>    Link: UP
</span></span><span class=line><span class=cl>    Tx frames:   <span class=m>370862</span>
</span></span><span class=line><span class=cl>    Tx bytes:    <span class=m>22319896</span>
</span></span><span class=line><span class=cl>    Rx frames:   <span class=m>370861</span>
</span></span><span class=line><span class=cl>    Rx bytes:    <span class=m>22319836</span>
</span></span><span class=line><span class=cl>    Tx errors:   <span class=m>0</span>
</span></span><span class=line><span class=cl>    Tx frame rate <span class=o>[</span>1/s<span class=o>]</span>:    <span class=m>125</span>    <span class=m>125</span>    <span class=m>125</span>
</span></span><span class=line><span class=cl>    Tx rate <span class=o>[</span>KByte/s<span class=o>]</span>:      7.3    7.3    7.3
</span></span><span class=line><span class=cl>    Rx frame rate <span class=o>[</span>1/s<span class=o>]</span>:    <span class=m>125</span>    <span class=m>125</span>    <span class=m>125</span>
</span></span><span class=line><span class=cl>    Rx rate <span class=o>[</span>KByte/s<span class=o>]</span>:      7.3    7.3    7.3
</span></span><span class=line><span class=cl>  Common:
</span></span><span class=line><span class=cl>    Tx frames:   <span class=m>1108336</span>
</span></span><span class=line><span class=cl>    Tx bytes:    <span class=m>66704720</span>
</span></span><span class=line><span class=cl>    Rx frames:   <span class=m>1108307</span>
</span></span><span class=line><span class=cl>    Rx bytes:    <span class=m>66702980</span>
</span></span><span class=line><span class=cl>    Lost frames: <span class=m>29</span>
</span></span><span class=line><span class=cl>    Tx frame rate <span class=o>[</span>1/s<span class=o>]</span>:    <span class=m>125</span>    <span class=m>125</span>    <span class=m>125</span>
</span></span><span class=line><span class=cl>    Tx rate <span class=o>[</span>KByte/s<span class=o>]</span>:      7.3    7.3    7.3
</span></span><span class=line><span class=cl>    Rx frame rate <span class=o>[</span>1/s<span class=o>]</span>:    <span class=m>125</span>    <span class=m>125</span>    <span class=m>125</span>
</span></span><span class=line><span class=cl>    Rx rate <span class=o>[</span>KByte/s<span class=o>]</span>:      7.3    7.3    7.3
</span></span><span class=line><span class=cl>    Loss rate <span class=o>[</span>1/s<span class=o>]</span>:          <span class=m>0</span>      <span class=m>0</span>      <span class=m>0</span>
</span></span><span class=line><span class=cl>    Frame loss <span class=o>[</span>%<span class=o>]</span>:         0.0    0.0    0.0
</span></span><span class=line><span class=cl>Distributed clocks:
</span></span><span class=line><span class=cl>  Reference clock:   Slave <span class=m>0</span>
</span></span><span class=line><span class=cl>  DC reference time: <span class=m>0</span>
</span></span><span class=line><span class=cl>  Application time:  <span class=m>0</span>
</span></span><span class=line><span class=cl>                     2000-01-01 00:00:00.000000000
</span></span></code></pre></td></tr></table></div></div></li><li><p>查看从站设备</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>root@LS-GD ~<span class=o>]</span><span class=c1># ethercat slaves</span>
</span></span><span class=line><span class=cl><span class=m>0</span>  0:0  PREOP  +  XB6-EC0002<span class=o>(</span>Modules/Slots and MDP<span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>生成从站信息XML文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>root@LS-GD ~<span class=o>]</span><span class=c1># ethercat xml &gt; scanner.xml</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>其他<code>ethercat</code>命令</p><p>使用<code>ethercat -h</code>命令查看其他命令的使用方法。</p></li></ul><h2 id=参考>参考<a hidden class=anchor aria-hidden=true href=#参考>#</a></h2><ul><li><a href=https://docs.etherlab.org/ethercat/1.5/doxygen/index.html>IgH EtherCAT Master</a></li><li><a href=https://gitlab.com/etherlab.org/ethercat/-/blob/master/INSTALL.md>Building and installing IgH EtherCAT Master</a></li><li><a href=https://github.com/landaurobotics/igh-ethercat-master/blob/main/README.md>IgH EtherCAT Master for Linux</a></li><li><a href=https://accelconf.web.cern.ch/pcapac2018/papers/wep01.pdf>EtherCAT DRIVER AND TOOLS FOR EPICS AND LINUX AT PSI</a></li><li><a href=https://accelconf.web.cern.ch/cyclotrons2019/papers/tup004.pdf>INTEGRATION OF EtherCAT HARDWARE INTO THE EPICS BASED DISTRIBUTED CONTROL SYSTEM AT iThemba LABS</a></li><li><a href=https://blog.csdn.net/honeymelon3/article/details/113175863>在“福珑2.0”主机上编译EPICS Ehtercat驱动软件的体验</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://kira-96.github.io/tags/linux/>Linux</a></li><li><a href=https://kira-96.github.io/tags/epics/>EPICS</a></li><li><a href=https://kira-96.github.io/tags/%E9%BE%99%E8%8A%AF/>龙芯</a></li></ul><nav class=paginav><a class=prev href=https://kira-96.github.io/posts/epics-ioc-access-security/><span class=title>« 上一页</span><br><span>EPICS IOC 访问安全</span>
</a><a class=next href=https://kira-96.github.io/posts/build-epics-module-modbus/><span class=title>下一页 »</span><br><span>EPICS的MODBUS模块的编译和使用</span></a></nav></footer><script src=https://utteranc.es/client.js repo=kira-96/kira-96.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></article></main><footer class=footer><span>Copyright © 2019-2024 <a href=/>kira&rsquo;s blog</a> ·</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>